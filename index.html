<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iDiet Pro</title>

    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="MyWebSite" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* iOS Á≥ªÁªüÂ≠ó‰ΩìÊ†à */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", sans-serif;
            /* Èò≤Ê≠¢iOSÁÇπÂáªÈ´ò‰∫Æ */
            -webkit-tap-highlight-color: transparent;
        }
        /* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÁïôÊªöÂä®ÂäüËÉΩ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Â∫ïÈÉ®ÂÆâÂÖ®Âå∫ÂüüÈÄÇÈÖç */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        /* È°µÈù¢ÂàáÊç¢Âä®Áîª */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden flex flex-col">

    <div class="h-12 w-full bg-transparent shrink-0"></div>

    <main id="main-container" class="flex-1 overflow-y-auto no-scrollbar px-6 pb-32 relative">
        
        <section id="view-home" class="view-section fade-in">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ÂÅ•Â∫∑Ê¶ÇËßà</h1>
                    <p class="text-sm text-gray-500" id="current-date">Âä†ËΩΩ‰∏≠...</p>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center text-white shadow-lg shadow-emerald-200">
                    <i class="fas fa-heartbeat text-lg"></i>
                </div>
            </header>

            <!-- ÊúÄÊñ∞‰ΩìÈáçÂç°Áâá -->
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-3xl p-6 shadow-lg shadow-emerald-200/50 mb-5">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                            <i class="fas fa-weight text-white text-sm"></i>
                        </div>
                        <span class="text-emerald-100 font-medium text-sm">ÊúÄÊñ∞‰ΩìÈáç</span>
                    </div>
                    <span class="bg-white/20 text-white text-xs px-2.5 py-1 rounded-full backdrop-blur-sm" id="weight-trend-badge">-</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <span id="display-weight" class="text-5xl font-extrabold text-white">--</span>
                    <span class="text-xl text-emerald-100">kg</span>
                </div>
                <p class="text-xs text-emerald-100/80 mt-2" id="last-record-time">ÊöÇÊó†ËÆ∞ÂΩï</p>
            </div>

            <!-- BMI Âíå‰ΩìÈáçÂèòÂåñ -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="bg-gradient-to-br from-blue-50 to-white rounded-3xl p-5 shadow-sm border border-blue-100">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-7 h-7 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-chart-pie text-blue-600 text-xs"></i>
                        </div>
                        <p class="text-blue-700 text-sm font-medium">BMI ÊåáÊï∞</p>
                    </div>
                    <h3 id="display-bmi" class="text-3xl font-bold text-gray-900">--</h3>
                    <p id="bmi-status" class="text-xs mt-1 text-blue-600">Êú™Áü•</p>
                    <p id="bmi-next" class="text-[11px] text-gray-500 mt-1"></p>
                    <div class="mt-3">
                        <div class="relative h-2.5">
                            <div class="absolute inset-0 rounded-full overflow-hidden grid grid-cols-4">
                                <div class="bg-sky-300"></div>
                                <div class="bg-emerald-300"></div>
                                <div class="bg-amber-300"></div>
                                <div class="bg-rose-300"></div>
                            </div>
                            <div id="bmi-progress-indicator" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-white border-2 border-blue-600 shadow-md transition-all duration-300" style="left: 0%;"></div>
                        </div>
                        <div class="grid grid-cols-4 text-[10px] text-gray-500 mt-2 leading-4 text-center gap-1">
                            <span class="whitespace-nowrap">ÂÅèÁò¶</span>
                            <span class="whitespace-nowrap">Ê≠£Â∏∏</span>
                            <span class="whitespace-nowrap">ËøáÈáç</span>
                            <span class="whitespace-nowrap">ËÇ•ËÉñ</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-white rounded-3xl p-5 shadow-sm border border-purple-100 flex flex-col">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-7 h-7 rounded-lg bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-purple-600 text-xs"></i>
                        </div>
                        <p class="text-purple-700 text-sm font-medium">‰ΩìÈáçÂèòÂåñ</p>
                    </div>
                    <h3 id="weight-change" class="text-2xl font-bold text-gray-900">--</h3>
                    <p id="weight-change-desc" class="text-xs text-gray-400 mt-1">Á≠âÂæÖÊñ∞ËÆ∞ÂΩï</p>
                    <p id="weight-change-extra" class="text-xs text-gray-400 mt-auto">--</p>
                </div>
            </div>

            <!-- ËÆ∞ÂΩï‰ΩìÈáçÂç°Áâá -->
            <div class="bg-gradient-to-br from-amber-50 to-white rounded-3xl p-5 shadow-sm mb-5 border border-amber-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-xl bg-amber-100 flex items-center justify-center">
                            <i class="fas fa-pen text-amber-600 text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900">ËÆ∞ÂΩï‰ΩìÈáç</h3>
                    </div>
                    <div class="flex bg-gray-100 rounded-xl p-1 shrink-0">
                        <button onclick="setUnit('kg')" id="btn-unit-kg" class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all bg-white shadow text-amber-600">KG</button>
                        <button onclick="setUnit('jin')" id="btn-unit-jin" class="px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-500 transition-all">Êñ§</button>
                    </div>
                </div>

                <div class="flex bg-amber-100/50 rounded-xl p-1 mb-4">
                    <button onclick="setWeightPeriod('morning')" id="btn-period-morning" class="flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600">üåÖ Êó©Êô®Á©∫ËÖπ</button>
                    <button onclick="setWeightPeriod('night')" id="btn-period-night" class="flex-1 px-3 py-2 rounded-lg text-sm font-medium text-gray-500 transition-all">üåô ÊôöÈó¥Áù°Ââç</button>
                </div>

                <div class="flex items-center bg-white rounded-2xl border-2 border-amber-200 px-4 py-3 mb-4">
                    <input type="number" id="input-weight" step="0.01" placeholder="0.00" class="w-full text-4xl font-bold bg-transparent outline-none text-gray-900">
                    <span class="text-xl text-gray-400 ml-2">kg</span>
                </div>

                <button onclick="saveWeight()" id="btn-save-weight" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-amber-200 active:scale-95 transition-transform flex justify-center items-center gap-2 hover:shadow-xl">
                    <i class="fas fa-check"></i>
                    <span>‰øùÂ≠òËÆ∞ÂΩï</span>
                </button>
            </div>

            <!-- ÊúÄËøëËÆ∞ÂΩï -->
            <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-3xl p-5 shadow-sm border border-indigo-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center shadow-sm">
                            <i class="fas fa-clock-rotate-left text-white text-sm"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">ÊúÄËøëËÆ∞ÂΩï</h3>
                            <p class="text-[10px] text-gray-500">Ëøë7Â§©Êï∞ÊçÆ</p>
                        </div>
                    </div>
                    <button onclick="switchView('trend')" class="text-xs text-indigo-500 hover:text-indigo-700 flex items-center gap-1 transition-all">
                        Êü•ÁúãÊõ¥Â§ö <i class="fas fa-chevron-right text-[10px]"></i>
                    </button>
                </div>
                <ul id="recent-list" class="space-y-3">
                    <li class="text-center text-gray-400 py-4">Ê≠£Âú®‰ªé‰∫ëÁ´ØÂä†ËΩΩ...</li>
                </ul>
            </div>
        </section>

        <section id="view-record" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold mb-6">ÊØèÊó•Â§áÊ≥®</h2>

            <!-- ÂçàÈ§êÂç°Áâá -->
            <div class="bg-gradient-to-br from-emerald-50 to-white rounded-3xl p-5 shadow-sm mb-4 border border-emerald-100">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center">
                        <i class="fas fa-sun text-emerald-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">ÂçàÈ§ê</h3>
                    <span id="status-lunch" class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 ml-auto">Êú™Â°´</span>
                </div>
                <div class="flex gap-2 items-center">
                    <textarea id="input-lunch-note" rows="2" placeholder="‰ªäÂ§©ÂçàÈ§êÂêÉ‰∫Ü‰ªÄ‰πàÔºü" class="flex-1 rounded-2xl border border-emerald-200 bg-white text-gray-900 placeholder-gray-400 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30"></textarea>
                    <button type="button" onclick="saveMealNote('lunch')" class="shrink-0 px-4 py-3 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 active:scale-95 transition-all">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <!-- ÊôöÈ§êÂç°Áâá -->
            <div class="bg-gradient-to-br from-amber-50 to-white rounded-3xl p-5 shadow-sm mb-4 border border-amber-100">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center">
                        <i class="fas fa-moon text-amber-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">ÊôöÈ§ê</h3>
                    <span id="status-dinner" class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 ml-auto">Êú™Â°´</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-3" id="dinner-presets">
                    <button type="button" onclick="selectDinnerPreset(0)" class="dinner-preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-white text-amber-700 border border-amber-200 hover:bg-amber-100 active:scale-95 transition-all">Ë±ÜÊµÜ+È∏°ËÉ∏ËÇâ</button>
                    <button type="button" onclick="selectDinnerPreset(1)" class="dinner-preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-white text-amber-700 border border-amber-200 hover:bg-amber-100 active:scale-95 transition-all">Ë±ÜÊµÜ+È∏°ËÉ∏ËÇâ+ÂÖ®È∫¶ËÑÜ</button>
                </div>
                <div class="flex gap-2 items-center">
                    <textarea id="input-dinner-note" rows="2" placeholder="ÁÇπÂáªÊñπÊ°àÂø´ÈÄüÂ°´ÂÖÖÔºåÊàñÊâãÂä®ËæìÂÖ•" class="flex-1 rounded-2xl border border-amber-200 bg-white text-gray-900 placeholder-gray-400 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/30"></textarea>
                    <button type="button" onclick="saveMealNote('dinner')" class="shrink-0 px-4 py-3 rounded-xl bg-amber-500 text-white text-sm font-semibold hover:bg-amber-600 active:scale-95 transition-all">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <!-- ÈîªÁÇºÂç°Áâá -->
            <div class="bg-white rounded-3xl p-5 shadow-sm mb-4 border border-gray-100">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-dumbbell text-blue-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">‰ªäÊó•ÈîªÁÇº</h3>
                    <span id="status-workout" class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 ml-auto">Êú™Â°´</span>
                </div>
                
                <!-- ‰∏äÂçà‰∏≠È•≠Ââç - ËìùËâ≤ -->
                <div class="bg-gradient-to-r from-blue-50 to-blue-100/50 rounded-2xl p-4 mb-3">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-semibold text-blue-700">üåÖ ‰∏äÂçà‰∏≠È•≠ÂâçÁ©∫ËÖπ</span>
                    </div>
                    <div class="flex flex-wrap gap-1.5" id="workout-presets-morning">
                        <button type="button" onclick="selectWorkoutPreset('morning', 0)" class="workout-preset-btn-morning px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-blue-700 border border-blue-200 hover:bg-blue-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥900</button>
                        <button type="button" onclick="selectWorkoutPreset('morning', 1)" class="workout-preset-btn-morning px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-blue-700 border border-blue-200 hover:bg-blue-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥1800</button>
                        <button type="button" onclick="selectWorkoutPreset('morning', 2)" class="workout-preset-btn-morning px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-blue-700 border border-blue-200 hover:bg-blue-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥3000</button>
                        <button type="button" onclick="selectWorkoutPreset('morning', 3)" class="workout-preset-btn-morning px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-blue-700 border border-blue-200 hover:bg-blue-50 active:scale-95 transition-all shadow-sm">Êó†Ê∞ß30ÂàÜÈíü</button>
                        <button type="button" onclick="selectWorkoutPreset('morning', -1)" class="workout-preset-btn-morning px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-500 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all shadow-sm">Êú™ÈîªÁÇº</button>
                    </div>
                </div>

                <!-- ‰∏ãÂçàÊôöÈ•≠Ââç - Ê©ôËâ≤ -->
                <div class="bg-gradient-to-r from-orange-50 to-orange-100/50 rounded-2xl p-4 mb-3">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-semibold text-orange-700">üåá ‰∏ãÂçàÊôöÈ•≠ÂâçÁ©∫ËÖπ</span>
                    </div>
                    <div class="flex flex-wrap gap-1.5" id="workout-presets-evening">
                        <button type="button" onclick="selectWorkoutPreset('evening', 0)" class="workout-preset-btn-evening px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-orange-700 border border-orange-200 hover:bg-orange-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥900</button>
                        <button type="button" onclick="selectWorkoutPreset('evening', 1)" class="workout-preset-btn-evening px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-orange-700 border border-orange-200 hover:bg-orange-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥1800</button>
                        <button type="button" onclick="selectWorkoutPreset('evening', 2)" class="workout-preset-btn-evening px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-orange-700 border border-orange-200 hover:bg-orange-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥3000</button>
                        <button type="button" onclick="selectWorkoutPreset('evening', 3)" class="workout-preset-btn-evening px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-orange-700 border border-orange-200 hover:bg-orange-50 active:scale-95 transition-all shadow-sm">Êó†Ê∞ß30ÂàÜÈíü</button>
                        <button type="button" onclick="selectWorkoutPreset('evening', -1)" class="workout-preset-btn-evening px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-500 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all shadow-sm">Êú™ÈîªÁÇº</button>
                    </div>
                </div>

                <!-- ‰∏ãÂçàÊôöÈ•≠Âêé - Á¥´Ëâ≤ -->
                <div class="bg-gradient-to-r from-purple-50 to-purple-100/50 rounded-2xl p-4 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-semibold text-purple-700">üåô ‰∏ãÂçàÊôöÈ•≠Âêé</span>
                    </div>
                    <div class="flex flex-wrap gap-1.5" id="workout-presets-night">
                        <button type="button" onclick="selectWorkoutPreset('night', 0)" class="workout-preset-btn-night px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-purple-700 border border-purple-200 hover:bg-purple-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥900</button>
                        <button type="button" onclick="selectWorkoutPreset('night', 1)" class="workout-preset-btn-night px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-purple-700 border border-purple-200 hover:bg-purple-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥1800</button>
                        <button type="button" onclick="selectWorkoutPreset('night', 2)" class="workout-preset-btn-night px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-purple-700 border border-purple-200 hover:bg-purple-50 active:scale-95 transition-all shadow-sm">Ë∑≥Áª≥3000</button>
                        <button type="button" onclick="selectWorkoutPreset('night', 3)" class="workout-preset-btn-night px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-purple-700 border border-purple-200 hover:bg-purple-50 active:scale-95 transition-all shadow-sm">Êó†Ê∞ß30ÂàÜÈíü</button>
                        <button type="button" onclick="selectWorkoutPreset('night', -1)" class="workout-preset-btn-night px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-500 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all shadow-sm">Êú™ÈîªÁÇº</button>
                    </div>
                </div>

                <div class="flex gap-2 items-center">
                    <textarea id="input-workout-note" rows="2" placeholder="ÁÇπÂáª‰∏äÊñπÂêÑÊó∂ÊÆµÊñπÊ°àËá™Âä®ÁîüÊàêÔºåÊàñÊâãÂä®ËæìÂÖ•" class="flex-1 rounded-2xl border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/30"></textarea>
                    <button type="button" onclick="saveMealNote('workout')" class="shrink-0 px-4 py-3 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 active:scale-95 transition-all">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="view-trend" class="view-section hidden fade-in">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Ë∂ãÂäøÂàÜÊûê</h1>
                    <p class="text-sm text-gray-500">ËøΩË∏™‰Ω†ÁöÑÂÅ•Â∫∑Êï∞ÊçÆ</p>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-400 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i class="fas fa-chart-line text-lg"></i>
                </div>
            </header>

            <!-- Ê®°ÂºèÂàáÊç¢ -->
            <div class="bg-white rounded-2xl p-2 shadow-sm border border-gray-100 mb-4">
                <div class="flex gap-2">
                    <button id="btn-trend-weight" onclick="setTrendMode('weight')" class="trend-mode-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-semibold bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-sm transition-all">
                        <i class="fas fa-weight mr-1.5"></i>‰ΩìÈáçË∂ãÂäø
                    </button>
                    <button id="btn-trend-metabolic" onclick="setTrendMode('metabolic')" class="trend-mode-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-600 hover:bg-gray-50 transition-all">
                        <i class="fas fa-fire mr-1.5"></i>‰ª£Ë∞¢Êõ≤Á∫ø
                    </button>
                </div>
            </div>

            <!-- Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄâ -->
            <div class="flex flex-wrap gap-2 mb-5">
                <button data-range="7" onclick="filterChart(7)" class="filter-btn px-4 py-2 bg-white text-gray-600 rounded-xl text-sm font-medium border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 transition-all">7Â§©</button>
                <button data-range="30" onclick="filterChart(30)" class="filter-btn active px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl text-sm font-medium shadow-sm">30Â§©</button>
                <button data-range="60" onclick="filterChart(60)" class="filter-btn px-4 py-2 bg-white text-gray-600 rounded-xl text-sm font-medium border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 transition-all">60Â§©</button>
                <button data-range="999" onclick="filterChart(999)" class="filter-btn px-4 py-2 bg-white text-gray-600 rounded-xl text-sm font-medium border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 transition-all">ÂÖ®ÈÉ®</button>
            </div>

            <!-- Êï∞ÊçÆÊ¶ÇËßàÂç°Áâá -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="bg-gradient-to-br from-indigo-50 to-white rounded-3xl p-5 shadow-sm border border-indigo-100">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-7 h-7 rounded-lg bg-indigo-100 flex items-center justify-center">
                            <i class="fas fa-weight text-indigo-600 text-xs"></i>
                        </div>
                        <p id="trend-card-label-1" class="text-indigo-700 text-sm font-medium">ÂΩìÂâç‰ΩìÈáç</p>
                    </div>
                    <h3 id="trend-current-weight" class="text-2xl font-bold text-gray-900">--</h3>
                    <p id="trend-current-time" class="text-xs text-gray-400 mt-1">--</p>
                </div>
                <div class="bg-gradient-to-br from-emerald-50 to-white rounded-3xl p-5 shadow-sm border border-emerald-100">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-lg bg-emerald-100 flex items-center justify-center">
                                <i class="fas fa-arrow-trend-down text-emerald-600 text-xs"></i>
                            </div>
                            <p id="trend-card-label-2" class="text-emerald-700 text-sm font-medium">Âå∫Èó¥ÂèòÂåñ</p>
                        </div>
                        <span class="bg-emerald-100 text-emerald-600 text-xs px-2 py-0.5 rounded-full" id="trend-change-badge">-</span>
                    </div>
                    <h3 id="trend-change" class="text-2xl font-bold text-gray-900">--</h3>
                </div>
            </div>

            <!-- ÂõæË°®Âç°Áâá -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-5">
                <div class="h-72 relative">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <!-- ÁªüËÆ°Âç°Áâá -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl p-4 border border-orange-100">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-6 h-6 rounded-lg bg-orange-100 flex items-center justify-center">
                            <i class="fas fa-arrow-up text-orange-500 text-xs"></i>
                        </div>
                        <p id="stat-max-label" class="text-orange-600 text-xs font-semibold">ÊúÄÈ´ò‰ΩìÈáç</p>
                    </div>
                    <p id="stat-max" class="text-xl font-bold text-gray-900">--</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-white rounded-2xl p-4 border border-green-100">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-6 h-6 rounded-lg bg-green-100 flex items-center justify-center">
                            <i class="fas fa-arrow-down text-green-500 text-xs"></i>
                        </div>
                        <p id="stat-min-label" class="text-green-600 text-xs font-semibold">ÊúÄ‰Ωé‰ΩìÈáç</p>
                    </div>
                    <p id="stat-min" class="text-xl font-bold text-gray-900">--</p>
                </div>
            </div>

            <!-- Êü•ÁúãÂéÜÂè≤ÊåâÈíÆ -->
            <button onclick="openWeightHistoryModal()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex justify-center items-center gap-2 hover:shadow-xl">
                <i class="fas fa-history"></i>
                <span>Êü•ÁúãÂÖ®ÈÉ®ÂéÜÂè≤</span>
            </button>
        </section>

        <section id="view-calc" class="view-section hidden fade-in">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">ÁÉ≠ÈáèÊç¢ÁÆó</h1>
                    <p class="text-sm text-gray-500">ËÆ°ÁÆóÈ£üÁâ©ÁÉ≠Èáè‰∏éËøêÂä®Ê∂àËÄó</p>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-rose-400 to-orange-500 flex items-center justify-center text-white shadow-lg shadow-rose-200">
                    <i class="fas fa-fire text-lg"></i>
                </div>
            </header>
            
            <!-- ÁÉ≠ÈáèËÆ°ÁÆóÂç°Áâá -->
            <div class="bg-gradient-to-br from-rose-50 to-white rounded-3xl p-5 shadow-sm mb-5 border border-rose-100">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-xl bg-rose-100 flex items-center justify-center">
                        <i class="fas fa-utensils text-rose-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">È£üÊùêÁÉ≠ÈáèËÆ°ÁÆó</h3>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">È£üÂìÅÂêçÁß∞</label>
                        <input id="food-name" type="text" placeholder="Â¶ÇÔºöÁáïÈ∫¶Â•∂" class="w-full rounded-xl border border-rose-200 bg-white text-gray-900 placeholder-gray-400 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-rose-500/30" />
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Êï∞Èáè (g/ml)</label>
                            <input id="food-amount" type="number" inputmode="decimal" placeholder="250" class="w-full rounded-xl border border-rose-200 bg-white text-gray-900 placeholder-gray-400 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-rose-500/30" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">ÁÉ≠Èáè (kJ/100g)</label>
                            <input id="food-unit-kcal" type="number" inputmode="decimal" placeholder="54" class="w-full rounded-xl border border-rose-200 bg-white text-gray-900 placeholder-gray-400 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-rose-500/30" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- ËÆ°ÁÆóÁªìÊûúÂç°Áâá -->
            <div class="bg-gradient-to-br from-orange-50 to-white rounded-3xl p-5 shadow-sm mb-5 border border-orange-100">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-xl bg-orange-100 flex items-center justify-center">
                        <i class="fas fa-fire-flame-curved text-orange-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">ËÆ°ÁÆóÁªìÊûú</h3>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-rose-500 rounded-2xl p-4 mb-4">
                    <p class="text-orange-100 text-xs mb-1">È¢Ñ‰º∞ÊÄªÁÉ≠Èáè</p>
                    <div class="flex items-baseline gap-1">
                        <span class="text-4xl font-bold text-white" id="food-total-kcal">0</span>
                        <span class="text-orange-100 text-sm">kJ</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white rounded-xl p-3 text-center border border-orange-100">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-running text-blue-600 text-sm"></i>
                        </div>
                        <p class="text-[11px] text-gray-500">Ë∑ëÊ≠•</p>
                        <p class="text-lg font-bold text-gray-900"><span id="calc-run">0</span><span class="text-xs text-gray-400">ÂàÜÈíü</span></p>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center border border-orange-100">
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-child text-green-600 text-sm"></i>
                        </div>
                        <p class="text-[11px] text-gray-500">Ë∑≥Áª≥</p>
                        <p class="text-lg font-bold text-gray-900"><span id="calc-rope">0</span><span class="text-xs text-gray-400">ÂàÜÈíü</span></p>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center border border-orange-100">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-dumbbell text-purple-600 text-sm"></i>
                        </div>
                        <p class="text-[11px] text-gray-500">ÂìëÈìÉ</p>
                        <p class="text-lg font-bold text-gray-900"><span id="calc-dumbbell">0</span><span class="text-xs text-gray-400">ÂàÜÈíü</span></p>
                    </div>
                </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="grid grid-cols-2 gap-3 mb-5">
                <button onclick="calcFoodOnly()" class="h-14 rounded-2xl bg-white text-rose-600 font-semibold shadow-sm border border-rose-200 active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-rose-50">
                    <i class="fas fa-calculator"></i> ËÆ°ÁÆó
                </button>
                <button onclick="calcFoodKcal()" class="h-14 rounded-2xl bg-gradient-to-r from-rose-500 to-orange-500 text-white font-semibold shadow-lg shadow-rose-200 active:scale-95 transition-transform flex items-center justify-center gap-2 hover:shadow-xl">
                    <i class="fas fa-plus"></i> ËÆ∞ÂΩï
                </button>
            </div>

            <!-- ÂéÜÂè≤Êü•ËØ¢ÂàóË°® -->
            <div class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-xl bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-history text-gray-600 text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900">ÂéÜÂè≤ËÆ∞ÂΩï</h3>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshCalcHistory()" class="text-gray-600 text-xs px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 transition-all">
                            <i class="fas fa-sync-alt mr-1"></i>Âà∑Êñ∞
                        </button>
                        <button onclick="clearCalcHistory()" class="text-rose-600 text-xs px-3 py-1.5 rounded-lg bg-rose-50 hover:bg-rose-100 transition-all">
                            <i class="fas fa-trash mr-1"></i>Ê∏ÖÁ©∫
                        </button>
                    </div>
                </div>
                <div id="calc-history" class="space-y-3 text-sm text-gray-700">
                    <div class="text-center text-gray-400 py-4">ÊöÇÊó†ÂéÜÂè≤</div>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-200 pb-safe z-50">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchView('home')" class="nav-btn text-emerald-600 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[10px] font-medium">È¶ñÈ°µ</span>
            </button>
            <button onclick="switchView('record')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="record">
                <i class="fas fa-pen text-xl"></i>
                <span class="text-[10px] font-medium">ËÆ∞ÂΩï</span>
            </button>
            <button onclick="switchView('trend')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="trend">
                <i class="fas fa-chart-line text-xl"></i>
                <span class="text-[10px] font-medium">Ë∂ãÂäø</span>
            </button>
            <button onclick="switchView('calc')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="calc">
                <i class="fas fa-calculator text-xl"></i>
                <span class="text-[10px] font-medium">ËÆ°ÁÆó</span>
            </button>
        </div>
    </nav>

    <div id="weight-history-modal" class="fixed inset-0 hidden z-[60]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeWeightHistoryModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-lg sm:rounded-3xl rounded-t-3xl shadow-xl max-h-[85vh] flex flex-col">
                <!-- Â§¥ÈÉ® -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-history"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">‰ΩìÈáçÂéÜÂè≤</h3>
                                <p class="text-xs text-gray-500">Êü•ÁúãÂÖ®ÈÉ®ËÆ∞ÂΩï</p>
                            </div>
                        </div>
                        <button class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition-all" onclick="closeWeightHistoryModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Êó∂ÊÆµÁ≠õÈÄâ -->
                    <div id="weight-history-tabs" class="flex gap-2 mb-3">
                        <button onclick="setWeightHistoryFilter('morning')" class="flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-sm transition-all">üåÖ Êó©Êô®</button>
                        <button onclick="setWeightHistoryFilter('night')" class="flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">üåô ÊôöÈó¥</button>
                        <button onclick="setWeightHistoryFilter('all')" class="flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">ÂÖ®ÈÉ®</button>
                    </div>
                    
                    <!-- Âø´Êç∑Â§çÂà∂ -->
                    <div class="bg-gray-50 rounded-2xl p-3 space-y-2">
                        <div class="flex flex-wrap gap-1.5">
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('7d')">7Â§©</button>
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('1m')">1Êúà</button>
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('2m')">2Êúà</button>
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('all')">ÂÖ®ÈÉ®</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="weight-history-copy-range" class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-700 border border-gray-200 focus:outline-none focus:border-indigo-300">
                                <option value="3m">Ëøë3‰∏™Êúà</option>
                                <option value="4m">Ëøë4‰∏™Êúà</option>
                                <option value="5m">Ëøë5‰∏™Êúà</option>
                                <option value="6m">ËøëÂçäÂπ¥</option>
                                <option value="1y">Ëøë‰∏ÄÂπ¥</option>
                                <option value="all">ÂÖ®ÈÉ®ÂéÜÂè≤</option>
                            </select>
                            <button class="px-4 py-2 rounded-xl text-xs font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-sm active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard(document.getElementById('weight-history-copy-range')?.value || 'all')">
                                <i class="fas fa-copy mr-1"></i>Â§çÂà∂
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all" onclick="downloadWeightHistoryCsv(document.getElementById('weight-history-copy-range')?.value || 'all')">
                                <i class="fas fa-file-csv mr-1 text-green-500"></i>CSV
                            </button>
                            <button class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all" onclick="downloadAllLogsJson()">
                                <i class="fas fa-file-code mr-1 text-blue-500"></i>JSON
                            </button>
                            <button class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all" onclick="openImportJson()">
                                <i class="fas fa-file-import mr-1 text-orange-500"></i>ÂØºÂÖ•
                            </button>
                        </div>
                        <input id="import-json-input" type="file" accept="application/json" class="hidden" onchange="importLogsFromJsonFile(event)" />
                    </div>
                </div>
                
                <!-- ÂàóË°® -->
                <div id="weight-history-list" class="px-5 py-4 overflow-y-auto flex-1"></div>
                
                <!-- Â∫ïÈÉ® -->
                <div class="px-5 py-4 border-t border-gray-100">
                    <button class="w-full bg-gradient-to-r from-gray-800 to-gray-900 text-white py-3.5 rounded-2xl font-semibold shadow-lg active:scale-95 transition-transform" onclick="closeWeightHistoryModal()">
                        ÂÖ≥Èó≠
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-weight-modal" class="fixed inset-0 hidden z-[65]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeEditWeightModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl shadow-xl max-h-[80vh] flex flex-col">
                <!-- Â§¥ÈÉ® -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">ÁºñËæë‰ΩìÈáç</h3>
                                <p class="text-xs text-gray-500">‰øÆÊîπËÆ∞ÂΩïËØ¶ÊÉÖ</p>
                            </div>
                        </div>
                        <button class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition-all" onclick="closeEditWeightModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- ÂÜÖÂÆπ -->
                <div class="px-5 py-5 space-y-4 overflow-y-auto">
                    <div class="bg-gradient-to-r from-gray-50 to-white rounded-2xl p-4 border border-gray-100">
                        <label class="text-xs text-gray-500 mb-2 block">ËÆ∞ÂΩïÊó∂Èó¥</label>
                        <input id="edit-weight-datetime" type="datetime-local" class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-500/30" />
                    </div>

                    <div class="bg-gradient-to-r from-emerald-50 to-white rounded-2xl p-4 border border-emerald-100">
                        <label class="text-xs text-gray-500 mb-2 block">‰ΩìÈáç (kg)</label>
                        <input id="edit-weight-value" type="number" step="0.01" class="w-full rounded-xl border border-emerald-200 bg-white px-4 py-3 text-2xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-emerald-500/30" placeholder="0.00" />
                    </div>

                    <div class="bg-gradient-to-r from-amber-50 to-white rounded-2xl p-4 border border-amber-100">
                        <label class="text-xs text-gray-500 mb-2 block">ËÆ∞ÂΩïÊó∂ÊÆµ</label>
                        <div class="flex bg-amber-100/50 rounded-xl p-1">
                            <button id="btn-edit-period-morning" class="flex-1 px-3 py-2.5 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600" onclick="setEditWeightPeriod('morning')">üåÖ Êó©Êô®Á©∫ËÖπ</button>
                            <button id="btn-edit-period-night" class="flex-1 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-500 transition-all" onclick="setEditWeightPeriod('night')">üåô ÊôöÈó¥Áù°Ââç</button>
                        </div>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
                <div class="px-5 py-4 border-t border-gray-100 flex gap-3">
                    <button class="flex-1 bg-gray-100 text-gray-700 py-3.5 rounded-2xl font-semibold active:scale-95 transition-transform hover:bg-gray-200" onclick="closeEditWeightModal()">ÂèñÊ∂à</button>
                    <button id="btn-edit-weight-save" class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-3.5 rounded-2xl font-semibold shadow-lg shadow-emerald-200 active:scale-95 transition-transform" onclick="submitEditWeight()">
                        <i class="fas fa-check mr-1"></i>‰øùÂ≠ò
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="daily-edit-modal" class="fixed inset-0 hidden z-[64]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeDailyEditModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl shadow-xl max-h-[85vh] flex flex-col">
                <!-- Â§¥ÈÉ® -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">ÁºñËæëÊØèÊó•Êï∞ÊçÆ</h3>
                                <p id="daily-edit-title" class="text-xs text-gray-500">--</p>
                            </div>
                        </div>
                        <button class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition-all" onclick="closeDailyEditModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- ÂÜÖÂÆπ -->
                <div class="px-5 py-5 space-y-4 overflow-y-auto flex-1">
                    <!-- ‰ΩìÈáçÂå∫Âüü -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-4 border border-blue-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-weight text-blue-500"></i>
                            <span class="text-sm font-semibold text-gray-700">‰ΩìÈáçËÆ∞ÂΩï</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">üåÖ Êó©Êô®Á©∫ËÖπ</label>
                                <input id="edit-daily-morning" type="number" step="0.01" class="w-full rounded-xl border border-blue-200 bg-white px-3 py-2.5 text-base font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-500/30" placeholder="--" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">üåô ÊôöÈó¥Áù°Ââç</label>
                                <input id="edit-daily-night" type="number" step="0.01" class="w-full rounded-xl border border-blue-200 bg-white px-3 py-2.5 text-base font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-500/30" placeholder="--" />
                            </div>
                        </div>
                    </div>

                    <!-- È•ÆÈ£üÂå∫Âüü -->
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-4 border border-emerald-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-utensils text-emerald-500"></i>
                            <span class="text-sm font-semibold text-gray-700">È•ÆÈ£üËÆ∞ÂΩï</span>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">ÂçàÈ§ê</label>
                                <textarea id="edit-daily-lunch" rows="2" class="w-full rounded-xl border border-emerald-200 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30" placeholder="‰ªäÂ§©ÂçàÈ§êÂêÉ‰∫Ü‰ªÄ‰πàÔºü"></textarea>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">ÊôöÈ§ê</label>
                                <textarea id="edit-daily-dinner" rows="2" class="w-full rounded-xl border border-emerald-200 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30" placeholder="‰ªäÂ§©ÊôöÈ§êÂêÉ‰∫Ü‰ªÄ‰πàÔºü"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ËøêÂä®Âå∫Âüü -->
                    <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-2xl p-4 border border-orange-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-dumbbell text-orange-500"></i>
                            <span class="text-sm font-semibold text-gray-700">ËøêÂä®ËÆ∞ÂΩï</span>
                        </div>
                        <textarea id="edit-daily-workout" rows="2" class="w-full rounded-xl border border-orange-200 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/30" placeholder="‰ªäÂ§©ÈîªÁÇº‰∫Ü‰ªÄ‰πàÔºü"></textarea>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
                <div class="px-5 py-4 border-t border-gray-100 flex gap-3">
                    <button class="flex-1 bg-gray-100 text-gray-700 py-3.5 rounded-2xl font-semibold active:scale-95 transition-transform hover:bg-gray-200" onclick="closeDailyEditModal()">ÂèñÊ∂à</button>
                    <button id="btn-edit-daily-save" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3.5 rounded-2xl font-semibold shadow-lg shadow-indigo-200 active:scale-95 transition-transform" onclick="submitDailyEdit()">
                        <i class="fas fa-check mr-1"></i>‰øùÂ≠ò
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast ÊèêÁ§∫ -->
    <div id="toast" class="fixed top-14 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-gray-800 to-gray-900 text-white px-5 py-3 rounded-2xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[100] flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center">
            <i class="fas fa-check text-white text-sm"></i>
        </div>
        <span id="toast-msg" class="font-medium">‰øùÂ≠òÊàêÂäü</span>
    </div>

    <script type="module">
        // 1. ÂØºÂÖ• Firebase Ê®°Âùó (‰ΩøÁî® CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp, doc, deleteDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Firebase ÈÖçÁΩÆ (Áî®Êà∑Êèê‰æõ)
        const firebaseConfig = {
            apiKey: "AIzaSyCtj6rwIsC0niDMfkidV0AcvtA8gcuT3NE",
            authDomain: "weight-29113.firebaseapp.com",
            projectId: "weight-29113",
            storageBucket: "weight-29113.firebasestorage.app",
            messagingSenderId: "452663997314",
            appId: "1:452663997314:web:c6e230824ec83634e1559b",
            measurementId: "G-DXMS6X7H22"
        };

        // 3. ÂàùÂßãÂåñ Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = "diet_logs";

        // 4. ÂÖ®Â±ÄÁä∂ÊÄÅ
        let appData = {
            logs: [],
            currentUnit: 'kg', // ËæìÂÖ•Êó∂ÁöÑÂçï‰Ωç
            weightInputPeriod: 'morning', // Êó©Êô®/Áù°Ââç
            userHeight: 172, // ÈªòËÆ§Ë∫´È´òÔºå‰ºöÂ≠òÂÇ®Âú®Èó≠ÂåÖ‰∏≠
            foodUnit: 'g', // g Êàñ ml
            foodHeatUnit: 'kj', // kcal Êàñ kjÔºåÈªòËÆ§Êåâ kJ Â∏∏ËßÅÊ†áÊ≥®
            weightHistoryFilter: 'morning',
            editWeightPeriod: 'morning',
            editingWeightId: null,
            trendMode: 'weight',
            trendRange: 30,
            editingDailyYmd: null
        };
        let chartInstance = null;

        // 5. DOM ÂÖÉÁ¥†ÂºïÁî®
        const els = {
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            // ‰ΩìÈáçËæìÂÖ•
            inputWeight: document.getElementById("input-weight"),
            displayWeight: document.getElementById("display-weight"),
            lastRecordTime: document.getElementById('last-record-time'),
            displayBMI: document.getElementById('display-bmi'),
            bmiStatus: document.getElementById('bmi-status'),
            bmiNext: document.getElementById('bmi-next'),
            bmiProgressIndicator: document.getElementById('bmi-progress-indicator'),
            recentList: document.getElementById('recent-list'),
            inputWeight: document.getElementById('input-weight'),
            calcInput: document.getElementById('calc-input'),
            calcHistory: document.getElementById('calc-history'),
            calcRun: document.getElementById('calc-run'),
            calcRope: document.getElementById('calc-rope'),
            calcDumbbell: document.getElementById('calc-dumbbell'),
            trendCurrentWeight: document.getElementById('trend-current-weight'),
            trendCurrentTime: document.getElementById('trend-current-time'),
            trendChangeBadge: document.getElementById('trend-change-badge'),
            trendChange: document.getElementById('trend-change'),
            trendChangeDesc: document.getElementById('trend-change-desc'),
            weightChange: document.getElementById('weight-change'),
            weightChangeDesc: document.getElementById('weight-change-desc'),
            weightChangeExtra: document.getElementById('weight-change-extra'),
            weightTrendBadge: document.getElementById('weight-trend-badge'),
            btnPeriodMorning: document.getElementById('btn-period-morning'),
            btnPeriodNight: document.getElementById('btn-period-night'),
            trendChange: document.getElementById('trend-change'),
            trendChangeDesc: document.getElementById('trend-change-desc'),
            trendChangeBadge: document.getElementById('trend-change-badge'),
            trendFilterBtns: document.querySelectorAll('.filter-btn'),
            trendModeDesc: document.getElementById('trend-mode-desc'),
            trendCardLabel1: document.getElementById('trend-card-label-1'),
            trendCardLabel2: document.getElementById('trend-card-label-2'),
            trendBtnWeight: document.getElementById('btn-trend-weight'),
            trendBtnMetabolic: document.getElementById('btn-trend-metabolic'),
            statMaxLabel: document.getElementById('stat-max-label'),
            statMinLabel: document.getElementById('stat-min-label'),
            chartCanvas: document.getElementById('weightChart'),
            weightHistoryModal: document.getElementById('weight-history-modal'),
            weightHistoryList: document.getElementById('weight-history-list'),
            weightHistoryTabs: document.getElementById('weight-history-tabs'),
            weightHistoryCopyRange: document.getElementById('weight-history-copy-range'),
            editWeightModal: document.getElementById('edit-weight-modal'),
            editWeightDatetime: document.getElementById('edit-weight-datetime'),
            editWeightValue: document.getElementById('edit-weight-value'),
            btnEditPeriodMorning: document.getElementById('btn-edit-period-morning'),
            btnEditPeriodNight: document.getElementById('btn-edit-period-night'),
            btnEditWeightSave: document.getElementById('btn-edit-weight-save'),
            dailyEditModal: document.getElementById('daily-edit-modal'),
            dailyEditTitle: document.getElementById('daily-edit-title'),
            dailyEditMorning: document.getElementById('edit-daily-morning'),
            dailyEditNight: document.getElementById('edit-daily-night'),
            dailyEditLunch: document.getElementById('edit-daily-lunch'),
            dailyEditDinner: document.getElementById('edit-daily-dinner'),
            dailyEditWorkout: document.getElementById('edit-daily-workout'),
            dailyEditSave: document.getElementById('btn-edit-daily-save')
        };

        // ËØªÂèñ/‰øùÂ≠ò‰ªäÊó•ÂçàÈ§ê„ÄÅÊôöÈ§ê„ÄÅËøêÂä®Â§áÊ≥®
        const mealNoteEls = {
            lunch: document.getElementById('input-lunch-note'),
            dinner: document.getElementById('input-dinner-note'),
            workout: document.getElementById('input-workout-note')
        };
        const mealStatusEls = {
            lunch: document.getElementById('status-lunch'),
            dinner: document.getElementById('status-dinner'),
            workout: document.getElementById('status-workout')
        };

        // ================= Â∑•ÂÖ∑ÂáΩÊï∞ =================

        // ÊòæÁ§∫ Toast ÊèêÁ§∫
        window.showToast = (msg) => {
            if (!els.toast || !els.toastMsg) return;
            els.toastMsg.innerText = msg;
            els.toast.classList.remove('opacity-0');
            els.toast.classList.add('opacity-100');
            setTimeout(() => {
                if (!els.toast) return;
                els.toast.classList.remove('opacity-100');
                els.toast.classList.add('opacity-0');
            }, 2000);
        };

        window.openWeightHistoryModal = () => {
            if (!els.weightHistoryModal || !els.weightHistoryList) return;
            // ÈªòËÆ§Â±ïÁ§∫ÂÖ®ÈÉ®‰ΩìÈáç
            appData.weightHistoryFilter = 'all';
            setWeightHistoryFilter('all');
            els.weightHistoryModal.classList.remove('hidden');
        };

        window.closeWeightHistoryModal = () => {
            if (!els.weightHistoryModal) return;
            els.weightHistoryModal.classList.add('hidden');
        };

        const formatDatetimeLocal = (dateObj) => {
            if (!dateObj || !Number.isFinite(dateObj.getTime())) return '';
            const y = dateObj.getFullYear();
            const m = pad2(dateObj.getMonth() + 1);
            const d = pad2(dateObj.getDate());
            const hh = pad2(dateObj.getHours());
            const mm = pad2(dateObj.getMinutes());
            return `${y}-${m}-${d}T${hh}:${mm}`;
        };

        window.setEditWeightPeriod = (period) => {
            appData.editWeightPeriod = period === 'night' ? 'night' : 'morning';
            if (els.btnEditPeriodMorning && els.btnEditPeriodNight) {
                if (appData.editWeightPeriod === 'morning') {
                    els.btnEditPeriodMorning.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnEditPeriodNight.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-500 transition-all";
                } else {
                    els.btnEditPeriodNight.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnEditPeriodMorning.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-500 transition-all";
                }
            }
        };

        // Êü•ÊâæÊüêÂ§©Êó©/Êôö‰ΩìÈáçËÆ∞ÂΩï
        function findWeightLogByYmd(ymd, period) {
            return appData.logs
                .filter(l => l.type === 'weight')
                .filter(l => normalizePeriod(l) === period)
                .find(l => getYmd(l.date || l.timestamp || l.clientCreatedAtMs) === ymd);
        }

        // ÊâìÂºÄÊØèÊó•Ê±áÊÄªÁºñËæë
        window.openDailyEditModal = (ymd) => {
            appData.editingDailyYmd = ymd;
            if (els.dailyEditTitle) els.dailyEditTitle.innerText = `${ymd} ËØ¶ÁªÜ`;
            const morning = findWeightLogByYmd(ymd, 'morning');
            const night = findWeightLogByYmd(ymd, 'night');
            const mealMap = getMealNotesMap();
            const note = mealMap[ymd] || {};
            if (els.dailyEditMorning) els.dailyEditMorning.value = morning ? formatWeight(morning.value) : '';
            if (els.dailyEditNight) els.dailyEditNight.value = night ? formatWeight(night.value) : '';
            if (els.dailyEditLunch) els.dailyEditLunch.value = note.lunch || '';
            if (els.dailyEditDinner) els.dailyEditDinner.value = note.dinner || '';
            if (els.dailyEditWorkout) els.dailyEditWorkout.value = note.workout || '';
            els.dailyEditModal?.classList.remove('hidden');
        };

        window.closeDailyEditModal = () => {
            els.dailyEditModal?.classList.add('hidden');
            appData.editingDailyYmd = null;
        };

        // ‰øùÂ≠òÊØèÊó•Ê±áÊÄªÔºàÊó©/Êôö‰ΩìÈáç + ‰∏âÂ§áÊ≥®Ôºâ
        window.submitDailyEdit = async () => {
            const ymd = appData.editingDailyYmd;
            if (!ymd) {
                showToast('Êú™ÈÄâÊã©Êó•Êúü');
                return;
            }
            const morningVal = parseFloat(els.dailyEditMorning?.value);
            const nightVal = parseFloat(els.dailyEditNight?.value);
            const lunchVal = els.dailyEditLunch?.value ?? '';
            const dinnerVal = els.dailyEditDinner?.value ?? '';
            const workoutVal = els.dailyEditWorkout?.value ?? '';

            const updates = [];
            const now = new Date();
            // Êó©Êô®
            if (Number.isFinite(morningVal)) {
                if (morningVal < 20 || morningVal > 300) {
                    showToast('Êó©Êô®‰ΩìÈáçËåÉÂõ¥ÂºÇÂ∏∏Ôºà20-300kgÔºâ');
                    return;
                }
                const existingMorning = findWeightLogByYmd(ymd, 'morning');
                const dateObj = toJsDate(existingMorning?.date) || new Date(`${ymd}T07:00:00`);
                const newDoc = {
                    date: `${ymd} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`,
                    type: "weight",
                    value: Number(morningVal.toFixed(2)),
                    period: 'morning',
                    note: "",
                    clientCreatedAtMs: dateObj.getTime(),
                    timestamp: serverTimestamp()
                };
                if (existingMorning?.id) {
                    updates.push(updateDoc(doc(db, COLLECTION_NAME, existingMorning.id), newDoc));
                } else {
                    updates.push(addDoc(collection(db, COLLECTION_NAME), newDoc));
                }
            }
            // ÊôöÈó¥
            if (Number.isFinite(nightVal)) {
                if (nightVal < 20 || nightVal > 300) {
                    showToast('ÊôöÈó¥‰ΩìÈáçËåÉÂõ¥ÂºÇÂ∏∏Ôºà20-300kgÔºâ');
                    return;
                }
                const existingNight = findWeightLogByYmd(ymd, 'night');
                const dateObj = toJsDate(existingNight?.date) || new Date(`${ymd}T22:00:00`);
                const newDoc = {
                    date: `${ymd} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`,
                    type: "weight",
                    value: Number(nightVal.toFixed(2)),
                    period: 'night',
                    note: "",
                    clientCreatedAtMs: dateObj.getTime(),
                    timestamp: serverTimestamp()
                };
                if (existingNight?.id) {
                    updates.push(updateDoc(doc(db, COLLECTION_NAME, existingNight.id), newDoc));
                } else {
                    updates.push(addDoc(collection(db, COLLECTION_NAME), newDoc));
                }
            }

            // Â§áÊ≥®
            const existingNote = appData.logs
                .filter(l => l.type === 'meal_note')
                .find(l => (l.ymd || getYmd(l.date || l.timestamp || l.clientCreatedAtMs)) === ymd);
            const noteDoc = {
                type: "meal_note",
                ymd,
                lunchNote: lunchVal.trim(),
                dinnerNote: dinnerVal.trim(),
                workoutNote: workoutVal.trim(),
                date: `${ymd} 12:00`,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };
            if (existingNote?.id) {
                updates.push(updateDoc(doc(db, COLLECTION_NAME, existingNote.id), noteDoc));
            } else {
                // ÈÅøÂÖçÂÖ®ÈÉ®Á©∫Êó∂ÊèíÂÖ•Á©∫ËÆ∞ÂΩï
                if (lunchVal.trim() || dinnerVal.trim() || workoutVal.trim()) {
                    updates.push(addDoc(collection(db, COLLECTION_NAME), noteDoc));
                }
            }

            if (!updates.length) {
                showToast('Êó†ÂèØ‰øùÂ≠òÂÜÖÂÆπ');
                return;
            }

            try {
                els.dailyEditSave && (els.dailyEditSave.disabled = true);
                els.dailyEditSave && (els.dailyEditSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰øùÂ≠ò‰∏≠...');
                await Promise.all(updates);
                showToast('‰øùÂ≠òÊàêÂäü');
                closeDailyEditModal();
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            } finally {
                if (els.dailyEditSave) {
                    els.dailyEditSave.disabled = false;
                    els.dailyEditSave.innerHTML = '‰øùÂ≠ò';
                }
            }
        };

        // ================= ÊôöÈ§êÂíåÈîªÁÇºÈ¢ÑËÆæÊñπÊ°à =================
        const DINNER_PRESETS = [
            '800mlÈªëË±ÜÊµÜÊ∞¥Ôºà20gÈªëË±ÜÊµÜÁ≤â‚ûï15g‰∫öÈ∫ªÁ±ΩÁ≤âÔºâ‚ûï100gÈ∏°ËÉ∏ËÇâ',
            '800mlÈªëË±ÜÊµÜÊ∞¥Ôºà20gÈªëË±ÜÊµÜÁ≤â‚ûï15g‰∫öÈ∫ªÁ±ΩÁ≤âÔºâ‚ûï100gÈ∏°ËÉ∏ËÇâ‚ûï2ÂùóÊ¨ßÊâéÂÖãÂÖ®È∫¶ËÑÜ'
        ];

        const WORKOUT_PRESETS = [
            'Ë∑≥Áª≥300√ó3ÁªÑÔºàÂÖ±900‰∏™Ôºâ‚ûïÂºÄÂêàË∑≥50‰∏™‚ûïËÉØ‰∏ãÂáªÊéå50‰∏™‚ûïÂéüÂú∞È´òÊä¨ËÖø100‰∏ã',
            'Ë∑≥Áª≥300√ó6ÁªÑÔºàÂÖ±1800‰∏™Ôºâ‚ûïÂºÄÂêàË∑≥100‰∏™‚ûïËÉØ‰∏ãÂáªÊéå100‰∏™‚ûïÂéüÂú∞È´òÊä¨ËÖø200‰∏ã',
            'Ë∑≥Áª≥300√ó10ÁªÑÔºàÂÖ±3000‰∏™Ôºâ‚ûïÂºÄÂêàË∑≥150‰∏™‚ûïËÉØ‰∏ãÂáªÊéå150‰∏™‚ûïÂéüÂú∞È´òÊä¨ËÖø300‰∏ã',
            'Êó†Ê∞ßËÆ≠ÁªÉ30ÂàÜÈíü'
        ];

        const WORKOUT_TIME_LABELS = {
            morning: '‰∏äÂçà‰∏≠È•≠ÂâçÁ©∫ËÖπ',
            evening: '‰∏ãÂçàÊôöÈ•≠ÂâçÁ©∫ËÖπ',
            night: '‰∏ãÂçàÊôöÈ•≠Âêé'
        };

        // Â≠òÂÇ®ÂêÑÊó∂ÊÆµÈÄâÊã©Áä∂ÊÄÅ
        const workoutSelections = {
            morning: null,  // null=Êú™ÈÄâ, -1=Êú™ÈîªÁÇº, 0-3=ÊñπÊ°àÁ¥¢Âºï
            evening: null,
            night: null
        };

        // Â≠òÂÇ®ÂêÑÊó∂ÊÆµÁöÑÊó†Ê∞ßÈÄâÊã©ÔºàÁã¨Á´ã‰∫éË∑≥Áª≥Ôºâ
        const workoutAnaerobic = {
            morning: false,
            evening: false,
            night: false
        };

        // ÈÄâÊã©ÊôöÈ§êÊñπÊ°à
        window.selectDinnerPreset = (index) => {
            const preset = DINNER_PRESETS[index];
            if (!preset) return;
            const textarea = document.getElementById('input-dinner-note');
            if (textarea) {
                textarea.value = preset;
                textarea.focus();
            }
            // Êõ¥Êñ∞ÊåâÈíÆÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.dinner-preset-btn').forEach((btn, i) => {
                if (i === index) {
                    btn.classList.remove('bg-amber-50', 'text-amber-700', 'border-amber-200');
                    btn.classList.add('bg-amber-500', 'text-white', 'border-amber-500');
                } else {
                    btn.classList.remove('bg-amber-500', 'text-white', 'border-amber-500');
                    btn.classList.add('bg-amber-50', 'text-amber-700', 'border-amber-200');
                }
            });
        };

        // ÈÄâÊã©ÈîªÁÇºÊñπÊ°àÔºàÂàÜÊó∂ÊÆµÔºåË∑≥Áª≥‰∫íÊñ•ÔºåÊó†Ê∞ßÁã¨Á´ãÔºâ
        window.selectWorkoutPreset = (timeSlot, index) => {
            const colorMap = {
                morning: { active: ['bg-blue-500', 'text-white', 'border-blue-500'], inactive: ['bg-white', 'text-blue-700', 'border-blue-200'] },
                evening: { active: ['bg-orange-500', 'text-white', 'border-orange-500'], inactive: ['bg-white', 'text-orange-700', 'border-orange-200'] },
                night: { active: ['bg-purple-500', 'text-white', 'border-purple-500'], inactive: ['bg-white', 'text-purple-700', 'border-purple-200'] }
            };
            const colors = colorMap[timeSlot];
            const btnClass = `workout-preset-btn-${timeSlot}`;
            const btns = document.querySelectorAll(`.${btnClass}`);

            if (index === 3) {
                // Êó†Ê∞ßÔºöÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅÔºàÂèØ‰∏éË∑≥Áª≥ÂêåÊó∂ÈÄâÔºâ
                workoutAnaerobic[timeSlot] = !workoutAnaerobic[timeSlot];
                const btn = btns[3];
                if (workoutAnaerobic[timeSlot]) {
                    btn.classList.remove(...colors.inactive);
                    btn.classList.add(...colors.active);
                } else {
                    btn.classList.remove(...colors.active);
                    btn.classList.add(...colors.inactive);
                }
            } else if (index === -1) {
                // Êú™ÈîªÁÇºÔºöÊ∏ÖÈô§ËØ•Êó∂ÊÆµÊâÄÊúâÈÄâÊã©
                workoutSelections[timeSlot] = -1;
                workoutAnaerobic[timeSlot] = false;
                btns.forEach((btn, i) => {
                    btn.classList.remove(...colors.active, 'bg-gray-500');
                    if (i === 4) {
                        // "Êú™ÈîªÁÇº"ÊåâÈíÆÈ´ò‰∫Æ
                        btn.classList.add('bg-gray-500', 'text-white', 'border-gray-500');
                        btn.classList.remove('text-gray-500', 'border-gray-200');
                    } else if (i < 3) {
                        btn.classList.add(...colors.inactive);
                    } else {
                        btn.classList.add(...colors.inactive);
                    }
                });
            } else {
                // Ë∑≥Áª≥ÊñπÊ°àÔºà0-2ÔºâÔºö‰∫íÊñ•ÈÄâÊã©ÔºåÂèñÊ∂à"Êú™ÈîªÁÇº"Áä∂ÊÄÅ
                workoutSelections[timeSlot] = index;
                btns.forEach((btn, i) => {
                    if (i < 3) {
                        // Ë∑≥Áª≥ÊåâÈíÆ
                        if (i === index) {
                            btn.classList.remove(...colors.inactive);
                            btn.classList.add(...colors.active);
                        } else {
                            btn.classList.remove(...colors.active);
                            btn.classList.add(...colors.inactive);
                        }
                    } else if (i === 4) {
                        // ÂèñÊ∂à"Êú™ÈîªÁÇº"È´ò‰∫Æ
                        btn.classList.remove('bg-gray-500', 'text-white', 'border-gray-500');
                        btn.classList.add('bg-white', 'text-gray-500', 'border-gray-200');
                    }
                    // Êó†Ê∞ßÊåâÈíÆ(i===3)‰øùÊåÅÂéüÁä∂ÊÄÅ
                });
            }
            
            // ÁîüÊàêÊãºÊé•ÂêéÁöÑÂ§áÊ≥®
            updateWorkoutNote();
        };

        // Ê†πÊçÆÂêÑÊó∂ÊÆµÈÄâÊã©ÁîüÊàêÂÆåÊï¥Â§áÊ≥®
        function updateWorkoutNote() {
            const parts = [];
            for (const [slot, label] of Object.entries(WORKOUT_TIME_LABELS)) {
                const jumpIdx = workoutSelections[slot];
                const hasAnaerobic = workoutAnaerobic[slot];
                
                // Êú™ÈîªÁÇº
                if (jumpIdx === -1) {
                    parts.push(`${label}ÔºöÊú™ÈîªÁÇº`);
                    continue;
                }
                
                // Êî∂ÈõÜËØ•Êó∂ÊÆµÁöÑÂÜÖÂÆπ
                const items = [];
                if (jumpIdx !== null && jumpIdx >= 0 && jumpIdx < 3 && WORKOUT_PRESETS[jumpIdx]) {
                    items.push(WORKOUT_PRESETS[jumpIdx]);
                }
                if (hasAnaerobic) {
                    items.push(WORKOUT_PRESETS[3]);
                }
                
                if (items.length > 0) {
                    parts.push(`${label}Ôºö${items.join('‚ûï')}`);
                }
            }
            
            const textarea = document.getElementById('input-workout-note');
            if (textarea && parts.length > 0) {
                textarea.value = parts.join('ÔΩú');
            }
        }

        // ÈáçÁΩÆÈîªÁÇºÈÄâÊã©Áä∂ÊÄÅ
        function resetWorkoutSelections() {
            workoutSelections.morning = null;
            workoutSelections.evening = null;
            workoutSelections.night = null;
            workoutAnaerobic.morning = false;
            workoutAnaerobic.evening = false;
            workoutAnaerobic.night = false;
            // ÈáçÁΩÆÊåâÈíÆÊ†∑Âºè
            document.querySelectorAll('.workout-preset-btn-morning').forEach((btn, i) => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500', 'bg-gray-500', 'border-gray-500');
                btn.classList.add('bg-white', i < 4 ? 'text-blue-700' : 'text-gray-500', i < 4 ? 'border-blue-200' : 'border-gray-200');
            });
            document.querySelectorAll('.workout-preset-btn-evening').forEach((btn, i) => {
                btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500', 'bg-gray-500', 'border-gray-500');
                btn.classList.add('bg-white', i < 4 ? 'text-orange-700' : 'text-gray-500', i < 4 ? 'border-orange-200' : 'border-gray-200');
            });
            document.querySelectorAll('.workout-preset-btn-night').forEach((btn, i) => {
                btn.classList.remove('bg-purple-500', 'text-white', 'border-purple-500', 'bg-gray-500', 'border-gray-500');
                btn.classList.add('bg-white', i < 4 ? 'text-purple-700' : 'text-gray-500', i < 4 ? 'border-purple-200' : 'border-gray-200');
            });
        }

        // 3.1 ‰øùÂ≠òÂçà/ÊôöÈ§ê/ËøêÂä®Â§áÊ≥®ÔºàÊîØÊåÅÂçïÁã¨‰øùÂ≠òÊàñ‰∏ÄÈîÆ‰øùÂ≠òÔºâ
        window.saveMealNote = async (type = 'all') => {
            const btn = document.getElementById('btn-save-meal-notes');
            const now = new Date();
            const ymd = getYmd(now);
            if (!ymd) {
                showToast("Êó•ÊúüÂºÇÂ∏∏");
                return;
            }
            const existing = appData.logs
                .filter(l => l.type === 'meal_note')
                .find(l => (l.ymd || getYmd(l.date || l.timestamp || l.clientCreatedAtMs)) === ymd);

            const lunchInput = mealNoteEls.lunch?.value ?? '';
            const dinnerInput = mealNoteEls.dinner?.value ?? '';
            const workoutInput = mealNoteEls.workout?.value ?? '';

            const finalLunch = type === 'lunch' ? lunchInput : (type === 'all' ? lunchInput : (existing?.lunchNote ?? ''));
            const finalDinner = type === 'dinner' ? dinnerInput : (type === 'all' ? dinnerInput : (existing?.dinnerNote ?? ''));
            const finalWorkout = type === 'workout' ? workoutInput : (type === 'all' ? workoutInput : (existing?.workoutNote ?? ''));

            const newDoc = {
                type: "meal_note",
                ymd,
                lunchNote: finalLunch.trim(),
                dinnerNote: finalDinner.trim(),
                workoutNote: finalWorkout.trim(),
                date: `${ymd} 12:00`,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰øùÂ≠ò‰∏≠...';
                }
                if (existing?.id) {
                    await updateDoc(doc(db, COLLECTION_NAME, existing.id), newDoc);
                    showToast("Â∑≤Êõ¥Êñ∞‰ªäÊó•Â§áÊ≥®");
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), newDoc);
                    showToast("Â∑≤‰øùÂ≠ò‰ªäÊó•Â§áÊ≥®");
                }
                await fetchLogs();
                // Ê∏ÖÁ©∫ÂØπÂ∫îËæìÂÖ•Ê°Ü
                const shouldClearAll = type === 'all';
                if (shouldClearAll || type === 'lunch') mealNoteEls.lunch && (mealNoteEls.lunch.value = '');
                if (shouldClearAll || type === 'dinner') mealNoteEls.dinner && (mealNoteEls.dinner.value = '');
                if (shouldClearAll || type === 'workout') {
                    mealNoteEls.workout && (mealNoteEls.workout.value = '');
                    resetWorkoutSelections();
                }
                updateTodayMealStatus();
            } catch (e) {
                console.error(e);
                showToast("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '‰∏ÄÈîÆ‰øùÂ≠ò‰∏âÊù°Â§áÊ≥®';
                }
            }
        };

        window.openEditWeightModal = (id) => {
            try {
                const target = appData.logs.find(l => l.id === id);
                if (!target) {
                    showToast('Êú™ÊâæÂà∞ËØ•ËÆ∞ÂΩï');
                    return;
                }
                appData.editingWeightId = id;
                const dateObj = toJsDate(target.date || target.timestamp || target.clientCreatedAtMs);
                if (els.editWeightDatetime) {
                    els.editWeightDatetime.value = formatDatetimeLocal(dateObj);
                }
                if (els.editWeightValue) {
                    els.editWeightValue.value = Number(target.value).toFixed(2);
                }
                window.setEditWeightPeriod(normalizePeriod(target));
                els.editWeightModal?.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                showToast('ÊâìÂºÄÁºñËæëÂ§±Ë¥•');
            }
        };

        window.closeEditWeightModal = () => {
            els.editWeightModal?.classList.add('hidden');
            appData.editingWeightId = null;
        };

        window.submitEditWeight = async () => {
            const btn = els.btnEditWeightSave;
            if (!appData.editingWeightId) {
                showToast('Êú™ÈÄâÊã©Ë¶Å‰øÆÊîπÁöÑËÆ∞ÂΩï');
                return;
            }
            const rawVal = parseFloat(els.editWeightValue?.value);
            if (!Number.isFinite(rawVal) || rawVal <= 0) {
                showToast('ËØ∑ËæìÂÖ•‰ΩìÈáçÊï∞ÂÄº');
                return;
            }
            if (rawVal < 20 || rawVal > 300) {
                showToast('‰ΩìÈáçËåÉÂõ¥ÂºÇÂ∏∏Ôºà20-300kgÔºâ');
                return;
            }
            const rawDatetime = els.editWeightDatetime?.value;
            const dateObj = rawDatetime ? new Date(rawDatetime) : null;
            if (!dateObj || !Number.isFinite(dateObj.getTime())) {
                showToast('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÊó∂Èó¥');
                return;
            }
            const dateStr = `${dateObj.getFullYear()}-${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())} ${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰øùÂ≠ò‰∏≠...';
                }
                const newDoc = {
                    date: dateStr,
                    type: "weight",
                    value: Number(rawVal.toFixed(2)),
                    period: appData.editWeightPeriod,
                    note: "",
                    clientCreatedAtMs: dateObj.getTime(),
                    timestamp: serverTimestamp()
                };
                await updateDoc(doc(db, COLLECTION_NAME, appData.editingWeightId), newDoc);
                showToast('Â∑≤Êõ¥Êñ∞ËÆ∞ÂΩï');
                window.closeEditWeightModal();
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '‰øùÂ≠ò‰øÆÊîπ';
                }
            }
        };

        function getYmd(dateValue) {
            const d = toJsDate(dateValue);
            if (!d || !Number.isFinite(d.getTime())) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function renderWeightHistoryModal() {
            const wrap = els.weightHistoryList;
            if (!wrap) return;
            wrap.innerHTML = '';

            const weights = getWeightLogs(appData.weightHistoryFilter)
                .sort((a, b) => getLogDateMs(b) - getLogDateMs(a));
            const mealNotes = getMealNotesMap();

            if (!weights.length) {
                wrap.innerHTML = '<div class="text-center text-gray-400 py-8">ÊöÇÊó†‰ΩìÈáçËÆ∞ÂΩï</div>';
                return;
            }

            weights.forEach(item => {
                const ymd = getYmd(item.date || item.timestamp);
                const note = mealNotes[ymd];
                const noteHtml = note && (note.lunch || note.dinner || note.workout)
                    ? `<p class="text-[11px] text-gray-500 mt-1">ÂçàÔºö${note.lunch || '--'} ¬∑ ÊôöÔºö${note.dinner || '--'} ¬∑ ËøêÂä®Ôºö${note.workout || '--'}</p>`
                    : '';
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-3 border-b border-gray-100';
                row.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-gray-900">${ymd}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(item.date || item.timestamp)} ¬∑ ${WEIGHT_PERIOD_LABEL[normalizePeriod(item)] || ''}</p>
                        ${noteHtml}
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="text-base font-bold text-gray-900">${formatWeight(item.value)} kg</p>
                        <button class="text-emerald-600 text-xs px-3 py-2 rounded-lg hover:bg-emerald-50" onclick="openEditWeightModal('${item.id}')">ÁºñËæë</button>
                    </div>
                `;
                wrap.appendChild(row);
            });
        }

        const WEIGHT_HISTORY_RANGE_LABEL = {
            all: 'ÂÖ®ÈÉ®ÂéÜÂè≤',
            '7d': 'Ëøë7Â§©',
            '1m': 'Ëøë1‰∏™Êúà',
            '2m': 'Ëøë2‰∏™Êúà',
            '3m': 'Ëøë3‰∏™Êúà',
            '4m': 'Ëøë4‰∏™Êúà',
            '5m': 'Ëøë5‰∏™Êúà',
            '6m': 'ËøëÂçäÂπ¥',
            '1y': 'Ëøë‰∏ÄÂπ¥'
        };

        function getRangeCutoffMs(rangeKey) {
            if (!rangeKey || rangeKey === 'all') return null;
            const now = new Date();
            const d = new Date(now);
            if (rangeKey === '7d') d.setDate(d.getDate() - 7);
            else if (rangeKey === '1m') d.setMonth(d.getMonth() - 1);
            else if (rangeKey === '2m') d.setMonth(d.getMonth() - 2);
            else if (rangeKey === '3m') d.setMonth(d.getMonth() - 3);
            else if (rangeKey === '4m') d.setMonth(d.getMonth() - 4);
            else if (rangeKey === '5m') d.setMonth(d.getMonth() - 5);
            else if (rangeKey === '6m') d.setMonth(d.getMonth() - 6);
            else if (rangeKey === '1y') d.setFullYear(d.getFullYear() - 1);
            const ms = d.getTime();
            return Number.isFinite(ms) ? ms : null;
        }

        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        // Ëé∑ÂèñÊåâÊó•ÊúüËÅöÂêàÁöÑÂçàÈ§ê/ÊôöÈ§êÂ§áÊ≥®
        function getMealNotesMap() {
            const map = {};
            appData.logs
                .filter(l => l.type === 'meal_note')
                .forEach(item => {
                    const ymd = item.ymd || getYmd(item.date || item.timestamp || item.clientCreatedAtMs);
                    if (!ymd) return;
                    map[ymd] = {
                        lunch: item.lunchNote || '',
                        dinner: item.dinnerNote || '',
                        workout: item.workoutNote || ''
                    };
                });
            return map;
        }

        function buildMealNotesMapFromList(logs) {
            const map = {};
            logs
                .filter(l => l.type === 'meal_note')
                .forEach(item => {
                    const ymd = item.ymd || getYmd(item.date || item.timestamp || item.clientCreatedAtMs);
                    if (!ymd) return;
                    map[ymd] = {
                        lunch: item.lunchNote || '',
                        dinner: item.dinnerNote || '',
                        workout: item.workoutNote || ''
                    };
                });
            return map;
        }

        function buildDailyAggregation(logs, cutoffMs = null) {
            const map = {};
            logs.forEach(item => {
                const ms = getLogDateMs(item);
                if (cutoffMs && ms < cutoffMs) return;
                const ymd = getYmd(item.date || item.timestamp || item.clientCreatedAtMs);
                if (!ymd) return;
                if (!map[ymd]) map[ymd] = { ymd };
                if (item.type === 'weight') {
                    const period = normalizePeriod(item);
                    if (period === 'morning') {
                        if (!map[ymd].morning || ms > (map[ymd].morningMs || 0)) {
                            map[ymd].morning = item;
                            map[ymd].morningMs = ms;
                        }
                    } else {
                        if (!map[ymd].night || ms > (map[ymd].nightMs || 0)) {
                            map[ymd].night = item;
                            map[ymd].nightMs = ms;
                        }
                    }
                } else if (item.type === 'meal_note') {
                    map[ymd].lunch = item.lunchNote || '';
                    map[ymd].dinner = item.dinnerNote || '';
                    map[ymd].workout = item.workoutNote || '';
                }
            });
            return Object.values(map).sort((a, b) => (b.morningMs || b.nightMs || 0) - (a.morningMs || a.nightMs || 0));
        }

        function buildWeightHistoryTsv(dailyRows, meta) {
            const { filterLabel, rangeLabel } = meta || {};
            const rows = [...(dailyRows || [])].sort((a, b) => {
                const msA = a.morningMs || a.nightMs || 0;
                const msB = b.morningMs || b.nightMs || 0;
                return msA - msB;
            });
            const lines = [];
            lines.push(`ËåÉÂõ¥: ${rangeLabel || ''} | Á±ªÂûã: ${filterLabel || ''} | Âçï‰Ωç: kg`);
            lines.push('date\tmorning_kg\tnight_kg\tlunch_note\tdinner_note\tworkout_note');
            rows.forEach(item => {
                const ymd = item.ymd;
                const morning = item.morning ? formatWeight(item.morning.value) : '';
                const night = item.night ? formatWeight(item.night.value) : '';
                const lunch = item.lunch || '';
                const dinner = item.dinner || '';
                const workout = item.workout || '';
                lines.push(`${ymd}\t${morning}\t${night}\t${lunch}\t${dinner}\t${workout}`);
            });
            return lines.join('\n');
        }

        async function copyTextToClipboard(text) {
            if (navigator?.clipboard?.writeText) {
                await navigator.clipboard.writeText(text);
                return;
            }
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (!ok) throw new Error('copy_failed');
        }

        window.copyWeightHistoryToClipboard = async (rangeKey = 'all') => {
            try {
                const filter = appData.weightHistoryFilter || 'all';
                const filterLabel = filter === 'morning' ? 'Êó©Êô®Á©∫ËÖπ' : (filter === 'night' ? 'ÊôöÈó¥Áù°Ââç' : 'ÂÖ®ÈÉ®');
                const rangeLabel = WEIGHT_HISTORY_RANGE_LABEL[rangeKey] || '';

                const cutoffMs = getRangeCutoffMs(rangeKey);
                const dailyRows = buildDailyAggregation(appData.logs, cutoffMs);
                if (!dailyRows.length) {
                    showToast('ËØ•ËåÉÂõ¥ÊöÇÊó†ËÆ∞ÂΩï');
                    return;
                }

                const text = buildWeightHistoryTsv(dailyRows, { filterLabel, rangeLabel });

                await copyTextToClipboard(text);
                showToast(`Â∑≤Â§çÂà∂ ${dailyRows.length} Â§©`);
            } catch (e) {
                console.error(e);
                showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        };

        // Ê†ºÂºèÂåñÊó•Êúü
        const toJsDate = (value) => {
            if (!value) return null;
            if (typeof value === 'object' && typeof value.toDate === 'function') {
                return value.toDate();
            }
            if (typeof value === 'string') {
                const s = value.trim();
                if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(s)) {
                    return new Date(s.replace(' ', 'T') + ':00');
                }
                if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                    return new Date(s + 'T00:00:00');
                }
                return new Date(s);
            }
            return new Date(value);
        };

        const getLogDateMs = (log) => {
            const clientMs = Number(log?.clientCreatedAtMs);
            if (Number.isFinite(clientMs)) return clientMs;
            const d = toJsDate(log?.date) || toJsDate(log?.timestamp);
            const ms = d?.getTime();
            return Number.isFinite(ms) ? ms : 0;
        };

        function downloadTextAsFile(filename, text, mime = 'text/plain;charset=utf-8') {
            const blob = new Blob([text], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeCsvCell(value) {
            const s = String(value ?? '');
            if (/[,\n\r"]/g.test(s)) return `"${s.replace(/"/g, '""')}"`;
            return s;
        }

        function buildWeightHistoryCsv(dailyRows, meta) {
            const { filterLabel, rangeLabel, notesMap } = meta || {};
            const mealMap = notesMap || getMealNotesMap();
            const rows = [...(dailyRows || [])].sort((a, b) => {
                const msA = a.morningMs || a.nightMs || 0;
                const msB = b.morningMs || b.nightMs || 0;
                return msA - msB;
            });
            const lines = [];
            lines.push(`ËåÉÂõ¥,${escapeCsvCell(rangeLabel || '')}`);
            lines.push(`Á±ªÂûã,${escapeCsvCell(filterLabel || '')}`);
            lines.push(`Âçï‰Ωç,kg`);
            lines.push('date,morning_kg,night_kg,lunch_note,dinner_note,workout_note');
            rows.forEach(item => {
                const ymd = item.ymd;
                const morning = item.morning ? formatWeight(item.morning.value) : '';
                const night = item.night ? formatWeight(item.night.value) : '';
                const note = mealMap[ymd] || {};
                lines.push([
                    ymd,
                    morning,
                    night,
                    note.lunch || item.lunch || '',
                    note.dinner || item.dinner || '',
                    note.workout || item.workout || ''
                ].map(escapeCsvCell).join(','));
            });
            return '\uFEFF' + lines.join('\n');
        }

        async function fetchAllLogsForExport() {
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            const all = [];
            snap.forEach(d => all.push({ id: d.id, ...d.data() }));
            all.sort((a, b) => getLogDateMs(b) - getLogDateMs(a));
            return all;
        };

        window.downloadWeightHistoryCsv = async (rangeKey = 'all') => {
            try {
                const filter = appData.weightHistoryFilter || 'all';
                const filterLabel = filter === 'morning' ? 'Êó©Êô®Á©∫ËÖπ' : (filter === 'night' ? 'ÊôöÈó¥Áù°Ââç' : 'ÂÖ®ÈÉ®');
                const rangeLabel = WEIGHT_HISTORY_RANGE_LABEL[rangeKey] || '';
                showToast('Ê≠£Âú®ÁîüÊàêCSV...');

                const allLogs = await fetchAllLogsForExport();
                const cutoffMs = getRangeCutoffMs(rangeKey);
                const dailyRows = buildDailyAggregation(allLogs, cutoffMs);
                if (!dailyRows.length) {
                    showToast('ËØ•ËåÉÂõ¥ÊöÇÊó†ËÆ∞ÂΩï');
                    return;
                }

                const notesMap = buildMealNotesMapFromList(allLogs);
                const csv = buildWeightHistoryCsv(dailyRows, { filterLabel, rangeLabel, notesMap });
                const today = getYmd(Date.now()) || 'export';
                const filename = `weight_daily_${rangeKey}_${today}.csv`;
                downloadTextAsFile(filename, csv, 'text/csv;charset=utf-8');
                showToast(`Â∑≤‰∏ãËΩΩ ${dailyRows.length} Â§©`);
            } catch (e) {
                console.error(e);
                showToast('ÂØºÂá∫Â§±Ë¥•');
            }
        };

        window.downloadAllLogsJson = async () => {
            try {
                showToast('Ê≠£Âú®ÂØºÂá∫JSON...');
                const allLogs = await fetchAllLogsForExport();
                const dailyRows = buildDailyAggregation(allLogs);
                const payload = {
                    exportedAt: new Date().toISOString(),
                    collection: COLLECTION_NAME,
                    days: dailyRows.map(day => ({
                        date: day.ymd,
                        morning_kg: day.morning ? Number(day.morning.value).toFixed(2) : null,
                        night_kg: day.night ? Number(day.night.value).toFixed(2) : null,
                        lunch_note: day.lunch || '',
                        dinner_note: day.dinner || '',
                        workout_note: day.workout || ''
                    }))
                };
                const today = getYmd(Date.now()) || 'export';
                downloadTextAsFile(`diet_days_${today}.json`, JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
                showToast(`Â∑≤ÂØºÂá∫ ${dailyRows.length} Â§©`);
            } catch (e) {
                console.error(e);
                showToast('ÂØºÂá∫Â§±Ë¥•');
            }
        };

        window.openImportJson = () => {
            const input = document.getElementById('import-json-input');
            input?.click();
        };

        window.importLogsFromJsonFile = async (event) => {
            try {
                const file = event?.target?.files?.[0];
                if (!file) return;
                const text = await file.text();
                const data = JSON.parse(text);
                const logs = Array.isArray(data) ? data : (Array.isArray(data?.logs) ? data.logs : []);
                if (!logs.length) {
                    showToast('Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫');
                    return;
                }
                const ok = confirm(`Â∞ÜÂØºÂÖ• ${logs.length} Êù°ËÆ∞ÂΩïÔºà‰ºöÊñ∞Â¢ûÔºåÂèØËÉΩÈáçÂ§çÔºâ„ÄÇÁªßÁª≠Ôºü`);
                if (!ok) return;

                for (const itemRaw of logs) {
                    if (!itemRaw || typeof itemRaw !== 'object') continue;
                    const item = { ...itemRaw };
                    delete item.id;
                    delete item.timestamp;

                    const ms = Number(item.clientCreatedAtMs);
                    const dateObj = toJsDate(item.date) || (Number.isFinite(ms) ? new Date(ms) : null);
                    const now = new Date();
                    const finalDate = dateObj && Number.isFinite(dateObj.getTime()) ? dateObj : now;
                    const dateStr = `${finalDate.getFullYear()}-${String(finalDate.getMonth()+1).padStart(2,'0')}-${String(finalDate.getDate()).padStart(2,'0')} ${String(finalDate.getHours()).padStart(2,'0')}:${String(finalDate.getMinutes()).padStart(2,'0')}`;
                    item.date = dateStr;
                    item.clientCreatedAtMs = Number.isFinite(ms) ? ms : finalDate.getTime();
                    item.timestamp = serverTimestamp();

                    await addDoc(collection(db, COLLECTION_NAME), item);
                }

                showToast('ÂØºÂÖ•ÂÆåÊàê');
                event.target.value = '';
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('ÂØºÂÖ•Â§±Ë¥•');
            }
        };

        const formatWeight = (val) => {
            const n = Number(val);
            return Number.isFinite(n) ? n.toFixed(2) : '--';
        };

        const WEIGHT_PERIOD_LABEL = {
            morning: 'Êó©Êô®Á©∫ËÖπ',
            night: 'ÊôöÈó¥Áù°Ââç'
        };

        const normalizePeriod = (log) => (log?.period === 'night' ? 'night' : 'morning');

        const getWeightLogs = (filter = 'all') => {
            const weights = appData.logs.filter(l => l.type === 'weight');
            if (filter === 'morning') return weights.filter(l => normalizePeriod(l) === 'morning');
            if (filter === 'night') return weights.filter(l => normalizePeriod(l) === 'night');
            return weights;
        };

        const formatDate = (value) => {
            const date = toJsDate(value);
            if (!date || !Number.isFinite(date.getTime())) return '--';
            return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
        };

        // ÂàáÊç¢ËßÜÂõæ
        window.switchView = (viewName) => {
            // ÈöêËóèÊâÄÊúâ View
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // ÊòæÁ§∫ÁõÆÊ†á View
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Áä∂ÊÄÅ
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewName) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-emerald-600');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-emerald-600');
                }
            });

            // Â¶ÇÊûúÂàáÊç¢Âà∞Ë∂ãÂäøÈ°µÔºåÈáçÊñ∞Ê∏≤ÊüìÂõæË°®
            if(viewName === 'trend') {
                if (typeof syncTrendLabels === 'function') syncTrendLabels();
                if (typeof window.filterChart === 'function') window.filterChart(30); // ÈªòËÆ§ÊòæÁ§∫30Â§©
            }

            // Â¶ÇÊûúÂàáÊç¢Âà∞È¶ñÈ°µÔºåÊ†πÊçÆÂΩìÂâçÊó∂Èó¥Ëá™Âä®ËÆæÁΩÆ‰ΩìÈáçËÆ∞ÂΩïÊó∂ÊÆµ
            if(viewName === 'home') {
                const now = new Date();
                const hour = now.getHours();
                // ÂáåÊô®0ÁÇπÂà∞‰∏≠Âçà12ÁÇπÂâç -> Êó©Êô®Á©∫ËÖπ
                // ‰∏≠Âçà12ÁÇπÂà∞ÂáåÊô®0ÁÇπ -> ÊôöÈó¥Áù°Ââç
                const autoPeriod = (hour >= 0 && hour < 12) ? 'morning' : 'night';
                setWeightPeriod(autoPeriod);
            }
        };

        // ÂéÜÂè≤Á≠õÈÄâÊ†áÁ≠æ
        window.setWeightHistoryFilter = (filter) => {
            appData.weightHistoryFilter = filter;
            if (els.weightHistoryTabs) {
                els.weightHistoryTabs.querySelectorAll('button').forEach(btn => {
                    const active = btn.getAttribute('onclick')?.includes(`'${filter}'`);
                    if (active) {
                        btn.className = "flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-sm transition-all";
                    } else {
                        btn.className = "flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all";
                    }
                });
            }
            renderWeightHistoryModal();
        };

        // ‰ΩìÈáçËÆ∞ÂΩïÊó∂ÊÆµÂàáÊç¢ÔºàÊó©Êô®/Áù°ÂâçÔºâ
        window.setWeightPeriod = (period) => {
            appData.weightInputPeriod = period === 'night' ? 'night' : 'morning';
            if (els.btnPeriodMorning && els.btnPeriodNight) {
                if (appData.weightInputPeriod === 'morning') {
                    els.btnPeriodMorning.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnPeriodNight.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium text-gray-500 transition-all";
                } else {
                    els.btnPeriodNight.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnPeriodMorning.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium text-gray-500 transition-all";
                }
            }
        };

        // ËÆæÁΩÆËæìÂÖ•Âçï‰Ωç (Kg/Jin)
        window.setUnit = (unit) => {
            appData.currentUnit = unit;
            const btnKg = document.getElementById('btn-unit-kg');
            const btnJin = document.getElementById('btn-unit-jin');
            
            if(unit === 'kg') {
                btnKg.className = "px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                btnJin.className = "px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all";
            } else {
                btnJin.className = "px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                btnKg.className = "px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all";
            }
        };

        // ================= Ê†∏ÂøÉ‰∏öÂä°ÈÄªËæë =================

        // 1. Ëé∑ÂèñÊï∞ÊçÆ (ËØªÂèñ)
        async function fetchLogs() {
            try {
                let querySnapshot;
                try {
                    const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'), limit(800));
                    querySnapshot = await getDocs(q);
                } catch (e) {
                    console.warn('fetchLogs orderBy(timestamp) failed, fallback to orderBy(date)', e);
                    const q = query(collection(db, COLLECTION_NAME), orderBy('date', 'desc'), limit(800));
                    querySnapshot = await getDocs(q);
                }
                
                appData.logs = [];
                querySnapshot.forEach((doc) => {
                    appData.logs.push({ id: doc.id, ...doc.data() });
                });

                appData.logs.sort((a, b) => getLogDateMs(b) - getLogDateMs(a));

                renderHome();
                renderCalcHistory();
                updateTodayMealStatus();
            } catch (error) {
                console.error("Error fetching logs: ", error);
                showToast("Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•");
            }
        }

        // 2. Ê∏≤ÊüìÈ¶ñÈ°µ
        function renderHome() {
            // ËÆæÁΩÆÂΩìÂâçÊó•Êúü
            const now = new Date();
            document.getElementById('current-date').innerText = `${now.getFullYear()}Âπ¥${now.getMonth()+1}Êúà${now.getDate()}Êó•`;

            // ËøáÊª§Âá∫‰ΩìÈáçËÆ∞ÂΩïÔºàÈ¶ñÈ°µÊåáÊ†á‰ªÖÁúãÊó©Êô®Á©∫ËÖπÔºâ
            const morningWeightLogs = getWeightLogs('morning');

            if (morningWeightLogs.length > 0) {
                const latest = morningWeightLogs[0];
                els.displayWeight.innerText = formatWeight(latest.value);
                const latestDate = toJsDate(latest.date) || toJsDate(latest.timestamp);
                if (latestDate && Number.isFinite(latestDate.getTime())) {
                    const periodLabel = WEIGHT_PERIOD_LABEL[normalizePeriod(latest)] || '';
                    els.lastRecordTime.innerText = `ËÆ∞ÂΩï‰∫é ${String(latestDate.getHours()).padStart(2, '0')}:${String(latestDate.getMinutes()).padStart(2, '0')} ¬∑ ${periodLabel}`;
                } else {
                    els.lastRecordTime.innerText = `ËÆ∞ÂΩï‰∫é --:--`;
                }
                
                // ‰ΩìÈáçÂèòÂåñÔºà‰∏é‰∏ä‰∏ÄÊù°ÂØπÊØîÔºâ
                if (morningWeightLogs.length > 1) {
                    const prev = morningWeightLogs[1];
                    const diff = latest.value - prev.value;
                    const sign = diff > 0 ? '+' : '';
                    els.weightChange.innerText = `${sign}${diff.toFixed(2)} kg`;
                    els.weightChangeDesc.innerText = `ËæÉ‰∏ä‰∏ÄÊù° ${formatDate(prev.date || prev.timestamp)}`;
                    if (diff > 0) {
                        els.weightTrendBadge.innerText = '‰∏äÂçá';
                        els.weightTrendBadge.className = 'bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full';
                    } else if (diff < 0) {
                        els.weightTrendBadge.innerText = '‰∏ãÈôç';
                        els.weightTrendBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                    } else {
                        els.weightTrendBadge.innerText = 'ÊåÅÂπ≥';
                        els.weightTrendBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                    }
                } else {
                    els.weightChange.innerText = '--';
                    els.weightChangeDesc.innerText = 'Á≠âÂæÖÊñ∞ËÆ∞ÂΩï';
                    els.weightTrendBadge.innerText = '-';
                    els.weightTrendBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                }

                if (els.weightChangeExtra) {
                    const cutoff = new Date();
                    cutoff.setDate(cutoff.getDate() - 7);
                    const cutoffMs = cutoff.getTime();
                    const last7 = morningWeightLogs
                        .filter(l => getLogDateMs(l) >= cutoffMs)
                        .sort((a, b) => getLogDateMs(a) - getLogDateMs(b));
                    if (last7.length >= 2) {
                        const first7 = last7[0];
                        const last7Item = last7[last7.length - 1];
                        const diff7 = Number(last7Item.value) - Number(first7.value);
                        const sign7 = diff7 > 0 ? '+' : '';
                        const avg7 = last7.reduce((sum, x) => sum + Number(x.value || 0), 0) / last7.length;
                        els.weightChangeExtra.innerText = `Ëøë7Â§© ${sign7}${diff7.toFixed(2)} kg ¬∑ ÂùáÂÄº ${avg7.toFixed(2)} kgÔºà${last7.length}Êù°Ôºâ`;
                    } else if (last7.length === 1) {
                        els.weightChangeExtra.innerText = 'Ëøë7Â§©‰ªÖ1Êù°ËÆ∞ÂΩï';
                    } else {
                        els.weightChangeExtra.innerText = 'Ëøë7Â§©ÊöÇÊó†ËÆ∞ÂΩï';
                    }
                }
                
                // ËÆ°ÁÆó BMI
                const heightM = appData.userHeight / 100;
                const bmi = latest.value / (heightM * heightM);
                els.displayBMI.innerText = bmi.toFixed(2);
                
                // BMI Áä∂ÊÄÅ & ËøõÂ∫¶Êù°
                let status = "Ê≠£Â∏∏";
                let nextText = "‰øùÊåÅÂΩìÂâçÁä∂ÊÄÅ";
                const segments = [
                    { label: 'ÂÅèÁò¶', min: 0, max: 18.5, color: 'text-sky-600' },
                    { label: 'Ê≠£Â∏∏', min: 18.5, max: 24, color: 'text-emerald-600' },
                    { label: 'ËøáÈáç', min: 24, max: 27, color: 'text-amber-600' },
                    { label: 'ËÇ•ËÉñ', min: 27, max: 40, color: 'text-rose-600' }
                ];

                if(bmi < 18.5) {
                    status = "ÂÅèÁò¶";
                    nextText = `Ë∑ùÁ¶ª‚ÄúÊ≠£Â∏∏‚ÄùËøòÂ∑Æ ${(18.5 - bmi).toFixed(2)}`;
                } else if(bmi >= 18.5 && bmi < 24) {
                    status = "Ê≠£Â∏∏";
                    nextText = `Ë∑ùÁ¶ª‚ÄúËøáÈáç‚ÄùËøòÊúâ ${(24 - bmi).toFixed(2)}`;
                } else if(bmi >= 24 && bmi < 27) {
                    status = "ËøáÈáç";
                    nextText = `Ë∑ùÁ¶ª‚ÄúËÇ•ËÉñ‚ÄùËøòÊúâ ${(27 - bmi).toFixed(2)}`;
                } else {
                    status = "ËÇ•ËÉñ";
                    nextText = 'Âª∫ËÆÆÂ∞ΩÂø´ÊéßÂà∂‰ΩìÈáç';
                }
                els.bmiStatus.className = `text-xs mt-1 font-semibold ${segments.find(s => status.includes(s.label))?.color || 'text-emerald-700'}`;
                els.bmiStatus.innerText = status;
                if (els.bmiNext) els.bmiNext.innerText = nextText;

                // ËøõÂ∫¶Êù°‰ΩçÁΩÆÔºö0-40 Á∫øÊÄßÔºå18.5/24/27 ‰ΩçÁΩÆË¥¥ÂêàÂàªÂ∫¶
                const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
                const bmiForBar = clamp(bmi, 0, 40);
                const percent = (bmiForBar / 40) * 100;
                if (els.bmiProgressIndicator) {
                    els.bmiProgressIndicator.style.left = `${percent}%`;
                }
            } else {
                els.displayWeight.innerText = "--";
                els.bmiStatus.innerText = "Êú™Áü•";
                if (els.bmiNext) els.bmiNext.innerText = "";
                if (els.bmiProgressIndicator) els.bmiProgressIndicator.style.left = '0%';
            }

            // Ê∏≤ÊüìÊúÄËøëÂ§©Ê±áÊÄª (ÈªòËÆ§7Â§©)
            els.recentList.innerHTML = "";
            const recentDays = buildDailyAggregation(appData.logs).slice(0, 7);
            if (!recentDays.length) {
                els.recentList.innerHTML = '<li class="text-center text-gray-400 py-6"><i class="fas fa-inbox text-3xl mb-2 block opacity-50"></i>ÊöÇÊó†‰ΩìÈáçËÆ∞ÂΩï</li>';
            } else {
                recentDays.forEach((day, index) => {
                    const morningVal = day.morning ? formatWeight(day.morning.value) : '--';
                    const nightVal = day.night ? formatWeight(day.night.value) : '--';
                    const lunch = day.lunch || '--';
                    const dinner = day.dinner || '--';
                    const workout = day.workout || '--';
                    const isToday = day.ymd === getYmd(Date.now());
                    const li = document.createElement('li');
                    li.className = `bg-gradient-to-r ${isToday ? 'from-emerald-50 to-teal-50 border-emerald-200' : 'from-white to-gray-50 border-gray-100'} border rounded-2xl px-4 py-3 shadow-sm`;
                    li.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl ${isToday ? 'bg-gradient-to-br from-emerald-400 to-teal-500 text-white' : 'bg-gray-100 text-gray-500'} flex items-center justify-center shadow-sm">
                                    <i class="fas fa-calendar-day text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800">${day.ymd} ${isToday ? '<span class="text-xs text-emerald-600 bg-emerald-100 px-1.5 py-0.5 rounded ml-1">‰ªäÂ§©</span>' : ''}</p>
                                    <div class="flex items-center gap-2 text-xs text-gray-500 mt-0.5">
                                        <span class="flex items-center gap-1"><i class="fas fa-sun text-amber-400"></i>${morningVal}</span>
                                        <span class="flex items-center gap-1"><i class="fas fa-moon text-indigo-400"></i>${nightVal}</span>
                                        <span class="text-gray-300">kg</span>
                                    </div>
                                </div>
                            </div>
                            <button class="text-gray-400 hover:text-emerald-600 w-9 h-9 rounded-xl hover:bg-emerald-50 flex items-center justify-center transition-all" onclick="openDailyEditModal('${day.ymd}')">
                                <i class="fas fa-pen text-sm"></i>
                            </button>
                        </div>
                        <div class="text-[11px] text-gray-500 space-y-1 pl-[52px]">
                            <p class="truncate"><span class="text-gray-400">ÂçàÈ§ê</span> ${lunch}</p>
                            <p class="truncate"><span class="text-gray-400">ÊôöÈ§ê</span> ${dinner}</p>
                            <p class="truncate"><span class="text-gray-400">ËøêÂä®</span> ${workout}</p>
                        </div>
                    `;
                    els.recentList.appendChild(li);
                });
            }
        }

        // Âä†ËΩΩ‰ªäÊó•Âçà/ÊôöÈ§êÂ§áÊ≥®Âà∞ËæìÂÖ•Ê°Ü
        function fillTodayMealNotes() {
            const today = getYmd(Date.now());
            if (!today) return;
            const map = getMealNotesMap();
            const note = map[today] || {};
            if (mealNoteEls.lunch) mealNoteEls.lunch.value = note.lunch || '';
            if (mealNoteEls.dinner) mealNoteEls.dinner.value = note.dinner || '';
            if (mealNoteEls.workout) mealNoteEls.workout.value = note.workout || '';
        }

        function setMealStatusBadge(type, filled) {
            const el = mealStatusEls[type];
            if (!el) return;
            if (filled) {
                el.innerText = 'Â∑≤Â°´';
                el.className = 'text-[11px] px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100';
            } else {
                el.innerText = 'Êú™Â°´';
                el.className = 'text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-500';
            }
        }

        function updateTodayMealStatus() {
            const today = getYmd(Date.now());
            if (!today) return;
            const map = getMealNotesMap();
            const note = map[today] || {};
            setMealStatusBadge('lunch', !!(note.lunch && note.lunch.trim()));
            setMealStatusBadge('dinner', !!(note.dinner && note.dinner.trim()));
            setMealStatusBadge('workout', !!(note.workout && note.workout.trim()));
        }

        // 3. ‰øùÂ≠ò‰ΩìÈáç (ÂÜôÂÖ•)
        window.saveWeight = async () => {
            const rawVal = parseFloat(els.inputWeight.value);

            if (!Number.isFinite(rawVal) || rawVal <= 0) {
                showToast("ËØ∑ËæìÂÖ•‰ΩìÈáçÊï∞ÂÄº");
                return;
            }

            // Âä†ËΩΩÂä®ÁîªÁä∂ÊÄÅ
            const btn = document.getElementById('btn-save-weight');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ‰øùÂ≠ò‰∏≠...`;
            btn.disabled = true;

            // Âçï‰ΩçËΩ¨Êç¢ÔºöÂ¶ÇÊûúÊòØÊñ§ÔºåÈô§‰ª•2ËΩ¨‰∏∫KGÂ≠òÂÖ•Êï∞ÊçÆÂ∫ì
            const weightKg = appData.currentUnit === 'jin' ? rawVal / 2 : rawVal;
            const weightFixed = Number(weightKg.toFixed(2));

            if (!Number.isFinite(weightFixed) || weightFixed < 20 || weightFixed > 300) {
                showToast("‰ΩìÈáçËåÉÂõ¥ÂºÇÂ∏∏Ôºà20-300kgÔºâ");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            const now = new Date();
            // Ê†ºÂºèÂåñ‰∏∫ YYYY-MM-DD HH:mm
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            const todayYmd = getYmd(now);
            const existing = appData.logs
                .filter(l => l.type === 'weight')
                .filter(l => normalizePeriod(l) === appData.weightInputPeriod)
                .filter(l => getYmd(l.date || l.timestamp || l.clientCreatedAtMs) === todayYmd)
                .sort((a, b) => getLogDateMs(b) - getLogDateMs(a))[0];

            const newDoc = {
                date: dateStr,
                type: "weight",
                value: weightFixed,
                period: appData.weightInputPeriod,
                note: "",
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                if (existing?.id) {
                    const periodLabel = WEIGHT_PERIOD_LABEL[appData.weightInputPeriod] || '';
                    const ok = confirm(`‰ªäÂ§©Â∑≤ËÆ∞ÂΩïËøá„Äê${periodLabel}„Äë‰ΩìÈáçÔºåÊòØÂê¶Ë¶ÜÁõñÔºü`);
                    if (!ok) {
                        return;
                    }
                    await updateDoc(doc(db, COLLECTION_NAME, existing.id), newDoc);
                    showToast("Â∑≤Ë¶ÜÁõñ‰ªäÊó•ËÆ∞ÂΩï");
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), newDoc);
                    showToast("‰ΩìÈáçËÆ∞ÂΩïÊàêÂäü");
                }
                
                // Ê∏ÖÁ©∫ËæìÂÖ•
                els.inputWeight.value = "";
                
                // Âà∑Êñ∞Êï∞ÊçÆÂπ∂ÂàáÂõûÈ¶ñÈ°µ
                await fetchLogs();
                switchView('home');
            } catch (e) {
                console.error("Error adding document: ", e);
                showToast("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // 4. ‰øùÂ≠òÈ•ÆÈ£ü/ËÆ°ÁÆóÁªìÊûú (ÂÜôÂÖ•)
        window.saveFoodLog = async () => {
            if (!els.calcInput) {
                showToast("ËØ•ÁâàÊú¨Êú™ÂêØÁî®ÁÉ≠ÈáèËæìÂÖ•");
                return;
            }
            const kcal = parseFloat(els.calcInput.value);
            if (!kcal) return;

            const runMins = Math.round((kcal / 100) * 9);
            const dumbbellMins = Math.round((kcal / 100) * 15);
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            const newDoc = {
                date: dateStr,
                type: "food",
                value: kcal, // Â≠òÁÉ≠Èáè
                note: `ÊëÑÂÖ• ${kcal} Kcal (Ë∑ëÊ≠•Á∫¶ ${runMins} ÂàÜÈíü / ÂìëÈìÉÁ∫¶ ${dumbbellMins} ÂàÜÈíü)`,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, COLLECTION_NAME), newDoc);
                showToast("È•ÆÈ£üËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò");
                els.calcInput.value = "";
                els.calcRun.innerText = "0";
                els.calcDumbbell.innerText = "0";
                await fetchLogs(); // ÂêéÂè∞Âà∑Êñ∞
            } catch (e) {
                showToast("‰øùÂ≠òÂ§±Ë¥•");
            }
        };

        // 5. ËÆ°ÁÆóÂô®ÈÄªËæë
        els.calcInput?.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if(val) {
                // 200gËãπÊûú=100kcal=Ë∑ëÊ≠•9ÂàÜÈíü
                // ÊØî‰æãÔºö100kcal = 9 mins
                const run = (val / 100) * 9;
                const dumbbell = (val / 100) * 15; // Á≤óÁï•‰º∞ÁÆó
                els.calcRun.innerText = Math.round(run);
                els.calcDumbbell.innerText = Math.round(dumbbell);
            } else {
                els.calcRun.innerText = 0;
                els.calcDumbbell.innerText = 0;
            }
        });

        // 6.1 È£üÊùêÂçï‰ΩçÂàáÊç¢
        window.setFoodUnit = (unit) => {
            appData.foodUnit = unit;
            const gBtn = document.getElementById('btn-unit-g');
            const mlBtn = document.getElementById('btn-unit-ml');
            if (unit === 'g') {
                gBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600";
                mlBtn.className = "px-3 py-1 rounded-md text-gray-500";
            } else {
                mlBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600";
                gBtn.className = "px-3 py-1 rounded-md text-gray-500";
            }
        };

        // 6.2 ÁÉ≠ÈáèÂçï‰ΩçÂàáÊç¢
        window.setFoodHeatUnit = (unit) => {
            appData.foodHeatUnit = unit;
            const kcalBtn = document.getElementById('btn-heat-kcal');
            const kjBtn = document.getElementById('btn-heat-kj');
            if (unit === 'kcal') {
                kcalBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600 border border-emerald-100";
                kjBtn.className = "px-3 py-1 rounded-md text-gray-500 border border-gray-200";
            } else {
                kjBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600 border border-emerald-100";
                kcalBtn.className = "px-3 py-1 rounded-md text-gray-500 border border-gray-200";
            }
        };

        // 5.2 ËÆ°ÁÆóÈ£üÊùêÁÉ≠ÈáèÔºàÂü∫Á°ÄÈÄªËæëÔºåÊîØÊåÅ‰ªÖËÆ°ÁÆó/ËÆ°ÁÆóÂπ∂ËÆ∞ÂΩïÔºâ
        function calcFoodBase() {
            const name = (els.foodName.value || 'Êú™ÂëΩÂêçÈ£üÊùê').trim();
            const amount = parseFloat(els.foodAmount.value);
            const per100 = parseFloat(els.foodUnitKcal.value);
            if (!amount || !per100) {
                showToast("ËØ∑Â°´ÂÜôÊï∞ÈáèÂíåÂçï‰ΩçÁÉ≠Èáè");
                return null;
            }
            const totalPer100 = (amount * per100) / 100;
            const isKjPer100 = appData.foodHeatUnit === 'kj';
            // kJ -> kcal Êåâ 4.184 Êç¢ÁÆóÔºõkcal Áõ¥Êé•‰ΩøÁî®
            const totalKcalRaw = isKjPer100 ? (totalPer100 / 4.184) : totalPer100;
            const totalKcalInt = Math.round(totalKcalRaw);
            els.foodTotal.innerText = String(totalKcalInt);

            // ËøêÂä®ÊäòÁÆóÔºöË∑ëÊ≠•/Ë∑≥Áª≥/ÂìëÈìÉ
            const run = (totalKcalInt / 100) * 9;
            const rope = (totalKcalInt / 100) * 7;
            const dumbbell = (totalKcalInt / 100) * 15;
            const runInt = Math.round(run);
            const ropeInt = Math.round(rope);
            const dumbbellInt = Math.round(dumbbell);
            els.calcRun.innerText = runInt;
            els.calcRope.innerText = ropeInt;
            els.calcDumbbell.innerText = dumbbellInt;

            return {
                name,
                amount,
                per100,
                isKjPer100,
                totalKcalInt,
                runInt,
                ropeInt,
                dumbbellInt
            };
        }

        // ‰ªÖËÆ°ÁÆóÔºà‰∏çÂÖ•Â∫ìÔºâ
        window.calcFoodOnly = () => {
            const result = calcFoodBase();
            if (!result) return;
        };

        // ËÆ°ÁÆóÂπ∂ËÆ∞ÂΩïÈ£üÊùêÁÉ≠Èáè
        window.calcFoodKcal = async () => {
            const result = calcFoodBase();
            if (!result) return;

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).toString().padStart(2,'0')}:${String(now.getMinutes()).toString().padStart(2,'0')}`;

            const newDoc = {
                date: dateStr,
                type: "food_calc",
                value: result.totalKcalInt,
                note: `${result.name} ¬∑ ${result.amount}${appData.foodUnit} ¬∑ ${result.per100}${result.isKjPer100 ? 'kJ' : 'kcal'}/100${appData.foodUnit} ¬∑ Ë∑ë${result.runInt}ÂàÜ / Áª≥${result.ropeInt}ÂàÜ / Âìë${result.dumbbellInt}ÂàÜ`,
                foodName: result.name,
                amount: result.amount,
                unit: appData.foodUnit,
                per100: result.per100,
                per100Unit: result.isKjPer100 ? 'kJ' : 'kcal',
                run: result.runInt,
                rope: result.ropeInt,
                dumbbell: result.dumbbellInt,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };
            try {
                await addDoc(collection(db, COLLECTION_NAME), newDoc);
                showToast("Â∑≤ËÆ∞ÂΩïÈ£üÊùêÁÉ≠Èáè");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
            }
        };

        // 5.3 Ê∏≤ÊüìÈ£üÊùêÁÉ≠ÈáèÂéÜÂè≤
        function renderCalcHistory() {
            const wrap = els.calcHistory;
            wrap.innerHTML = "";
            const items = appData.logs.filter(l => l.type === 'food_calc').slice(0, 30);
            if (!items.length) {
                wrap.innerHTML = '<div class="text-center text-gray-400 py-4">ÊöÇÊó†ÂéÜÂè≤</div>';
                return;
            }
            items.forEach(item => {
                const subtitle = item.note || `${item.foodName || 'È£üÊùê'} ¬∑ ${item.amount || '-'}${item.unit || ''}`;
                const row = document.createElement('div');
                row.className = "border border-gray-100 rounded-2xl p-4 flex items-center justify-between shadow-sm";
                row.innerHTML = `
                    <div>
                        <p class="text-base font-semibold text-gray-900">${item.foodName || 'È£üÊùê'} ‚âà ${item.value} kcal</p>
                        <p class="text-xs text-gray-500 mt-1">${subtitle}</p>
                        <p class="text-[11px] text-gray-400 mt-1">${formatDate(item.date || item.timestamp)}</p>
                    </div>
                    <button class="text-red-500 text-sm px-3 py-2 rounded-lg hover:bg-red-50" onclick="deleteHistoryItem('${item.id}', this)">Âà†Èô§</button>
                `;
                wrap.appendChild(row);
            });
        }

        // 5.4 Âà†Èô§ÂçïÊù°ÂéÜÂè≤
        window.deleteHistoryItem = async (id, btnEl) => {
            try {
                if (btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                showToast("Â∑≤Âà†Èô§");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("Âà†Èô§Â§±Ë¥•");
            } finally {
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.innerText = 'Âà†Èô§';
                }
            }
        };

        // Âà†Èô§ÂçïÊù°‰ΩìÈáçËÆ∞ÂΩï
        window.deleteWeightItem = async (id, btnEl) => {
            try {
                const ok = confirm('Á°ÆÂÆöÂà†Èô§ËøôÊù°‰ΩìÈáçËÆ∞ÂΩïÂêóÔºü');
                if (!ok) return;
                if (btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                showToast("Â∑≤Âà†Èô§");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("Âà†Èô§Â§±Ë¥•");
            } finally {
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.innerText = 'Âà†Èô§';
                }
            }
        };

        // 5.5 Ê∏ÖÁ©∫ÂéÜÂè≤
        window.clearCalcHistory = async () => {
            try {
                const snap = await getDocs(collection(db, COLLECTION_NAME));
                const targets = snap.docs.filter(d => d.data().type === 'food_calc');
                await Promise.all(targets.map(d => deleteDoc(doc(db, COLLECTION_NAME, d.id))));
                showToast("Â∑≤Ê∏ÖÁ©∫ÂéÜÂè≤");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("Ê∏ÖÁ©∫Â§±Ë¥•");
            }
        };

        // 5.6 ÊâãÂä®Âà∑Êñ∞ÂéÜÂè≤
        window.refreshCalcHistory = () => {
            renderCalcHistory();
        };

        // 6. ÂõæË°®ÈÄªËæë
        function syncTrendLabels() {
            if (appData.trendMode === 'weight') {
                if (els.trendModeDesc) els.trendModeDesc.innerText = '‰ΩìÈáçÊõ≤Á∫ø ¬∑ ‰ªÖÊó©Êô®ËÆ∞ÂΩï';
                if (els.trendCardLabel1) els.trendCardLabel1.innerText = 'ÂΩìÂâç‰ΩìÈáç';
                if (els.trendCardLabel2) els.trendCardLabel2.innerText = 'Âå∫Èó¥ÂèòÂåñ';
                if (els.statMaxLabel) els.statMaxLabel.innerText = 'ÊúÄÈ´ò‰ΩìÈáç';
                if (els.statMinLabel) els.statMinLabel.innerText = 'ÊúÄ‰Ωé‰ΩìÈáç';
            } else {
                if (els.trendModeDesc) els.trendModeDesc.innerText = '‰ª£Ë∞¢Êõ≤Á∫ø ¬∑ Êò®ÊôöÂáèÊ¨°Êô®ÔºåÂçï‰ΩçÊñ§';
                if (els.trendCardLabel1) els.trendCardLabel1.innerText = 'ÂΩìÂâç‰ª£Ë∞¢';
                if (els.trendCardLabel2) els.trendCardLabel2.innerText = 'Âå∫Èó¥‰ª£Ë∞¢ÂèòÂåñ';
                if (els.statMaxLabel) els.statMaxLabel.innerText = 'ÊúÄÈ´ò‰ª£Ë∞¢';
                if (els.statMinLabel) els.statMinLabel.innerText = 'ÊúÄ‰Ωé‰ª£Ë∞¢';
            }
        }

        window.setTrendMode = (mode) => {
            appData.trendMode = mode === 'metabolic' ? 'metabolic' : 'weight';
            if (els.trendBtnWeight && els.trendBtnMetabolic) {
                if (appData.trendMode === 'weight') {
                    els.trendBtnWeight.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnWeight.classList.remove('text-gray-600', 'hover:bg-gray-50');
                    els.trendBtnMetabolic.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnMetabolic.classList.add('text-gray-600', 'hover:bg-gray-50');
                } else {
                    els.trendBtnMetabolic.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnMetabolic.classList.remove('text-gray-600', 'hover:bg-gray-50');
                    els.trendBtnWeight.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnWeight.classList.add('text-gray-600', 'hover:bg-gray-50');
                }
            }

            syncTrendLabels();

            // ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçÂå∫Èó¥
            if (typeof window.filterChart === 'function') window.filterChart(appData.trendRange || 30);
        };

        window.filterChart = (days) => {
            appData.trendRange = days;
            // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => {
                const range = parseInt(b.dataset.range);
                if (range === days) {
                    b.classList.remove('bg-white', 'text-gray-600', 'border', 'border-gray-200');
                    b.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-sm');
                } else {
                    b.classList.add('bg-white', 'text-gray-600', 'border', 'border-gray-200');
                    b.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-sm');
                }
            });

            renderChart(days);
        };

        function formatJin(valKg) {
            const n = Number(valKg);
            if (!Number.isFinite(n)) return '--';
            return (n * 2).toFixed(2);
        }

        function getYmdFromMs(ms) {
            const d = new Date(ms);
            return getYmd(d);
        }

        function getPrevYmd(ms) {
            const d = new Date(ms);
            d.setDate(d.getDate() - 1);
            return getYmd(d);
        }

        function pickLatestByDate(logs, period) {
            const map = {};
            logs
                .filter(l => normalizePeriod(l) === period)
                .forEach(l => {
                    const ms = getLogDateMs(l);
                    const ymd = getYmdFromMs(ms);
                    if (!map[ymd] || ms > map[ymd].ms) {
                        map[ymd] = { ...l, __ms: ms };
                    }
                });
            return map;
        }

        function renderChart(days) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const cutoffMs = days !== 999 ? (() => {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                return cutoff.getTime();
            })() : null;
            const unitLabel = appData.trendMode === 'metabolic' ? 'Êñ§' : 'kg';
            
            const allWeights = getWeightLogs('all').sort((a, b) => getLogDateMs(a) - getLogDateMs(b));
            let dataPoints = [];
            let labels = [];
            let values = [];

            if (appData.trendMode === 'weight') {
                const weightData = allWeights
                    .filter(l => normalizePeriod(l) === 'morning')
                    .filter(d => !cutoffMs || getLogDateMs(d) >= cutoffMs);

                labels = weightData.map(d => {
                    const date = new Date(getLogDateMs(d));
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });
                values = weightData.map(d => Number(d.value));
                dataPoints = weightData.map(d => ({ ms: getLogDateMs(d), value: Number(d.value), raw: d }));
            } else {
                const morningMap = pickLatestByDate(allWeights, 'morning');
                const nightMap = pickLatestByDate(allWeights, 'night');
                const mornings = Object.values(morningMap).sort((a, b) => a.__ms - b.__ms);

                mornings.forEach(m => {
                    if (cutoffMs && m.__ms < cutoffMs) return;
                    const prevNight = nightMap[getPrevYmd(m.__ms)];
                    if (!prevNight) return;
                    const diffJin = Number(((Number(prevNight.value) - Number(m.value)) * 2).toFixed(2));
                    labels.push(`${(new Date(m.__ms)).getMonth() + 1}/${(new Date(m.__ms)).getDate()}`);
                    values.push(diffJin);
                    dataPoints.push({ ms: m.__ms, value: diffJin, raw: m, prev: prevNight });
                });
            }

            // Êõ¥Êñ∞Ë∂ãÂäøÂå∫Èó¥Âç°Áâá
            if (els.trendCurrentWeight && els.trendCurrentTime && els.trendChange && els.trendChangeBadge) {
                const rangeText = days === 999 ? 'ÂÖ®ÈÉ®ÂéÜÂè≤' : `ÊúÄËøë${days}Â§©`;
                if (!dataPoints.length) {
                    els.trendCurrentWeight.innerText = '--';
                    els.trendCurrentTime.innerText = '--';
                    els.trendChange.innerText = '--';
                    if (els.trendChangeDesc) els.trendChangeDesc.innerText = `${rangeText} ¬∑ ÊöÇÊó†ËÆ∞ÂΩï`;
                    els.trendChangeBadge.innerText = '-';
                    els.trendChangeBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                } else {
                    const first = dataPoints[0];
                    const last = dataPoints[dataPoints.length - 1];
                    els.trendCurrentWeight.innerText = `${last.value.toFixed(2)} ${unitLabel}`;
                    els.trendCurrentTime.innerText = formatDate(last.raw?.date || last.raw?.timestamp || last.ms);

                    const diff = Number(last.value) - Number(first.value);
                    const sign = diff > 0 ? '+' : '';
                    els.trendChange.innerText = `${sign}${diff.toFixed(2)} ${unitLabel}`;
                    if (diff > 0) {
                        els.trendChangeBadge.innerText = appData.trendMode === 'weight' ? '‰∏äÂçá' : 'Â¢ûÂä†';
                        els.trendChangeBadge.className = appData.trendMode === 'weight'
                            ? 'bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full'
                            : 'bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full';
                    } else if (diff < 0) {
                        els.trendChangeBadge.innerText = appData.trendMode === 'weight' ? '‰∏ãÈôç' : 'ÂáèÂ∞ë';
                        els.trendChangeBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                    } else {
                        els.trendChangeBadge.innerText = 'ÊåÅÂπ≥';
                        els.trendChangeBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                    }

                    const firstTime = formatDate(first.raw?.date || first.raw?.timestamp || first.ms);
                    const lastTime = formatDate(last.raw?.date || last.raw?.timestamp || last.ms);
                    if (els.trendChangeDesc) {
                        els.trendChangeDesc.innerText = dataPoints.length === 1
                            ? `${rangeText} ¬∑ ${firstTime}Ôºà‰ªÖ1Êù°Ôºâ`
                            : `${rangeText} ¬∑ ${firstTime} ‚Üí ${lastTime}`;
                    }
                }
            }

            // Êõ¥Êñ∞ÁªüËÆ°
            const statUnit = appData.trendMode === 'metabolic' ? 'Êñ§' : 'kg';
            if(values.length > 0) {
                document.getElementById('stat-max').innerText = `${Math.max(...values).toFixed(2)} ${statUnit}`;
                document.getElementById('stat-min').innerText = `${Math.min(...values).toFixed(2)} ${statUnit}`;
            } else {
                document.getElementById('stat-max').innerText = '--';
                document.getElementById('stat-min').innerText = '--';
            }

            // ÈîÄÊØÅÊóßÂõæË°®
            if (chartInstance) chartInstance.destroy();

            // ÂàõÂª∫Êñ∞ÂõæË°®
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: appData.trendMode === 'weight' ? '‰ΩìÈáç (kg)' : '‰ª£Ë∞¢ (Êñ§)',
                        data: values,
                        borderColor: appData.trendMode === 'weight' ? '#059669' : '#f97316',
                        backgroundColor: appData.trendMode === 'weight' ? 'rgba(16, 185, 129, 0.12)' : 'rgba(249, 115, 22, 0.12)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: appData.trendMode === 'weight' ? '#059669' : '#f97316',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4 // Âπ≥ÊªëÊõ≤Á∫ø
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 7,
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: { borderDash: [5, 5], color: '#f3f4f6' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // ================= ÂàùÂßãÂåñ =================
        const init = () => {
            fetchLogs();
            // ÁªëÂÆö Tab ÂàáÊç¢ÁÇπÂáª‰∫ã‰ª∂Â∑≤Âú® HTML onclick ‰∏≠Â§ÑÁêÜ
            // ÁªëÂÆö Toast ‰∫ã‰ª∂Â∑≤Âú® HTML onclick ‰∏≠Â§ÑÁêÜ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeWeightHistoryModal();
                }
            });
        };

        init();

    </script>
</body>
</html>
