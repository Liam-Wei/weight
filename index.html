<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iDiet Pro</title>

    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="MyWebSite" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* iOS ç³»ç»Ÿå­—ä½“æ ˆ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", sans-serif;
            /* é˜²æ­¢iOSç‚¹å‡»é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* åº•éƒ¨å®‰å…¨åŒºåŸŸé€‚é… */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* å»é™¤æŒ‰é’®ç„¦ç‚¹å’Œè§¦æ‘¸æ ·å¼ï¼Œç¡®ä¿é€‰ä¸­çŠ¶æ€æ­£ç¡®æ˜¾ç¤º */
        .workout-btn-morning-cardio,
        .workout-btn-morning-strength,
        .workout-btn-evening-cardio,
        .workout-btn-evening-strength,
        .workout-btn-night-cardio,
        .workout-btn-night-strength,
        .workout-time-btn,
        .workout-cardio-btn,
        .workout-strength-btn {
            -webkit-tap-highlight-color: transparent;
            outline: none !important;
        }
        .workout-btn-morning-cardio:focus,
        .workout-btn-morning-strength:focus,
        .workout-btn-evening-cardio:focus,
        .workout-btn-evening-strength:focus,
        .workout-btn-night-cardio:focus,
        .workout-btn-night-strength:focus,
        .workout-btn-morning-cardio:active,
        .workout-btn-morning-strength:active,
        .workout-btn-evening-cardio:active,
        .workout-btn-evening-strength:active,
        .workout-btn-night-cardio:active,
        .workout-btn-night-strength:active,
        .workout-time-btn:focus,
        .workout-time-btn:active,
        .workout-cardio-btn:focus,
        .workout-cardio-btn:active,
        .workout-strength-btn:focus,
        .workout-strength-btn:active {
            outline: none !important;
            box-shadow: none !important;
        }
        /* é€‰ä¸­çŠ¶æ€æ ·å¼ - ä½¿ç”¨ !important ç¡®ä¿ä¼˜å…ˆçº§ */
        .workout-btn-selected {
            background-color: var(--selected-bg) !important;
            color: white !important;
            border-color: var(--selected-border) !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden flex flex-col">

    <div class="h-12 w-full bg-transparent shrink-0"></div>

    <main id="main-container" class="flex-1 overflow-y-auto no-scrollbar px-6 pb-32 relative">
        
        <section id="view-home" class="view-section fade-in">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">å¥åº·æ¦‚è§ˆ</h1>
                    <p class="text-sm text-gray-500" id="current-date">åŠ è½½ä¸­...</p>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center text-white shadow-lg shadow-emerald-200">
                    <i class="fas fa-heartbeat text-lg"></i>
                </div>
            </header>

            <!-- æœ€æ–°ä½“é‡å¡ç‰‡ -->
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-3xl p-6 shadow-lg shadow-emerald-200/50 mb-5">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                            <i class="fas fa-weight text-white text-sm"></i>
                        </div>
                        <span class="text-emerald-100 font-medium text-sm">æœ€æ–°ä½“é‡</span>
                    </div>
                    <span class="bg-white/20 text-white text-xs px-2.5 py-1 rounded-full backdrop-blur-sm" id="weight-trend-badge">-</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <span id="display-weight" class="text-5xl font-extrabold text-white">--</span>
                    <span class="text-xl text-emerald-100">kg</span>
                </div>
                <p class="text-xs text-emerald-100/80 mt-2" id="last-record-time">æš‚æ— è®°å½•</p>
            </div>

            <!-- BMI å’Œä½“é‡å˜åŒ– -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="bg-gradient-to-br from-blue-50 to-white rounded-3xl p-5 shadow-sm border border-blue-100">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-7 h-7 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-chart-pie text-blue-600 text-xs"></i>
                        </div>
                        <p class="text-blue-700 text-sm font-medium">BMI æŒ‡æ•°</p>
                    </div>
                    <h3 id="display-bmi" class="text-3xl font-bold text-gray-900">--</h3>
                    <p id="bmi-status" class="text-xs mt-1 text-blue-600">æœªçŸ¥</p>
                    <p id="bmi-next" class="text-[11px] text-gray-500 mt-1"></p>
                    <div class="mt-3">
                        <div class="relative h-2.5">
                            <div class="absolute inset-0 rounded-full overflow-hidden grid grid-cols-4">
                                <div class="bg-sky-300"></div>
                                <div class="bg-emerald-300"></div>
                                <div class="bg-amber-300"></div>
                                <div class="bg-rose-300"></div>
                            </div>
                            <div id="bmi-progress-indicator" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-white border-2 border-blue-600 shadow-md transition-all duration-300" style="left: 0%;"></div>
                        </div>
                        <div class="grid grid-cols-4 text-[10px] text-gray-500 mt-2 leading-4 text-center gap-1">
                            <span class="whitespace-nowrap">åç˜¦</span>
                            <span class="whitespace-nowrap">æ­£å¸¸</span>
                            <span class="whitespace-nowrap">è¿‡é‡</span>
                            <span class="whitespace-nowrap">è‚¥èƒ–</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-white rounded-3xl p-5 shadow-sm border border-purple-100 flex flex-col">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-7 h-7 rounded-lg bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-purple-600 text-xs"></i>
                        </div>
                        <p class="text-purple-700 text-sm font-medium">ä½“é‡å˜åŒ–</p>
                    </div>
                    <h3 id="weight-change" class="text-2xl font-bold text-gray-900">--</h3>
                    <p id="weight-change-desc" class="text-xs text-gray-400 mt-1">ç­‰å¾…æ–°è®°å½•</p>
                    <p id="weight-change-extra" class="text-xs text-gray-400 mt-auto">--</p>
                </div>
            </div>

            <!-- è®°å½•ä½“é‡å¡ç‰‡ -->
            <div class="bg-gradient-to-br from-amber-50 to-white rounded-3xl p-5 shadow-sm mb-5 border border-amber-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-xl bg-amber-100 flex items-center justify-center">
                            <i class="fas fa-pen text-amber-600 text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900">è®°å½•ä½“é‡</h3>
                    </div>
                    <div class="flex bg-gray-100 rounded-xl p-1 shrink-0">
                        <button onclick="setUnit('kg')" id="btn-unit-kg" class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all bg-white shadow text-amber-600">KG</button>
                        <button onclick="setUnit('jin')" id="btn-unit-jin" class="px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-500 transition-all">æ–¤</button>
                    </div>
                </div>

                <div class="flex bg-amber-100/50 rounded-xl p-1 mb-4">
                    <button onclick="setWeightPeriod('morning')" id="btn-period-morning" class="flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600">ğŸŒ… æ—©æ™¨ç©ºè…¹</button>
                    <button onclick="setWeightPeriod('night')" id="btn-period-night" class="flex-1 px-3 py-2 rounded-lg text-sm font-medium text-gray-500 transition-all">ğŸŒ™ æ™šé—´ç¡å‰</button>
                </div>

                <div class="flex items-center bg-white rounded-2xl border-2 border-amber-200 px-4 py-3 mb-4">
                    <input type="number" id="input-weight" step="0.01" placeholder="0.00" class="w-full text-4xl font-bold bg-transparent outline-none text-gray-900">
                    <span class="text-xl text-gray-400 ml-2">kg</span>
                </div>

                <button onclick="saveWeight()" id="btn-save-weight" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-amber-200 active:scale-95 transition-transform flex justify-center items-center gap-2 hover:shadow-xl">
                    <i class="fas fa-check"></i>
                    <span>ä¿å­˜è®°å½•</span>
                </button>
            </div>

            <!-- æœ€è¿‘è®°å½• -->
            <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-3xl p-5 shadow-sm border border-indigo-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center shadow-sm">
                            <i class="fas fa-clock-rotate-left text-white text-sm"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">æœ€è¿‘è®°å½•</h3>
                            <p class="text-[10px] text-gray-500">è¿‘7å¤©æ•°æ®</p>
                        </div>
                    </div>
                    <button onclick="switchView('trend')" class="text-xs text-indigo-500 hover:text-indigo-700 flex items-center gap-1 transition-all">
                        æŸ¥çœ‹æ›´å¤š <i class="fas fa-chevron-right text-[10px]"></i>
                    </button>
                </div>
                <ul id="recent-list" class="space-y-3">
                    <li class="text-center text-gray-400 py-4">æ­£åœ¨ä»äº‘ç«¯åŠ è½½...</li>
                </ul>
            </div>
        </section>

        <section id="view-record" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold mb-6">æ¯æ—¥å¤‡æ³¨</h2>

            <!-- åˆé¤å¡ç‰‡ -->
            <div class="bg-gradient-to-br from-emerald-50 to-white rounded-3xl p-5 shadow-sm mb-4 border border-emerald-100">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center">
                        <i class="fas fa-sun text-emerald-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">åˆé¤</h3>
                    <span id="status-lunch" class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 ml-auto">æœªå¡«</span>
                </div>
                <div class="flex gap-2 items-center">
                    <textarea id="input-lunch-note" rows="2" placeholder="ä»Šå¤©åˆé¤åƒäº†ä»€ä¹ˆï¼Ÿ" class="flex-1 rounded-2xl border border-emerald-200 bg-white text-gray-900 placeholder-gray-400 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30"></textarea>
                    <button type="button" onclick="saveMealNote('lunch')" class="shrink-0 px-4 py-3 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 active:scale-95 transition-all">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <!-- æ™šé¤å¡ç‰‡ -->
            <div class="bg-gradient-to-br from-amber-50 to-white rounded-3xl p-5 shadow-sm mb-4 border border-amber-100">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center">
                        <i class="fas fa-moon text-amber-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">æ™šé¤</h3>
                    <span id="status-dinner" class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 ml-auto">æœªå¡«</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-3" id="dinner-presets">
                    <button type="button" onclick="selectDinnerPreset(0)" class="dinner-preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-white text-amber-700 border border-amber-200 hover:bg-amber-100 active:scale-95 transition-all">è±†æµ†+é¸¡èƒ¸è‚‰</button>
                    <button type="button" onclick="selectDinnerPreset(1)" class="dinner-preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-white text-amber-700 border border-amber-200 hover:bg-amber-100 active:scale-95 transition-all">è±†æµ†+é¸¡èƒ¸è‚‰+å…¨éº¦è„†</button>
                </div>
                <div class="flex gap-2 items-center">
                    <textarea id="input-dinner-note" rows="2" placeholder="ç‚¹å‡»æ–¹æ¡ˆå¿«é€Ÿå¡«å……ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥" class="flex-1 rounded-2xl border border-amber-200 bg-white text-gray-900 placeholder-gray-400 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/30"></textarea>
                    <button type="button" onclick="saveMealNote('dinner')" class="shrink-0 px-4 py-3 rounded-xl bg-amber-500 text-white text-sm font-semibold hover:bg-amber-600 active:scale-95 transition-all">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <!-- é”»ç‚¼å¡ç‰‡ -->
            <div class="bg-white rounded-3xl p-5 shadow-sm mb-4 border border-gray-100">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-dumbbell text-blue-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">ä»Šæ—¥é”»ç‚¼</h3>
                    <span id="status-workout" class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 ml-auto">æœªå¡«</span>
                </div>
                
                <!-- æ—¶æ®µé€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼‰ -->
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs text-gray-500 font-medium">é€‰æ‹©æ—¶æ®µ</span>
                        <button type="button" onclick="clearAllWorkout()" class="ml-auto text-[10px] text-gray-400 hover:text-red-500 transition-all">å…¨éƒ¨æ¸…ç©º</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="toggleTimeSlot('morning')" class="workout-time-btn py-2 rounded-xl text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200 transition-all text-center" data-slot="morning">ğŸŒ… ä¸Šåˆé¥­å‰</button>
                        <button type="button" onclick="toggleTimeSlot('evening')" class="workout-time-btn py-2 rounded-xl text-xs font-medium bg-orange-50 text-orange-700 border border-orange-200 transition-all text-center" data-slot="evening">ğŸŒ‡ ä¸‹åˆé¥­å‰</button>
                        <button type="button" onclick="toggleTimeSlot('night')" class="workout-time-btn py-2 rounded-xl text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200 transition-all text-center" data-slot="night">ğŸŒ™ ä¸‹åˆé¥­å</button>
                    </div>
                </div>

                <!-- æœ‰æ°§é€‰é¡¹ï¼ˆäº’æ–¥ï¼‰ -->
                <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-4 mb-3">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xs font-semibold text-emerald-700">ğŸƒ æœ‰æ°§è¿åŠ¨</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="toggleCardio(0)" class="workout-cardio-btn py-2 rounded-xl text-[11px] font-medium bg-white text-emerald-700 border border-emerald-200 transition-all text-center" data-idx="0">è·³ç»³900</button>
                        <button type="button" onclick="toggleCardio(1)" class="workout-cardio-btn py-2 rounded-xl text-[11px] font-medium bg-white text-emerald-700 border border-emerald-200 transition-all text-center" data-idx="1">è·³ç»³1800</button>
                        <button type="button" onclick="toggleCardio(2)" class="workout-cardio-btn py-2 rounded-xl text-[11px] font-medium bg-white text-emerald-700 border border-emerald-200 transition-all text-center" data-idx="2">è·³ç»³3000</button>
                    </div>
                </div>

                <!-- åŠ›é‡é€‰é¡¹ï¼ˆå¯å¤šé€‰ï¼‰ -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl p-4 mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xs font-semibold text-indigo-700">ğŸ’ª åŠ›é‡è®­ç»ƒ</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button type="button" onclick="toggleStrength(0)" class="workout-strength-btn py-2 rounded-xl text-[11px] font-medium bg-white text-indigo-700 border border-indigo-200 transition-all text-center" data-idx="0">æ·±è¹²60</button>
                        <button type="button" onclick="toggleStrength(1)" class="workout-strength-btn py-2 rounded-xl text-[11px] font-medium bg-white text-indigo-700 border border-indigo-200 transition-all text-center" data-idx="1">å“‘é“ƒå¼¯ä¸¾</button>
                        <button type="button" onclick="toggleStrength(2)" class="workout-strength-btn py-2 rounded-xl text-[11px] font-medium bg-white text-indigo-700 border border-indigo-200 transition-all text-center" data-idx="2">é”¤å¼å¼¯ä¸¾</button>
                        <button type="button" onclick="toggleStrength(3)" class="workout-strength-btn py-2 rounded-xl text-[11px] font-medium bg-white text-indigo-700 border border-indigo-200 transition-all text-center" data-idx="3">çª„è·ä¿¯å§</button>
                        <button type="button" onclick="toggleStrength(4)" class="workout-strength-btn py-2 rounded-xl text-[11px] font-medium bg-white text-indigo-700 border border-indigo-200 transition-all text-center" data-idx="4">ç»³ç´¢ä¸‹å‹</button>
                        <button type="button" onclick="toggleStrength(5)" class="workout-strength-btn py-2 rounded-xl text-[11px] font-medium bg-white text-indigo-700 border border-indigo-200 transition-all text-center" data-idx="5">ç»³ç´¢å¼¯ä¸¾</button>
                        <button type="button" onclick="toggleStrength(6)" class="workout-strength-btn py-2 rounded-xl text-[11px] font-medium bg-white text-indigo-700 border border-indigo-200 transition-all text-center" data-idx="6">å‚å¼å¼¯ä¸¾</button>
                    </div>
                </div>

                <div class="flex gap-2 items-center">
                    <textarea id="input-workout-note" rows="2" placeholder="å…ˆé€‰æ—¶æ®µï¼Œå†é€‰è¿åŠ¨ï¼Œè‡ªåŠ¨ç”Ÿæˆå¤‡æ³¨" class="flex-1 rounded-2xl border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/30"></textarea>
                    <button type="button" onclick="saveMealNote('workout')" class="shrink-0 px-4 py-3 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 active:scale-95 transition-all">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="view-trend" class="view-section hidden fade-in">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">è¶‹åŠ¿åˆ†æ</h1>
                    <p class="text-sm text-gray-500">è¿½è¸ªä½ çš„å¥åº·æ•°æ®</p>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-400 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i class="fas fa-chart-line text-lg"></i>
                </div>
            </header>

            <!-- æ¨¡å¼åˆ‡æ¢ -->
            <div class="bg-white rounded-2xl p-2 shadow-sm border border-gray-100 mb-4">
                <div class="flex gap-2">
                    <button id="btn-trend-weight" onclick="setTrendMode('weight')" class="trend-mode-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-semibold bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-sm transition-all">
                        <i class="fas fa-weight mr-1.5"></i>ä½“é‡è¶‹åŠ¿
                    </button>
                    <button id="btn-trend-metabolic" onclick="setTrendMode('metabolic')" class="trend-mode-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-semibold text-gray-600 hover:bg-gray-50 transition-all">
                        <i class="fas fa-fire mr-1.5"></i>ä»£è°¢æ›²çº¿
                    </button>
                </div>
            </div>

            <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
            <div class="flex flex-wrap gap-2 mb-5">
                <button data-range="7" onclick="filterChart(7)" class="filter-btn px-4 py-2 bg-white text-gray-600 rounded-xl text-sm font-medium border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 transition-all">7å¤©</button>
                <button data-range="30" onclick="filterChart(30)" class="filter-btn active px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl text-sm font-medium shadow-sm">30å¤©</button>
                <button data-range="60" onclick="filterChart(60)" class="filter-btn px-4 py-2 bg-white text-gray-600 rounded-xl text-sm font-medium border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 transition-all">60å¤©</button>
                <button data-range="999" onclick="filterChart(999)" class="filter-btn px-4 py-2 bg-white text-gray-600 rounded-xl text-sm font-medium border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 transition-all">å…¨éƒ¨</button>
            </div>

            <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="bg-gradient-to-br from-indigo-50 to-white rounded-3xl p-5 shadow-sm border border-indigo-100">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-7 h-7 rounded-lg bg-indigo-100 flex items-center justify-center">
                            <i class="fas fa-weight text-indigo-600 text-xs"></i>
                        </div>
                        <p id="trend-card-label-1" class="text-indigo-700 text-sm font-medium">å½“å‰ä½“é‡</p>
                    </div>
                    <h3 id="trend-current-weight" class="text-2xl font-bold text-gray-900">--</h3>
                    <p id="trend-current-time" class="text-xs text-gray-400 mt-1">--</p>
                </div>
                <div class="bg-gradient-to-br from-emerald-50 to-white rounded-3xl p-5 shadow-sm border border-emerald-100">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-lg bg-emerald-100 flex items-center justify-center">
                                <i class="fas fa-arrow-trend-down text-emerald-600 text-xs"></i>
                            </div>
                            <p id="trend-card-label-2" class="text-emerald-700 text-sm font-medium">åŒºé—´å˜åŒ–</p>
                        </div>
                        <span class="bg-emerald-100 text-emerald-600 text-xs px-2 py-0.5 rounded-full" id="trend-change-badge">-</span>
                    </div>
                    <h3 id="trend-change" class="text-2xl font-bold text-gray-900">--</h3>
                </div>
            </div>

            <!-- å›¾è¡¨å¡ç‰‡ -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-5">
                <div class="h-72 relative">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl p-4 border border-orange-100">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-6 h-6 rounded-lg bg-orange-100 flex items-center justify-center">
                            <i class="fas fa-arrow-up text-orange-500 text-xs"></i>
                        </div>
                        <p id="stat-max-label" class="text-orange-600 text-xs font-semibold">æœ€é«˜ä½“é‡</p>
                    </div>
                    <p id="stat-max" class="text-xl font-bold text-gray-900">--</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-white rounded-2xl p-4 border border-green-100">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-6 h-6 rounded-lg bg-green-100 flex items-center justify-center">
                            <i class="fas fa-arrow-down text-green-500 text-xs"></i>
                        </div>
                        <p id="stat-min-label" class="text-green-600 text-xs font-semibold">æœ€ä½ä½“é‡</p>
                    </div>
                    <p id="stat-min" class="text-xl font-bold text-gray-900">--</p>
                </div>
            </div>

            <!-- æŸ¥çœ‹å†å²æŒ‰é’® -->
            <button onclick="openWeightHistoryModal()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex justify-center items-center gap-2 hover:shadow-xl">
                <i class="fas fa-history"></i>
                <span>æŸ¥çœ‹å…¨éƒ¨å†å²</span>
            </button>
        </section>

        <section id="view-calc" class="view-section hidden fade-in">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">çƒ­é‡æ¢ç®—</h1>
                    <p class="text-sm text-gray-500">è®¡ç®—é£Ÿç‰©çƒ­é‡ä¸è¿åŠ¨æ¶ˆè€—</p>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-rose-400 to-orange-500 flex items-center justify-center text-white shadow-lg shadow-rose-200">
                    <i class="fas fa-fire text-lg"></i>
                </div>
            </header>
            
            <!-- çƒ­é‡è®¡ç®—å¡ç‰‡ -->
            <div class="bg-gradient-to-br from-rose-50 to-white rounded-3xl p-5 shadow-sm mb-5 border border-rose-100">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-xl bg-rose-100 flex items-center justify-center">
                        <i class="fas fa-utensils text-rose-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">é£Ÿæçƒ­é‡è®¡ç®—</h3>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">é£Ÿå“åç§°</label>
                        <input id="food-name" type="text" placeholder="å¦‚ï¼šç‡•éº¦å¥¶" class="w-full rounded-xl border border-rose-200 bg-white text-gray-900 placeholder-gray-400 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-rose-500/30" />
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">æ•°é‡ (g/ml)</label>
                            <input id="food-amount" type="number" inputmode="decimal" placeholder="250" class="w-full rounded-xl border border-rose-200 bg-white text-gray-900 placeholder-gray-400 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-rose-500/30" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">çƒ­é‡ (kJ/100g)</label>
                            <input id="food-unit-kcal" type="number" inputmode="decimal" placeholder="54" class="w-full rounded-xl border border-rose-200 bg-white text-gray-900 placeholder-gray-400 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-rose-500/30" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®¡ç®—ç»“æœå¡ç‰‡ -->
            <div class="bg-gradient-to-br from-orange-50 to-white rounded-3xl p-5 shadow-sm mb-5 border border-orange-100">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-xl bg-orange-100 flex items-center justify-center">
                        <i class="fas fa-fire-flame-curved text-orange-600 text-sm"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">è®¡ç®—ç»“æœ</h3>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-rose-500 rounded-2xl p-4 mb-4">
                    <p class="text-orange-100 text-xs mb-1">é¢„ä¼°æ€»çƒ­é‡</p>
                    <div class="flex items-baseline gap-1">
                        <span class="text-4xl font-bold text-white" id="food-total-kcal">0</span>
                        <span class="text-orange-100 text-sm">kcal</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white rounded-xl p-3 text-center border border-orange-100">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-running text-blue-600 text-sm"></i>
                        </div>
                        <p class="text-[11px] text-gray-500">è·‘æ­¥</p>
                        <p class="text-lg font-bold text-gray-900"><span id="calc-run">0</span><span class="text-xs text-gray-400">åˆ†é’Ÿ</span></p>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center border border-orange-100">
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-child text-green-600 text-sm"></i>
                        </div>
                        <p class="text-[11px] text-gray-500">è·³ç»³</p>
                        <p class="text-lg font-bold text-gray-900"><span id="calc-rope">0</span><span class="text-xs text-gray-400">åˆ†é’Ÿ</span></p>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center border border-orange-100">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-dumbbell text-purple-600 text-sm"></i>
                        </div>
                        <p class="text-[11px] text-gray-500">å“‘é“ƒ</p>
                        <p class="text-lg font-bold text-gray-900"><span id="calc-dumbbell">0</span><span class="text-xs text-gray-400">åˆ†é’Ÿ</span></p>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="grid grid-cols-2 gap-3 mb-5">
                <button onclick="calcFoodOnly()" class="h-14 rounded-2xl bg-white text-rose-600 font-semibold shadow-sm border border-rose-200 active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-rose-50">
                    <i class="fas fa-calculator"></i> è®¡ç®—
                </button>
                <button onclick="calcFoodKcal()" class="h-14 rounded-2xl bg-gradient-to-r from-rose-500 to-orange-500 text-white font-semibold shadow-lg shadow-rose-200 active:scale-95 transition-transform flex items-center justify-center gap-2 hover:shadow-xl">
                    <i class="fas fa-plus"></i> è®°å½•
                </button>
            </div>

            <!-- å†å²æŸ¥è¯¢åˆ—è¡¨ -->
            <div class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-xl bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-history text-gray-600 text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900">å†å²è®°å½•</h3>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshCalcHistory()" class="text-gray-600 text-xs px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 transition-all">
                            <i class="fas fa-sync-alt mr-1"></i>åˆ·æ–°
                        </button>
                        <button onclick="clearCalcHistory()" class="text-rose-600 text-xs px-3 py-1.5 rounded-lg bg-rose-50 hover:bg-rose-100 transition-all">
                            <i class="fas fa-trash mr-1"></i>æ¸…ç©º
                        </button>
                    </div>
                </div>
                <div id="calc-history" class="space-y-3 text-sm text-gray-700">
                    <div class="text-center text-gray-400 py-4">æš‚æ— å†å²</div>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-200 pb-safe z-50">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchView('home')" class="nav-btn text-emerald-600 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[10px] font-medium">é¦–é¡µ</span>
            </button>
            <button onclick="switchView('record')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="record">
                <i class="fas fa-pen text-xl"></i>
                <span class="text-[10px] font-medium">è®°å½•</span>
            </button>
            <button onclick="switchView('trend')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="trend">
                <i class="fas fa-chart-line text-xl"></i>
                <span class="text-[10px] font-medium">è¶‹åŠ¿</span>
            </button>
            <button onclick="switchView('calc')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="calc">
                <i class="fas fa-calculator text-xl"></i>
                <span class="text-[10px] font-medium">è®¡ç®—</span>
            </button>
        </div>
    </nav>

    <div id="weight-history-modal" class="fixed inset-0 hidden z-[60]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeWeightHistoryModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-lg sm:rounded-3xl rounded-t-3xl shadow-xl max-h-[85vh] flex flex-col">
                <!-- å¤´éƒ¨ -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-history"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">ä½“é‡å†å²</h3>
                                <p class="text-xs text-gray-500">æŸ¥çœ‹å…¨éƒ¨è®°å½•</p>
                            </div>
                        </div>
                        <button class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition-all" onclick="closeWeightHistoryModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- æ—¶æ®µç­›é€‰ -->
                    <div id="weight-history-tabs" class="flex gap-2 mb-3">
                        <button onclick="setWeightHistoryFilter('morning')" class="flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-sm transition-all">ğŸŒ… æ—©æ™¨</button>
                        <button onclick="setWeightHistoryFilter('night')" class="flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">ğŸŒ™ æ™šé—´</button>
                        <button onclick="setWeightHistoryFilter('all')" class="flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">å…¨éƒ¨</button>
                    </div>
                    
                    <!-- å¿«æ·å¤åˆ¶ -->
                    <div class="bg-gray-50 rounded-2xl p-3 space-y-2">
                        <div class="flex flex-wrap gap-1.5">
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('7d')">7å¤©</button>
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('1m')">1æœˆ</button>
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('2m')">2æœˆ</button>
                            <button class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:border-indigo-300 hover:text-indigo-600 active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard('all')">å…¨éƒ¨</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="weight-history-copy-range" class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-700 border border-gray-200 focus:outline-none focus:border-indigo-300">
                                <option value="3m">è¿‘3ä¸ªæœˆ</option>
                                <option value="4m">è¿‘4ä¸ªæœˆ</option>
                                <option value="5m">è¿‘5ä¸ªæœˆ</option>
                                <option value="6m">è¿‘åŠå¹´</option>
                                <option value="1y">è¿‘ä¸€å¹´</option>
                                <option value="all">å…¨éƒ¨å†å²</option>
                            </select>
                            <button class="px-4 py-2 rounded-xl text-xs font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-sm active:scale-95 transition-all" onclick="copyWeightHistoryToClipboard(document.getElementById('weight-history-copy-range')?.value || 'all')">
                                <i class="fas fa-copy mr-1"></i>å¤åˆ¶
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all" onclick="downloadWeightHistoryCsv(document.getElementById('weight-history-copy-range')?.value || 'all')">
                                <i class="fas fa-file-csv mr-1 text-green-500"></i>CSV
                            </button>
                            <button class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all" onclick="downloadAllLogsJson()">
                                <i class="fas fa-file-code mr-1 text-blue-500"></i>JSON
                            </button>
                            <button class="flex-1 px-3 py-2 rounded-xl text-xs font-medium bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all" onclick="openImportJson()">
                                <i class="fas fa-file-import mr-1 text-orange-500"></i>å¯¼å…¥
                            </button>
                        </div>
                        <input id="import-json-input" type="file" accept="application/json" class="hidden" onchange="importLogsFromJsonFile(event)" />
                    </div>
                </div>
                
                <!-- åˆ—è¡¨ -->
                <div id="weight-history-list" class="px-5 py-4 overflow-y-auto flex-1"></div>
                
                <!-- åº•éƒ¨ -->
                <div class="px-5 py-4 border-t border-gray-100">
                    <button class="w-full bg-gradient-to-r from-gray-800 to-gray-900 text-white py-3.5 rounded-2xl font-semibold shadow-lg active:scale-95 transition-transform" onclick="closeWeightHistoryModal()">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-weight-modal" class="fixed inset-0 hidden z-[65]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeEditWeightModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl shadow-xl max-h-[80vh] flex flex-col">
                <!-- å¤´éƒ¨ -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">ç¼–è¾‘ä½“é‡</h3>
                                <p class="text-xs text-gray-500">ä¿®æ”¹è®°å½•è¯¦æƒ…</p>
                            </div>
                        </div>
                        <button class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition-all" onclick="closeEditWeightModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- å†…å®¹ -->
                <div class="px-5 py-5 space-y-4 overflow-y-auto">
                    <div class="bg-gradient-to-r from-gray-50 to-white rounded-2xl p-4 border border-gray-100">
                        <label class="text-xs text-gray-500 mb-2 block">è®°å½•æ—¶é—´</label>
                        <input id="edit-weight-datetime" type="datetime-local" class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-500/30" />
                    </div>

                    <div class="bg-gradient-to-r from-emerald-50 to-white rounded-2xl p-4 border border-emerald-100">
                        <label class="text-xs text-gray-500 mb-2 block">ä½“é‡ (kg)</label>
                        <input id="edit-weight-value" type="number" step="0.01" class="w-full rounded-xl border border-emerald-200 bg-white px-4 py-3 text-2xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-emerald-500/30" placeholder="0.00" />
                    </div>

                    <div class="bg-gradient-to-r from-amber-50 to-white rounded-2xl p-4 border border-amber-100">
                        <label class="text-xs text-gray-500 mb-2 block">è®°å½•æ—¶æ®µ</label>
                        <div class="flex bg-amber-100/50 rounded-xl p-1">
                            <button id="btn-edit-period-morning" class="flex-1 px-3 py-2.5 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600" onclick="setEditWeightPeriod('morning')">ğŸŒ… æ—©æ™¨ç©ºè…¹</button>
                            <button id="btn-edit-period-night" class="flex-1 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-500 transition-all" onclick="setEditWeightPeriod('night')">ğŸŒ™ æ™šé—´ç¡å‰</button>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æŒ‰é’® -->
                <div class="px-5 py-4 border-t border-gray-100 flex gap-3">
                    <button class="flex-1 bg-gray-100 text-gray-700 py-3.5 rounded-2xl font-semibold active:scale-95 transition-transform hover:bg-gray-200" onclick="closeEditWeightModal()">å–æ¶ˆ</button>
                    <button id="btn-edit-weight-save" class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-3.5 rounded-2xl font-semibold shadow-lg shadow-emerald-200 active:scale-95 transition-transform" onclick="submitEditWeight()">
                        <i class="fas fa-check mr-1"></i>ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="daily-edit-modal" class="fixed inset-0 hidden z-[64]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeDailyEditModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl shadow-xl max-h-[85vh] flex flex-col">
                <!-- å¤´éƒ¨ -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">ç¼–è¾‘æ¯æ—¥æ•°æ®</h3>
                                <p id="daily-edit-title" class="text-xs text-gray-500">--</p>
                            </div>
                        </div>
                        <button class="w-9 h-9 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition-all" onclick="closeDailyEditModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- å†…å®¹ -->
                <div class="px-5 py-5 space-y-4 overflow-y-auto flex-1">
                    <!-- ä½“é‡åŒºåŸŸ -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-4 border border-blue-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-weight text-blue-500"></i>
                            <span class="text-sm font-semibold text-gray-700">ä½“é‡è®°å½•</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">ğŸŒ… æ—©æ™¨ç©ºè…¹</label>
                                <input id="edit-daily-morning" type="number" step="0.01" class="w-full rounded-xl border border-blue-200 bg-white px-3 py-2.5 text-base font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-500/30" placeholder="--" />
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">ğŸŒ™ æ™šé—´ç¡å‰</label>
                                <input id="edit-daily-night" type="number" step="0.01" class="w-full rounded-xl border border-blue-200 bg-white px-3 py-2.5 text-base font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-500/30" placeholder="--" />
                            </div>
                        </div>
                    </div>

                    <!-- é¥®é£ŸåŒºåŸŸ -->
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-4 border border-emerald-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-utensils text-emerald-500"></i>
                            <span class="text-sm font-semibold text-gray-700">é¥®é£Ÿè®°å½•</span>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">åˆé¤</label>
                                <textarea id="edit-daily-lunch" rows="2" class="w-full rounded-xl border border-emerald-200 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30" placeholder="ä»Šå¤©åˆé¤åƒäº†ä»€ä¹ˆï¼Ÿ"></textarea>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">æ™šé¤</label>
                                <textarea id="edit-daily-dinner" rows="2" class="w-full rounded-xl border border-emerald-200 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30" placeholder="ä»Šå¤©æ™šé¤åƒäº†ä»€ä¹ˆï¼Ÿ"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- è¿åŠ¨åŒºåŸŸ -->
                    <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-2xl p-4 border border-orange-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-dumbbell text-orange-500"></i>
                            <span class="text-sm font-semibold text-gray-700">è¿åŠ¨è®°å½•</span>
                        </div>
                        <textarea id="edit-daily-workout" rows="2" class="w-full rounded-xl border border-orange-200 bg-white px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/30" placeholder="ä»Šå¤©é”»ç‚¼äº†ä»€ä¹ˆï¼Ÿ"></textarea>
                    </div>
                </div>

                <!-- åº•éƒ¨æŒ‰é’® -->
                <div class="px-5 py-4 border-t border-gray-100 flex gap-3">
                    <button class="flex-1 bg-gray-100 text-gray-700 py-3.5 rounded-2xl font-semibold active:scale-95 transition-transform hover:bg-gray-200" onclick="closeDailyEditModal()">å–æ¶ˆ</button>
                    <button id="btn-edit-daily-save" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3.5 rounded-2xl font-semibold shadow-lg shadow-indigo-200 active:scale-95 transition-transform" onclick="submitDailyEdit()">
                        <i class="fas fa-check mr-1"></i>ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="fixed top-14 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-gray-800 to-gray-900 text-white px-5 py-3 rounded-2xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[100] flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center">
            <i class="fas fa-check text-white text-sm"></i>
        </div>
        <span id="toast-msg" class="font-medium">ä¿å­˜æˆåŠŸ</span>
    </div>

    <script type="module">
        // 1. å¯¼å…¥ Firebase æ¨¡å— (ä½¿ç”¨ CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp, doc, deleteDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Firebase é…ç½® (ç”¨æˆ·æä¾›)
        const firebaseConfig = {
            apiKey: "AIzaSyCtj6rwIsC0niDMfkidV0AcvtA8gcuT3NE",
            authDomain: "weight-29113.firebaseapp.com",
            projectId: "weight-29113",
            storageBucket: "weight-29113.firebasestorage.app",
            messagingSenderId: "452663997314",
            appId: "1:452663997314:web:c6e230824ec83634e1559b",
            measurementId: "G-DXMS6X7H22"
        };

        // 3. åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = "diet_logs";

        // 4. å…¨å±€çŠ¶æ€
        let appData = {
            logs: [],
            currentUnit: 'kg', // è¾“å…¥æ—¶çš„å•ä½
            weightInputPeriod: 'morning', // æ—©æ™¨/ç¡å‰
            userHeight: 172, // é»˜è®¤èº«é«˜ï¼Œä¼šå­˜å‚¨åœ¨é—­åŒ…ä¸­
            foodUnit: 'g', // g æˆ– ml
            foodHeatUnit: 'kj', // kcal æˆ– kjï¼Œé»˜è®¤æŒ‰ kJ å¸¸è§æ ‡æ³¨
            weightHistoryFilter: 'morning',
            editWeightPeriod: 'morning',
            editingWeightId: null,
            trendMode: 'weight',
            trendRange: 30,
            editingDailyYmd: null
        };
        let chartInstance = null;

        // 5. DOM å…ƒç´ å¼•ç”¨
        const els = {
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            // ä½“é‡è¾“å…¥
            inputWeight: document.getElementById("input-weight"),
            displayWeight: document.getElementById("display-weight"),
            lastRecordTime: document.getElementById('last-record-time'),
            displayBMI: document.getElementById('display-bmi'),
            bmiStatus: document.getElementById('bmi-status'),
            bmiNext: document.getElementById('bmi-next'),
            bmiProgressIndicator: document.getElementById('bmi-progress-indicator'),
            recentList: document.getElementById('recent-list'),
            calcInput: document.getElementById('calc-input'),
            calcHistory: document.getElementById('calc-history'),
            calcRun: document.getElementById('calc-run'),
            calcRope: document.getElementById('calc-rope'),
            calcDumbbell: document.getElementById('calc-dumbbell'),
            trendCurrentWeight: document.getElementById('trend-current-weight'),
            trendCurrentTime: document.getElementById('trend-current-time'),
            trendChangeBadge: document.getElementById('trend-change-badge'),
            trendChange: document.getElementById('trend-change'),
            trendChangeDesc: document.getElementById('trend-change-desc'),
            weightChange: document.getElementById('weight-change'),
            weightChangeDesc: document.getElementById('weight-change-desc'),
            weightChangeExtra: document.getElementById('weight-change-extra'),
            weightTrendBadge: document.getElementById('weight-trend-badge'),
            btnPeriodMorning: document.getElementById('btn-period-morning'),
            btnPeriodNight: document.getElementById('btn-period-night'),
            trendFilterBtns: document.querySelectorAll('.filter-btn'),
            trendModeDesc: document.getElementById('trend-mode-desc'),
            trendCardLabel1: document.getElementById('trend-card-label-1'),
            trendCardLabel2: document.getElementById('trend-card-label-2'),
            trendBtnWeight: document.getElementById('btn-trend-weight'),
            trendBtnMetabolic: document.getElementById('btn-trend-metabolic'),
            statMaxLabel: document.getElementById('stat-max-label'),
            statMinLabel: document.getElementById('stat-min-label'),
            chartCanvas: document.getElementById('weightChart'),
            weightHistoryModal: document.getElementById('weight-history-modal'),
            weightHistoryList: document.getElementById('weight-history-list'),
            weightHistoryTabs: document.getElementById('weight-history-tabs'),
            weightHistoryCopyRange: document.getElementById('weight-history-copy-range'),
            editWeightModal: document.getElementById('edit-weight-modal'),
            editWeightDatetime: document.getElementById('edit-weight-datetime'),
            editWeightValue: document.getElementById('edit-weight-value'),
            btnEditPeriodMorning: document.getElementById('btn-edit-period-morning'),
            btnEditPeriodNight: document.getElementById('btn-edit-period-night'),
            btnEditWeightSave: document.getElementById('btn-edit-weight-save'),
            dailyEditModal: document.getElementById('daily-edit-modal'),
            dailyEditTitle: document.getElementById('daily-edit-title'),
            dailyEditMorning: document.getElementById('edit-daily-morning'),
            dailyEditNight: document.getElementById('edit-daily-night'),
            dailyEditLunch: document.getElementById('edit-daily-lunch'),
            dailyEditDinner: document.getElementById('edit-daily-dinner'),
            dailyEditWorkout: document.getElementById('edit-daily-workout'),
            dailyEditSave: document.getElementById('btn-edit-daily-save'),
            // é£Ÿæçƒ­é‡è®¡ç®—
            foodName: document.getElementById('food-name'),
            foodAmount: document.getElementById('food-amount'),
            foodUnitKcal: document.getElementById('food-unit-kcal'),
            foodTotal: document.getElementById('food-total-kcal')
        };

        // è¯»å–/ä¿å­˜ä»Šæ—¥åˆé¤ã€æ™šé¤ã€è¿åŠ¨å¤‡æ³¨
        const mealNoteEls = {
            lunch: document.getElementById('input-lunch-note'),
            dinner: document.getElementById('input-dinner-note'),
            workout: document.getElementById('input-workout-note')
        };
        const mealStatusEls = {
            lunch: document.getElementById('status-lunch'),
            dinner: document.getElementById('status-dinner'),
            workout: document.getElementById('status-workout')
        };

        // ================= å·¥å…·å‡½æ•° =================

        // æ˜¾ç¤º Toast æç¤º
        window.showToast = (msg) => {
            if (!els.toast || !els.toastMsg) return;
            els.toastMsg.innerText = msg;
            els.toast.classList.remove('opacity-0');
            els.toast.classList.add('opacity-100');
            setTimeout(() => {
                if (!els.toast) return;
                els.toast.classList.remove('opacity-100');
                els.toast.classList.add('opacity-0');
            }, 2000);
        };

        window.openWeightHistoryModal = () => {
            if (!els.weightHistoryModal || !els.weightHistoryList) return;
            // é»˜è®¤å±•ç¤ºæ—©æ™¨ä½“é‡ï¼ˆä¸æŒ‰é’®é»˜è®¤é«˜äº®ä¸€è‡´ï¼‰
            appData.weightHistoryFilter = 'morning';
            setWeightHistoryFilter('morning');
            els.weightHistoryModal.classList.remove('hidden');
        };

        window.closeWeightHistoryModal = () => {
            if (!els.weightHistoryModal) return;
            els.weightHistoryModal.classList.add('hidden');
        };

        const formatDatetimeLocal = (dateObj) => {
            if (!dateObj || !Number.isFinite(dateObj.getTime())) return '';
            const y = dateObj.getFullYear();
            const m = pad2(dateObj.getMonth() + 1);
            const d = pad2(dateObj.getDate());
            const hh = pad2(dateObj.getHours());
            const mm = pad2(dateObj.getMinutes());
            return `${y}-${m}-${d}T${hh}:${mm}`;
        };

        window.setEditWeightPeriod = (period) => {
            appData.editWeightPeriod = period === 'night' ? 'night' : 'morning';
            if (els.btnEditPeriodMorning && els.btnEditPeriodNight) {
                if (appData.editWeightPeriod === 'morning') {
                    els.btnEditPeriodMorning.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnEditPeriodNight.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-500 transition-all";
                } else {
                    els.btnEditPeriodNight.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnEditPeriodMorning.className = "flex-1 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-500 transition-all";
                }
            }
        };

        // æŸ¥æ‰¾æŸå¤©æ—©/æ™šä½“é‡è®°å½•
        function findWeightLogByYmd(ymd, period) {
            return appData.logs
                .filter(l => l.type === 'weight')
                .filter(l => normalizePeriod(l) === period)
                .find(l => getYmd(l.date || l.timestamp || l.clientCreatedAtMs) === ymd);
        }

        // æ‰“å¼€æ¯æ—¥æ±‡æ€»ç¼–è¾‘
        window.openDailyEditModal = (ymd) => {
            appData.editingDailyYmd = ymd;
            if (els.dailyEditTitle) els.dailyEditTitle.innerText = `${ymd} è¯¦ç»†`;
            const morning = findWeightLogByYmd(ymd, 'morning');
            const night = findWeightLogByYmd(ymd, 'night');
            const mealMap = getMealNotesMap();
            const note = mealMap[ymd] || {};
            if (els.dailyEditMorning) els.dailyEditMorning.value = morning ? formatWeight(morning.value) : '';
            if (els.dailyEditNight) els.dailyEditNight.value = night ? formatWeight(night.value) : '';
            if (els.dailyEditLunch) els.dailyEditLunch.value = note.lunch || '';
            if (els.dailyEditDinner) els.dailyEditDinner.value = note.dinner || '';
            if (els.dailyEditWorkout) els.dailyEditWorkout.value = note.workout || '';
            els.dailyEditModal?.classList.remove('hidden');
        };

        window.closeDailyEditModal = () => {
            els.dailyEditModal?.classList.add('hidden');
            appData.editingDailyYmd = null;
        };

        // ä¿å­˜æ¯æ—¥æ±‡æ€»ï¼ˆæ—©/æ™šä½“é‡ + ä¸‰å¤‡æ³¨ï¼‰
        window.submitDailyEdit = async () => {
            const ymd = appData.editingDailyYmd;
            if (!ymd) {
                showToast('æœªé€‰æ‹©æ—¥æœŸ');
                return;
            }
            const morningVal = parseFloat(els.dailyEditMorning?.value);
            const nightVal = parseFloat(els.dailyEditNight?.value);
            const lunchVal = els.dailyEditLunch?.value ?? '';
            const dinnerVal = els.dailyEditDinner?.value ?? '';
            const workoutVal = els.dailyEditWorkout?.value ?? '';

            const updates = [];
            const now = new Date();
            // æ—©æ™¨
            if (Number.isFinite(morningVal)) {
                if (morningVal < 20 || morningVal > 300) {
                    showToast('æ—©æ™¨ä½“é‡èŒƒå›´å¼‚å¸¸ï¼ˆ20-300kgï¼‰');
                    return;
                }
                const existingMorning = findWeightLogByYmd(ymd, 'morning');
                const dateObj = toJsDate(existingMorning?.date) || new Date(`${ymd}T07:00:00`);
                const newDoc = {
                    date: `${ymd} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`,
                    type: "weight",
                    value: Number(morningVal.toFixed(2)),
                    period: 'morning',
                    note: "",
                    clientCreatedAtMs: dateObj.getTime(),
                    timestamp: serverTimestamp()
                };
                if (existingMorning?.id) {
                    updates.push(updateDoc(doc(db, COLLECTION_NAME, existingMorning.id), newDoc));
                } else {
                    updates.push(addDoc(collection(db, COLLECTION_NAME), newDoc));
                }
            }
            // æ™šé—´
            if (Number.isFinite(nightVal)) {
                if (nightVal < 20 || nightVal > 300) {
                    showToast('æ™šé—´ä½“é‡èŒƒå›´å¼‚å¸¸ï¼ˆ20-300kgï¼‰');
                    return;
                }
                const existingNight = findWeightLogByYmd(ymd, 'night');
                const dateObj = toJsDate(existingNight?.date) || new Date(`${ymd}T22:00:00`);
                const newDoc = {
                    date: `${ymd} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`,
                    type: "weight",
                    value: Number(nightVal.toFixed(2)),
                    period: 'night',
                    note: "",
                    clientCreatedAtMs: dateObj.getTime(),
                    timestamp: serverTimestamp()
                };
                if (existingNight?.id) {
                    updates.push(updateDoc(doc(db, COLLECTION_NAME, existingNight.id), newDoc));
                } else {
                    updates.push(addDoc(collection(db, COLLECTION_NAME), newDoc));
                }
            }

            // å¤‡æ³¨
            const existingNote = appData.logs
                .filter(l => l.type === 'meal_note')
                .find(l => (l.ymd || getYmd(l.date || l.timestamp || l.clientCreatedAtMs)) === ymd);
            const noteDoc = {
                type: "meal_note",
                ymd,
                lunchNote: lunchVal.trim(),
                dinnerNote: dinnerVal.trim(),
                workoutNote: workoutVal.trim(),
                date: `${ymd} 12:00`,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };
            if (existingNote?.id) {
                updates.push(updateDoc(doc(db, COLLECTION_NAME, existingNote.id), noteDoc));
            } else {
                // é¿å…å…¨éƒ¨ç©ºæ—¶æ’å…¥ç©ºè®°å½•
                if (lunchVal.trim() || dinnerVal.trim() || workoutVal.trim()) {
                    updates.push(addDoc(collection(db, COLLECTION_NAME), noteDoc));
                }
            }

            if (!updates.length) {
                showToast('æ— å¯ä¿å­˜å†…å®¹');
                return;
            }

            try {
                els.dailyEditSave && (els.dailyEditSave.disabled = true);
                els.dailyEditSave && (els.dailyEditSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...');
                await Promise.all(updates);
                showToast('ä¿å­˜æˆåŠŸ');
                closeDailyEditModal();
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                if (els.dailyEditSave) {
                    els.dailyEditSave.disabled = false;
                    els.dailyEditSave.innerHTML = 'ä¿å­˜';
                }
            }
        };

        // ================= æ™šé¤å’Œé”»ç‚¼é¢„è®¾æ–¹æ¡ˆ =================
        const DINNER_PRESETS = [
            '800mlé»‘è±†æµ†æ°´ï¼ˆ20gé»‘è±†æµ†ç²‰â•15gäºšéº»ç±½ç²‰ï¼‰â•100gé¸¡èƒ¸è‚‰',
            '800mlé»‘è±†æµ†æ°´ï¼ˆ20gé»‘è±†æµ†ç²‰â•15gäºšéº»ç±½ç²‰ï¼‰â•100gé¸¡èƒ¸è‚‰â•2å—æ¬§æ‰å…‹å…¨éº¦è„†'
        ];

        // æœ‰æ°§è¿åŠ¨é¢„è®¾ï¼ˆè·³ç»³æ–¹æ¡ˆï¼Œäº’æ–¥é€‰æ‹©ï¼‰
        const CARDIO_PRESETS = [
            'è·³ç»³300Ã—3ç»„ï¼ˆå…±900ä¸ªï¼‰â•å¼€åˆè·³50ä¸ªâ•èƒ¯ä¸‹å‡»æŒ50ä¸ªâ•åŸåœ°é«˜æŠ¬è…¿100ä¸‹',
            'è·³ç»³300Ã—6ç»„ï¼ˆå…±1800ä¸ªï¼‰â•å¼€åˆè·³100ä¸ªâ•èƒ¯ä¸‹å‡»æŒ100ä¸ªâ•åŸåœ°é«˜æŠ¬è…¿200ä¸‹',
            'è·³ç»³300Ã—10ç»„ï¼ˆå…±3000ä¸ªï¼‰â•å¼€åˆè·³150ä¸ªâ•èƒ¯ä¸‹å‡»æŒ150ä¸ªâ•åŸåœ°é«˜æŠ¬è…¿300ä¸‹'
        ];

        // åŠ›é‡è®­ç»ƒé¢„è®¾ï¼ˆå¯å¤šé€‰ï¼‰
        const STRENGTH_PRESETS = [
            'æ·±è¹²20Ã—3ç»„ï¼ˆå…±60ä¸ªï¼‰',
            'å“‘é“ƒå¼¯ä¸¾10Ã—5ç»„ï¼ˆå…±50ä¸ªï¼‰',
            'é”¤å¼å¼¯ä¸¾10Ã—5ç»„ï¼ˆå…±50ä¸ªï¼‰',
            'ä¸Šæ–œçª„è·ä¿¯å§æ’‘15Ã—5ç»„ï¼ˆå…±75ä¸ªï¼‰',
            'ç»³ç´¢ä¸‹å‹10Ã—5ç»„ï¼ˆå…±50ä¸ªï¼‰',
            'ç»³ç´¢å¼¯ä¸¾10Ã—5ç»„ï¼ˆå…±50ä¸ªï¼‰',
            'ä½“å‰å‚å¼å¼¯ä¸¾5Ã—3ç»„ï¼ˆå…±15ä¸ªï¼‰'
        ];

        const WORKOUT_TIME_LABELS = {
            morning: 'ä¸Šåˆä¸­é¥­å‰ç©ºè…¹',
            evening: 'ä¸‹åˆæ™šé¥­å‰ç©ºè…¹',
            night: 'ä¸‹åˆæ™šé¥­å'
        };

        // æ–°ç‰ˆï¼šé€‰ä¸­çš„æ—¶æ®µï¼ˆSetï¼Œå¯å¤šé€‰ï¼‰
        const selectedTimeSlots = new Set();
        // æ–°ç‰ˆï¼šé€‰ä¸­çš„æœ‰æ°§ï¼ˆnullæˆ–ç´¢å¼•ï¼Œäº’æ–¥ï¼‰
        let selectedCardio = null;
        // æ–°ç‰ˆï¼šé€‰ä¸­çš„åŠ›é‡ï¼ˆSetï¼Œå¯å¤šé€‰ï¼‰
        const selectedStrength = new Set();

        // é€‰æ‹©æ™šé¤æ–¹æ¡ˆ
        window.selectDinnerPreset = (index) => {
            const preset = DINNER_PRESETS[index];
            if (!preset) return;
            const textarea = document.getElementById('input-dinner-note');
            if (textarea) {
                textarea.value = preset;
                textarea.focus();
            }
            // æ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.dinner-preset-btn').forEach((btn, i) => {
                if (i === index) {
                    btn.classList.remove('bg-amber-50', 'text-amber-700', 'border-amber-200');
                    btn.classList.add('bg-amber-500', 'text-white', 'border-amber-500');
                } else {
                    btn.classList.remove('bg-amber-500', 'text-white', 'border-amber-500');
                    btn.classList.add('bg-amber-50', 'text-amber-700', 'border-amber-200');
                }
            });
        };

        // åˆ‡æ¢æ—¶æ®µé€‰æ‹©
        window.toggleTimeSlot = (slot) => {
            document.activeElement?.blur();
            const colorVars = {
                morning: { bg: '#2563eb', border: '#2563eb', inactive: ['bg-blue-50', 'text-blue-700', 'border-blue-200'] },
                evening: { bg: '#f97316', border: '#f97316', inactive: ['bg-orange-50', 'text-orange-700', 'border-orange-200'] },
                night: { bg: '#9333ea', border: '#9333ea', inactive: ['bg-purple-50', 'text-purple-700', 'border-purple-200'] }
            };
            
            setTimeout(() => {
                const btn = document.querySelector(`.workout-time-btn[data-slot="${slot}"]`);
                if (selectedTimeSlots.has(slot)) {
                    selectedTimeSlots.delete(slot);
                    btn.classList.remove('workout-btn-selected');
                    btn.style.removeProperty('--selected-bg');
                    btn.style.removeProperty('--selected-border');
                    btn.classList.add(...colorVars[slot].inactive);
                } else {
                    selectedTimeSlots.add(slot);
                    btn.classList.remove(...colorVars[slot].inactive);
                    btn.style.setProperty('--selected-bg', colorVars[slot].bg);
                    btn.style.setProperty('--selected-border', colorVars[slot].border);
                    btn.classList.add('workout-btn-selected');
                }
                updateWorkoutNote();
            }, 10);
        };

        // åˆ‡æ¢æœ‰æ°§é€‰æ‹©ï¼ˆäº’æ–¥ï¼‰
        window.toggleCardio = (index) => {
            document.activeElement?.blur();
            const inactiveClasses = ['bg-white', 'text-emerald-700', 'border-emerald-200'];
            const activeColor = { bg: '#059669', border: '#059669' }; // emerald-600
            
            setTimeout(() => {
                const btns = document.querySelectorAll('.workout-cardio-btn');
                if (selectedCardio === index) {
                    // å–æ¶ˆé€‰æ‹©
                    selectedCardio = null;
                    btns[index].classList.remove('workout-btn-selected');
                    btns[index].style.removeProperty('--selected-bg');
                    btns[index].style.removeProperty('--selected-border');
                    btns[index].classList.add(...inactiveClasses);
                } else {
                    // é€‰æ‹©æ–°çš„
                    btns.forEach((btn, i) => {
                        btn.classList.remove('workout-btn-selected', ...inactiveClasses);
                        btn.style.removeProperty('--selected-bg');
                        btn.style.removeProperty('--selected-border');
                        if (i === index) {
                            btn.style.setProperty('--selected-bg', activeColor.bg);
                            btn.style.setProperty('--selected-border', activeColor.border);
                            btn.classList.add('workout-btn-selected');
                        } else {
                            btn.classList.add(...inactiveClasses);
                        }
                    });
                    selectedCardio = index;
                }
                updateWorkoutNote();
            }, 10);
        };

        // åˆ‡æ¢åŠ›é‡é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼‰
        window.toggleStrength = (index) => {
            document.activeElement?.blur();
            const inactiveClasses = ['bg-white', 'text-indigo-700', 'border-indigo-200'];
            const activeColor = { bg: '#4f46e5', border: '#4f46e5' }; // indigo-600
            
            setTimeout(() => {
                const btns = document.querySelectorAll('.workout-strength-btn');
                const btn = btns[index];
                if (selectedStrength.has(index)) {
                    selectedStrength.delete(index);
                    btn.classList.remove('workout-btn-selected');
                    btn.style.removeProperty('--selected-bg');
                    btn.style.removeProperty('--selected-border');
                    btn.classList.add(...inactiveClasses);
                } else {
                    selectedStrength.add(index);
                    btn.classList.remove(...inactiveClasses);
                    btn.style.setProperty('--selected-bg', activeColor.bg);
                    btn.style.setProperty('--selected-border', activeColor.border);
                    btn.classList.add('workout-btn-selected');
                }
                updateWorkoutNote();
            }, 10);
        };

        // æ¸…ç©ºæ‰€æœ‰é”»ç‚¼é€‰æ‹©
        window.clearAllWorkout = () => {
            selectedTimeSlots.clear();
            selectedCardio = null;
            selectedStrength.clear();
            
            // é‡ç½®æ—¶æ®µæŒ‰é’®
            const timeColors = {
                morning: ['bg-blue-50', 'text-blue-700', 'border-blue-200'],
                evening: ['bg-orange-50', 'text-orange-700', 'border-orange-200'],
                night: ['bg-purple-50', 'text-purple-700', 'border-purple-200']
            };
            document.querySelectorAll('.workout-time-btn').forEach(btn => {
                const slot = btn.dataset.slot;
                btn.classList.remove('workout-btn-selected');
                btn.style.removeProperty('--selected-bg');
                btn.style.removeProperty('--selected-border');
                btn.classList.add(...timeColors[slot]);
            });
            
            // é‡ç½®æœ‰æ°§æŒ‰é’®
            document.querySelectorAll('.workout-cardio-btn').forEach(btn => {
                btn.classList.remove('workout-btn-selected');
                btn.style.removeProperty('--selected-bg');
                btn.style.removeProperty('--selected-border');
                btn.classList.add('bg-white', 'text-emerald-700', 'border-emerald-200');
            });
            
            // é‡ç½®åŠ›é‡æŒ‰é’®
            document.querySelectorAll('.workout-strength-btn').forEach(btn => {
                btn.classList.remove('workout-btn-selected');
                btn.style.removeProperty('--selected-bg');
                btn.style.removeProperty('--selected-border');
                btn.classList.add('bg-white', 'text-indigo-700', 'border-indigo-200');
            });
            
            updateWorkoutNote();
        };

        // æ ¹æ®é€‰æ‹©ç”Ÿæˆå®Œæ•´å¤‡æ³¨
        function updateWorkoutNote() {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¶æ®µæˆ–æ²¡æœ‰é€‰æ‹©è¿åŠ¨ï¼Œä¸ç”Ÿæˆå¤‡æ³¨
            if (selectedTimeSlots.size === 0 || (selectedCardio === null && selectedStrength.size === 0)) {
                const textarea = document.getElementById('input-workout-note');
                if (textarea) textarea.value = '';
                return;
            }
            
            // æ”¶é›†è¿åŠ¨å†…å®¹
            const cardioItems = [];
            const strengthItems = [];
            
            if (selectedCardio !== null && CARDIO_PRESETS[selectedCardio]) {
                cardioItems.push(CARDIO_PRESETS[selectedCardio]);
            }
            
            const sortedStrength = [...selectedStrength].sort((a, b) => a - b);
            sortedStrength.forEach(idx => {
                if (STRENGTH_PRESETS[idx]) {
                    strengthItems.push(STRENGTH_PRESETS[idx]);
                }
            });
            
            // ç»„åˆè¿åŠ¨å†…å®¹
            const workoutParts = [];
            if (cardioItems.length > 0) {
                workoutParts.push(`ã€æœ‰æ°§ã€‘${cardioItems.join('â•')}`);
            }
            if (strengthItems.length > 0) {
                workoutParts.push(`ã€æ— æ°§ã€‘${strengthItems.join('â•')}`);
            }
            const workoutContent = workoutParts.join('â•');
            
            // ä¸ºæ¯ä¸ªé€‰ä¸­çš„æ—¶æ®µç”Ÿæˆå¤‡æ³¨
            const parts = [];
            const sortedSlots = ['morning', 'evening', 'night'].filter(s => selectedTimeSlots.has(s));
            sortedSlots.forEach(slot => {
                parts.push(`${WORKOUT_TIME_LABELS[slot]}ï¼š${workoutContent}`);
            });
            
            const textarea = document.getElementById('input-workout-note');
            if (textarea) {
                textarea.value = parts.join('ï½œ');
            }
        }

        // é‡ç½®é”»ç‚¼é€‰æ‹©çŠ¶æ€ï¼ˆä¿å­˜åè°ƒç”¨ï¼‰
        function resetWorkoutSelections() {
            clearAllWorkout();
        }

        // 3.1 ä¿å­˜åˆ/æ™šé¤/è¿åŠ¨å¤‡æ³¨ï¼ˆæ”¯æŒå•ç‹¬ä¿å­˜æˆ–ä¸€é”®ä¿å­˜ï¼‰
        window.saveMealNote = async (type = 'all') => {
            const btn = document.getElementById('btn-save-meal-notes');
            const now = new Date();
            const ymd = getYmd(now);
            if (!ymd) {
                showToast("æ—¥æœŸå¼‚å¸¸");
                return;
            }
            const existing = appData.logs
                .filter(l => l.type === 'meal_note')
                .find(l => (l.ymd || getYmd(l.date || l.timestamp || l.clientCreatedAtMs)) === ymd);

            const lunchInput = mealNoteEls.lunch?.value ?? '';
            const dinnerInput = mealNoteEls.dinner?.value ?? '';
            const workoutInput = mealNoteEls.workout?.value ?? '';

            const finalLunch = type === 'lunch' ? lunchInput : (type === 'all' ? lunchInput : (existing?.lunchNote ?? ''));
            const finalDinner = type === 'dinner' ? dinnerInput : (type === 'all' ? dinnerInput : (existing?.dinnerNote ?? ''));
            const finalWorkout = type === 'workout' ? workoutInput : (type === 'all' ? workoutInput : (existing?.workoutNote ?? ''));

            const newDoc = {
                type: "meal_note",
                ymd,
                lunchNote: finalLunch.trim(),
                dinnerNote: finalDinner.trim(),
                workoutNote: finalWorkout.trim(),
                date: `${ymd} 12:00`,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
                }
                if (existing?.id) {
                    await updateDoc(doc(db, COLLECTION_NAME, existing.id), newDoc);
                    showToast("å·²æ›´æ–°ä»Šæ—¥å¤‡æ³¨");
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), newDoc);
                    showToast("å·²ä¿å­˜ä»Šæ—¥å¤‡æ³¨");
                }
                await fetchLogs();
                // æ¸…ç©ºå¯¹åº”è¾“å…¥æ¡†
                const shouldClearAll = type === 'all';
                if (shouldClearAll || type === 'lunch') mealNoteEls.lunch && (mealNoteEls.lunch.value = '');
                if (shouldClearAll || type === 'dinner') mealNoteEls.dinner && (mealNoteEls.dinner.value = '');
                if (shouldClearAll || type === 'workout') {
                    mealNoteEls.workout && (mealNoteEls.workout.value = '');
                    resetWorkoutSelections();
                }
                updateTodayMealStatus();
            } catch (e) {
                console.error(e);
                showToast("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'ä¸€é”®ä¿å­˜ä¸‰æ¡å¤‡æ³¨';
                }
            }
        };

        window.openEditWeightModal = (id) => {
            try {
                const target = appData.logs.find(l => l.id === id);
                if (!target) {
                    showToast('æœªæ‰¾åˆ°è¯¥è®°å½•');
                    return;
                }
                appData.editingWeightId = id;
                const dateObj = toJsDate(target.date || target.timestamp || target.clientCreatedAtMs);
                if (els.editWeightDatetime) {
                    els.editWeightDatetime.value = formatDatetimeLocal(dateObj);
                }
                if (els.editWeightValue) {
                    els.editWeightValue.value = Number(target.value).toFixed(2);
                }
                window.setEditWeightPeriod(normalizePeriod(target));
                els.editWeightModal?.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                showToast('æ‰“å¼€ç¼–è¾‘å¤±è´¥');
            }
        };

        window.closeEditWeightModal = () => {
            els.editWeightModal?.classList.add('hidden');
            appData.editingWeightId = null;
        };

        window.submitEditWeight = async () => {
            const btn = els.btnEditWeightSave;
            if (!appData.editingWeightId) {
                showToast('æœªé€‰æ‹©è¦ä¿®æ”¹çš„è®°å½•');
                return;
            }
            const rawVal = parseFloat(els.editWeightValue?.value);
            if (!Number.isFinite(rawVal) || rawVal <= 0) {
                showToast('è¯·è¾“å…¥ä½“é‡æ•°å€¼');
                return;
            }
            if (rawVal < 20 || rawVal > 300) {
                showToast('ä½“é‡èŒƒå›´å¼‚å¸¸ï¼ˆ20-300kgï¼‰');
                return;
            }
            const rawDatetime = els.editWeightDatetime?.value;
            const dateObj = rawDatetime ? new Date(rawDatetime) : null;
            if (!dateObj || !Number.isFinite(dateObj.getTime())) {
                showToast('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¶é—´');
                return;
            }
            const dateStr = `${dateObj.getFullYear()}-${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())} ${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
                }
                const newDoc = {
                    date: dateStr,
                    type: "weight",
                    value: Number(rawVal.toFixed(2)),
                    period: appData.editWeightPeriod,
                    note: "",
                    clientCreatedAtMs: dateObj.getTime(),
                    timestamp: serverTimestamp()
                };
                await updateDoc(doc(db, COLLECTION_NAME, appData.editingWeightId), newDoc);
                showToast('å·²æ›´æ–°è®°å½•');
                window.closeEditWeightModal();
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'ä¿å­˜ä¿®æ”¹';
                }
            }
        };

        function getYmd(dateValue) {
            const d = toJsDate(dateValue);
            if (!d || !Number.isFinite(d.getTime())) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function renderWeightHistoryModal() {
            const wrap = els.weightHistoryList;
            if (!wrap) return;
            wrap.innerHTML = '';

            const weights = getWeightLogs(appData.weightHistoryFilter)
                .sort((a, b) => getLogDateMs(b) - getLogDateMs(a));
            const mealNotes = getMealNotesMap();

            if (!weights.length) {
                wrap.innerHTML = '<div class="text-center text-gray-400 py-8">æš‚æ— ä½“é‡è®°å½•</div>';
                return;
            }

            weights.forEach(item => {
                const ymd = getYmd(item.date || item.timestamp);
                const note = mealNotes[ymd];
                const noteHtml = note && (note.lunch || note.dinner || note.workout)
                    ? `<p class="text-[11px] text-gray-500 mt-1">åˆï¼š${note.lunch || '--'} Â· æ™šï¼š${note.dinner || '--'} Â· è¿åŠ¨ï¼š${note.workout || '--'}</p>`
                    : '';
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-3 border-b border-gray-100';
                row.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-gray-900">${ymd}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(item.date || item.timestamp)} Â· ${WEIGHT_PERIOD_LABEL[normalizePeriod(item)] || ''}</p>
                        ${noteHtml}
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="text-base font-bold text-gray-900">${formatWeight(item.value)} kg</p>
                        <button class="text-emerald-600 text-xs px-3 py-2 rounded-lg hover:bg-emerald-50" onclick="openEditWeightModal('${item.id}')">ç¼–è¾‘</button>
                    </div>
                `;
                wrap.appendChild(row);
            });
        }

        const WEIGHT_HISTORY_RANGE_LABEL = {
            all: 'å…¨éƒ¨å†å²',
            '7d': 'è¿‘7å¤©',
            '1m': 'è¿‘1ä¸ªæœˆ',
            '2m': 'è¿‘2ä¸ªæœˆ',
            '3m': 'è¿‘3ä¸ªæœˆ',
            '4m': 'è¿‘4ä¸ªæœˆ',
            '5m': 'è¿‘5ä¸ªæœˆ',
            '6m': 'è¿‘åŠå¹´',
            '1y': 'è¿‘ä¸€å¹´'
        };

        function getRangeCutoffMs(rangeKey) {
            if (!rangeKey || rangeKey === 'all') return null;
            const now = new Date();
            const d = new Date(now);
            if (rangeKey === '7d') d.setDate(d.getDate() - 7);
            else if (rangeKey === '1m') d.setMonth(d.getMonth() - 1);
            else if (rangeKey === '2m') d.setMonth(d.getMonth() - 2);
            else if (rangeKey === '3m') d.setMonth(d.getMonth() - 3);
            else if (rangeKey === '4m') d.setMonth(d.getMonth() - 4);
            else if (rangeKey === '5m') d.setMonth(d.getMonth() - 5);
            else if (rangeKey === '6m') d.setMonth(d.getMonth() - 6);
            else if (rangeKey === '1y') d.setFullYear(d.getFullYear() - 1);
            const ms = d.getTime();
            return Number.isFinite(ms) ? ms : null;
        }

        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        // è·å–æŒ‰æ—¥æœŸèšåˆçš„åˆé¤/æ™šé¤å¤‡æ³¨
        function getMealNotesMap() {
            const map = {};
            appData.logs
                .filter(l => l.type === 'meal_note')
                .forEach(item => {
                    const ymd = item.ymd || getYmd(item.date || item.timestamp || item.clientCreatedAtMs);
                    if (!ymd) return;
                    map[ymd] = {
                        lunch: item.lunchNote || '',
                        dinner: item.dinnerNote || '',
                        workout: item.workoutNote || ''
                    };
                });
            return map;
        }

        function buildMealNotesMapFromList(logs) {
            const map = {};
            logs
                .filter(l => l.type === 'meal_note')
                .forEach(item => {
                    const ymd = item.ymd || getYmd(item.date || item.timestamp || item.clientCreatedAtMs);
                    if (!ymd) return;
                    map[ymd] = {
                        lunch: item.lunchNote || '',
                        dinner: item.dinnerNote || '',
                        workout: item.workoutNote || ''
                    };
                });
            return map;
        }

        function buildDailyAggregation(logs, cutoffMs = null) {
            const map = {};
            logs.forEach(item => {
                const ms = getLogDateMs(item);
                if (cutoffMs && ms < cutoffMs) return;
                const ymd = getYmd(item.date || item.timestamp || item.clientCreatedAtMs);
                if (!ymd) return;
                if (!map[ymd]) map[ymd] = { ymd };
                if (item.type === 'weight') {
                    const period = normalizePeriod(item);
                    if (period === 'morning') {
                        if (!map[ymd].morning || ms > (map[ymd].morningMs || 0)) {
                            map[ymd].morning = item;
                            map[ymd].morningMs = ms;
                        }
                    } else {
                        if (!map[ymd].night || ms > (map[ymd].nightMs || 0)) {
                            map[ymd].night = item;
                            map[ymd].nightMs = ms;
                        }
                    }
                } else if (item.type === 'meal_note') {
                    map[ymd].lunch = item.lunchNote || '';
                    map[ymd].dinner = item.dinnerNote || '';
                    map[ymd].workout = item.workoutNote || '';
                }
            });
            return Object.values(map).sort((a, b) => (b.morningMs || b.nightMs || 0) - (a.morningMs || a.nightMs || 0));
        }

        function buildWeightHistoryTsv(dailyRows, meta) {
            const { filterLabel, rangeLabel } = meta || {};
            const rows = [...(dailyRows || [])].sort((a, b) => {
                const msA = a.morningMs || a.nightMs || 0;
                const msB = b.morningMs || b.nightMs || 0;
                return msA - msB;
            });
            const lines = [];
            lines.push(`èŒƒå›´: ${rangeLabel || ''} | ç±»å‹: ${filterLabel || ''} | å•ä½: kg`);
            lines.push('date\tmorning_kg\tnight_kg\tlunch_note\tdinner_note\tworkout_note');
            rows.forEach(item => {
                const ymd = item.ymd;
                const morning = item.morning ? formatWeight(item.morning.value) : '';
                const night = item.night ? formatWeight(item.night.value) : '';
                const lunch = item.lunch || '';
                const dinner = item.dinner || '';
                const workout = item.workout || '';
                lines.push(`${ymd}\t${morning}\t${night}\t${lunch}\t${dinner}\t${workout}`);
            });
            return lines.join('\n');
        }

        async function copyTextToClipboard(text) {
            if (navigator?.clipboard?.writeText) {
                await navigator.clipboard.writeText(text);
                return;
            }
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (!ok) throw new Error('copy_failed');
        }

        window.copyWeightHistoryToClipboard = async (rangeKey = 'all') => {
            try {
                const filter = appData.weightHistoryFilter || 'all';
                const filterLabel = filter === 'morning' ? 'æ—©æ™¨ç©ºè…¹' : (filter === 'night' ? 'æ™šé—´ç¡å‰' : 'å…¨éƒ¨');
                const rangeLabel = WEIGHT_HISTORY_RANGE_LABEL[rangeKey] || '';

                const cutoffMs = getRangeCutoffMs(rangeKey);
                const dailyRows = buildDailyAggregation(appData.logs, cutoffMs);
                if (!dailyRows.length) {
                    showToast('è¯¥èŒƒå›´æš‚æ— è®°å½•');
                    return;
                }

                const text = buildWeightHistoryTsv(dailyRows, { filterLabel, rangeLabel });

                await copyTextToClipboard(text);
                showToast(`å·²å¤åˆ¶ ${dailyRows.length} å¤©`);
            } catch (e) {
                console.error(e);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };

        // æ ¼å¼åŒ–æ—¥æœŸ
        const toJsDate = (value) => {
            if (!value) return null;
            if (typeof value === 'object' && typeof value.toDate === 'function') {
                return value.toDate();
            }
            if (typeof value === 'string') {
                const s = value.trim();
                if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(s)) {
                    return new Date(s.replace(' ', 'T') + ':00');
                }
                if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                    return new Date(s + 'T00:00:00');
                }
                return new Date(s);
            }
            return new Date(value);
        };

        const getLogDateMs = (log) => {
            const clientMs = Number(log?.clientCreatedAtMs);
            if (Number.isFinite(clientMs)) return clientMs;
            const d = toJsDate(log?.date) || toJsDate(log?.timestamp);
            const ms = d?.getTime();
            return Number.isFinite(ms) ? ms : 0;
        };

        function downloadTextAsFile(filename, text, mime = 'text/plain;charset=utf-8') {
            const blob = new Blob([text], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeCsvCell(value) {
            const s = String(value ?? '');
            if (/[,\n\r"]/g.test(s)) return `"${s.replace(/"/g, '""')}"`;
            return s;
        }

        function buildWeightHistoryCsv(dailyRows, meta) {
            const { filterLabel, rangeLabel, notesMap } = meta || {};
            const mealMap = notesMap || getMealNotesMap();
            const rows = [...(dailyRows || [])].sort((a, b) => {
                const msA = a.morningMs || a.nightMs || 0;
                const msB = b.morningMs || b.nightMs || 0;
                return msA - msB;
            });
            const lines = [];
            lines.push(`èŒƒå›´,${escapeCsvCell(rangeLabel || '')}`);
            lines.push(`ç±»å‹,${escapeCsvCell(filterLabel || '')}`);
            lines.push(`å•ä½,kg`);
            lines.push('date,morning_kg,night_kg,lunch_note,dinner_note,workout_note');
            rows.forEach(item => {
                const ymd = item.ymd;
                const morning = item.morning ? formatWeight(item.morning.value) : '';
                const night = item.night ? formatWeight(item.night.value) : '';
                const note = mealMap[ymd] || {};
                lines.push([
                    ymd,
                    morning,
                    night,
                    note.lunch || item.lunch || '',
                    note.dinner || item.dinner || '',
                    note.workout || item.workout || ''
                ].map(escapeCsvCell).join(','));
            });
            return '\uFEFF' + lines.join('\n');
        }

        async function fetchAllLogsForExport() {
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            const all = [];
            snap.forEach(d => all.push({ id: d.id, ...d.data() }));
            all.sort((a, b) => getLogDateMs(b) - getLogDateMs(a));
            return all;
        };

        window.downloadWeightHistoryCsv = async (rangeKey = 'all') => {
            try {
                const filter = appData.weightHistoryFilter || 'all';
                const filterLabel = filter === 'morning' ? 'æ—©æ™¨ç©ºè…¹' : (filter === 'night' ? 'æ™šé—´ç¡å‰' : 'å…¨éƒ¨');
                const rangeLabel = WEIGHT_HISTORY_RANGE_LABEL[rangeKey] || '';
                showToast('æ­£åœ¨ç”ŸæˆCSV...');

                const allLogs = await fetchAllLogsForExport();
                const cutoffMs = getRangeCutoffMs(rangeKey);
                const dailyRows = buildDailyAggregation(allLogs, cutoffMs);
                if (!dailyRows.length) {
                    showToast('è¯¥èŒƒå›´æš‚æ— è®°å½•');
                    return;
                }

                const notesMap = buildMealNotesMapFromList(allLogs);
                const csv = buildWeightHistoryCsv(dailyRows, { filterLabel, rangeLabel, notesMap });
                const today = getYmd(Date.now()) || 'export';
                const filename = `weight_daily_${rangeKey}_${today}.csv`;
                downloadTextAsFile(filename, csv, 'text/csv;charset=utf-8');
                showToast(`å·²ä¸‹è½½ ${dailyRows.length} å¤©`);
            } catch (e) {
                console.error(e);
                showToast('å¯¼å‡ºå¤±è´¥');
            }
        };

        window.downloadAllLogsJson = async () => {
            try {
                showToast('æ­£åœ¨å¯¼å‡ºJSON...');
                const allLogs = await fetchAllLogsForExport();
                const dailyRows = buildDailyAggregation(allLogs);
                const payload = {
                    exportedAt: new Date().toISOString(),
                    collection: COLLECTION_NAME,
                    days: dailyRows.map(day => ({
                        date: day.ymd,
                        morning_kg: day.morning ? Number(day.morning.value).toFixed(2) : null,
                        night_kg: day.night ? Number(day.night.value).toFixed(2) : null,
                        lunch_note: day.lunch || '',
                        dinner_note: day.dinner || '',
                        workout_note: day.workout || ''
                    }))
                };
                const today = getYmd(Date.now()) || 'export';
                downloadTextAsFile(`diet_days_${today}.json`, JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
                showToast(`å·²å¯¼å‡º ${dailyRows.length} å¤©`);
            } catch (e) {
                console.error(e);
                showToast('å¯¼å‡ºå¤±è´¥');
            }
        };

        window.openImportJson = () => {
            const input = document.getElementById('import-json-input');
            input?.click();
        };

        window.importLogsFromJsonFile = async (event) => {
            try {
                const file = event?.target?.files?.[0];
                if (!file) return;
                const text = await file.text();
                const data = JSON.parse(text);
                const logs = Array.isArray(data) ? data : (Array.isArray(data?.logs) ? data.logs : []);
                if (!logs.length) {
                    showToast('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                    return;
                }
                const ok = confirm(`å°†å¯¼å…¥ ${logs.length} æ¡è®°å½•ï¼ˆä¼šæ–°å¢ï¼Œå¯èƒ½é‡å¤ï¼‰ã€‚ç»§ç»­ï¼Ÿ`);
                if (!ok) return;

                for (const itemRaw of logs) {
                    if (!itemRaw || typeof itemRaw !== 'object') continue;
                    const item = { ...itemRaw };
                    delete item.id;
                    delete item.timestamp;

                    const ms = Number(item.clientCreatedAtMs);
                    const dateObj = toJsDate(item.date) || (Number.isFinite(ms) ? new Date(ms) : null);
                    const now = new Date();
                    const finalDate = dateObj && Number.isFinite(dateObj.getTime()) ? dateObj : now;
                    const dateStr = `${finalDate.getFullYear()}-${String(finalDate.getMonth()+1).padStart(2,'0')}-${String(finalDate.getDate()).padStart(2,'0')} ${String(finalDate.getHours()).padStart(2,'0')}:${String(finalDate.getMinutes()).padStart(2,'0')}`;
                    item.date = dateStr;
                    item.clientCreatedAtMs = Number.isFinite(ms) ? ms : finalDate.getTime();
                    item.timestamp = serverTimestamp();

                    await addDoc(collection(db, COLLECTION_NAME), item);
                }

                showToast('å¯¼å…¥å®Œæˆ');
                event.target.value = '';
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('å¯¼å…¥å¤±è´¥');
            }
        };

        const formatWeight = (val) => {
            const n = Number(val);
            return Number.isFinite(n) ? n.toFixed(2) : '--';
        };

        const WEIGHT_PERIOD_LABEL = {
            morning: 'æ—©æ™¨ç©ºè…¹',
            night: 'æ™šé—´ç¡å‰'
        };

        const normalizePeriod = (log) => (log?.period === 'night' ? 'night' : 'morning');

        const getWeightLogs = (filter = 'all') => {
            const weights = appData.logs.filter(l => l.type === 'weight');
            if (filter === 'morning') return weights.filter(l => normalizePeriod(l) === 'morning');
            if (filter === 'night') return weights.filter(l => normalizePeriod(l) === 'night');
            return weights;
        };

        const formatDate = (value) => {
            const date = toJsDate(value);
            if (!date || !Number.isFinite(date.getTime())) return '--';
            return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
        };

        // åˆ‡æ¢è§†å›¾
        window.switchView = (viewName) => {
            // éšè—æ‰€æœ‰ View
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // æ˜¾ç¤ºç›®æ ‡ View
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            const mainContainer = document.getElementById('main-container');
            if (mainContainer) {
                mainContainer.scrollTop = 0;
            }
            
            // æ›´æ–°åº•éƒ¨å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewName) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-emerald-600');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-emerald-600');
                }
            });

            // å¦‚æœåˆ‡æ¢åˆ°è¶‹åŠ¿é¡µï¼Œé‡æ–°æ¸²æŸ“å›¾è¡¨
            if(viewName === 'trend') {
                if (typeof syncTrendLabels === 'function') syncTrendLabels();
                if (typeof window.filterChart === 'function') window.filterChart(30); // é»˜è®¤æ˜¾ç¤º30å¤©
            }

            // å¦‚æœåˆ‡æ¢åˆ°é¦–é¡µï¼Œæ ¹æ®å½“å‰æ—¶é—´è‡ªåŠ¨è®¾ç½®ä½“é‡è®°å½•æ—¶æ®µ
            if(viewName === 'home') {
                const now = new Date();
                const hour = now.getHours();
                // å‡Œæ™¨0ç‚¹åˆ°ä¸­åˆ12ç‚¹å‰ -> æ—©æ™¨ç©ºè…¹
                // ä¸­åˆ12ç‚¹åˆ°å‡Œæ™¨0ç‚¹ -> æ™šé—´ç¡å‰
                const autoPeriod = (hour >= 0 && hour < 12) ? 'morning' : 'night';
                setWeightPeriod(autoPeriod);
            }
        };

        // å†å²ç­›é€‰æ ‡ç­¾
        window.setWeightHistoryFilter = (filter) => {
            appData.weightHistoryFilter = filter;
            if (els.weightHistoryTabs) {
                els.weightHistoryTabs.querySelectorAll('button').forEach(btn => {
                    const active = btn.getAttribute('onclick')?.includes(`'${filter}'`);
                    if (active) {
                        btn.className = "flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-sm transition-all";
                    } else {
                        btn.className = "flex-1 px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all";
                    }
                });
            }
            renderWeightHistoryModal();
        };

        // ä½“é‡è®°å½•æ—¶æ®µåˆ‡æ¢ï¼ˆæ—©æ™¨/ç¡å‰ï¼‰
        window.setWeightPeriod = (period) => {
            appData.weightInputPeriod = period === 'night' ? 'night' : 'morning';
            if (els.btnPeriodMorning && els.btnPeriodNight) {
                if (appData.weightInputPeriod === 'morning') {
                    els.btnPeriodMorning.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnPeriodNight.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium text-gray-500 transition-all";
                } else {
                    els.btnPeriodNight.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow text-amber-600";
                    els.btnPeriodMorning.className = "flex-1 px-3 py-2 rounded-lg text-sm font-medium text-gray-500 transition-all";
                }
            }
        };

        // è®¾ç½®è¾“å…¥å•ä½ (Kg/Jin)
        window.setUnit = (unit) => {
            appData.currentUnit = unit;
            const btnKg = document.getElementById('btn-unit-kg');
            const btnJin = document.getElementById('btn-unit-jin');
            
            if(unit === 'kg') {
                btnKg.className = "px-3 py-1.5 rounded-lg text-xs font-semibold transition-all bg-white shadow text-amber-600";
                btnJin.className = "px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-500 transition-all";
            } else {
                btnJin.className = "px-3 py-1.5 rounded-lg text-xs font-semibold transition-all bg-white shadow text-amber-600";
                btnKg.className = "px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-500 transition-all";
            }
        };

        // ================= æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ =================

        // 1. è·å–æ•°æ® (è¯»å–)
        async function fetchLogs() {
            try {
                let querySnapshot;
                try {
                    const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'), limit(800));
                    querySnapshot = await getDocs(q);
                } catch (e) {
                    console.warn('fetchLogs orderBy(timestamp) failed, fallback to orderBy(date)', e);
                    const q = query(collection(db, COLLECTION_NAME), orderBy('date', 'desc'), limit(800));
                    querySnapshot = await getDocs(q);
                }
                
                appData.logs = [];
                querySnapshot.forEach((doc) => {
                    appData.logs.push({ id: doc.id, ...doc.data() });
                });

                appData.logs.sort((a, b) => getLogDateMs(b) - getLogDateMs(a));

                renderHome();
                renderCalcHistory();
                updateTodayMealStatus();
            } catch (error) {
                console.error("Error fetching logs: ", error);
                showToast("æ•°æ®åŠ è½½å¤±è´¥");
            }
        }

        // 2. æ¸²æŸ“é¦–é¡µ
        function renderHome() {
            // è®¾ç½®å½“å‰æ—¥æœŸ
            const now = new Date();
            document.getElementById('current-date').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;

            // è¿‡æ»¤å‡ºä½“é‡è®°å½•ï¼ˆé¦–é¡µæŒ‡æ ‡ä»…çœ‹æ—©æ™¨ç©ºè…¹ï¼‰
            const morningWeightLogs = getWeightLogs('morning');

            if (morningWeightLogs.length > 0) {
                const latest = morningWeightLogs[0];
                els.displayWeight.innerText = formatWeight(latest.value);
                const latestDate = toJsDate(latest.date) || toJsDate(latest.timestamp);
                if (latestDate && Number.isFinite(latestDate.getTime())) {
                    const periodLabel = WEIGHT_PERIOD_LABEL[normalizePeriod(latest)] || '';
                    els.lastRecordTime.innerText = `è®°å½•äº ${String(latestDate.getHours()).padStart(2, '0')}:${String(latestDate.getMinutes()).padStart(2, '0')} Â· ${periodLabel}`;
                } else {
                    els.lastRecordTime.innerText = `è®°å½•äº --:--`;
                }
                
                // ä½“é‡å˜åŒ–ï¼ˆä¸ä¸Šä¸€æ¡å¯¹æ¯”ï¼‰
                if (morningWeightLogs.length > 1) {
                    const prev = morningWeightLogs[1];
                    const diff = latest.value - prev.value;
                    const sign = diff > 0 ? '+' : '';
                    els.weightChange.innerText = `${sign}${diff.toFixed(2)} kg`;
                    els.weightChangeDesc.innerText = `è¾ƒä¸Šä¸€æ¡ ${formatDate(prev.date || prev.timestamp)}`;
                    if (diff > 0) {
                        els.weightTrendBadge.innerText = 'ä¸Šå‡';
                        els.weightTrendBadge.className = 'bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full';
                    } else if (diff < 0) {
                        els.weightTrendBadge.innerText = 'ä¸‹é™';
                        els.weightTrendBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                    } else {
                        els.weightTrendBadge.innerText = 'æŒå¹³';
                        els.weightTrendBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                    }
                } else {
                    els.weightChange.innerText = '--';
                    els.weightChangeDesc.innerText = 'ç­‰å¾…æ–°è®°å½•';
                    els.weightTrendBadge.innerText = '-';
                    els.weightTrendBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                }

                if (els.weightChangeExtra) {
                    const cutoff = new Date();
                    cutoff.setDate(cutoff.getDate() - 7);
                    const cutoffMs = cutoff.getTime();
                    const last7 = morningWeightLogs
                        .filter(l => getLogDateMs(l) >= cutoffMs)
                        .sort((a, b) => getLogDateMs(a) - getLogDateMs(b));
                    if (last7.length >= 2) {
                        const first7 = last7[0];
                        const last7Item = last7[last7.length - 1];
                        const diff7 = Number(last7Item.value) - Number(first7.value);
                        const sign7 = diff7 > 0 ? '+' : '';
                        const avg7 = last7.reduce((sum, x) => sum + Number(x.value || 0), 0) / last7.length;
                        els.weightChangeExtra.innerText = `è¿‘7å¤© ${sign7}${diff7.toFixed(2)} kg Â· å‡å€¼ ${avg7.toFixed(2)} kgï¼ˆ${last7.length}æ¡ï¼‰`;
                    } else if (last7.length === 1) {
                        els.weightChangeExtra.innerText = 'è¿‘7å¤©ä»…1æ¡è®°å½•';
                    } else {
                        els.weightChangeExtra.innerText = 'è¿‘7å¤©æš‚æ— è®°å½•';
                    }
                }
                
                // è®¡ç®— BMI
                const heightM = appData.userHeight / 100;
                const bmi = latest.value / (heightM * heightM);
                els.displayBMI.innerText = bmi.toFixed(2);
                
                // BMI çŠ¶æ€ & è¿›åº¦æ¡
                let status = "æ­£å¸¸";
                let nextText = "ä¿æŒå½“å‰çŠ¶æ€";
                const segments = [
                    { label: 'åç˜¦', min: 0, max: 18.5, color: 'text-sky-600' },
                    { label: 'æ­£å¸¸', min: 18.5, max: 24, color: 'text-emerald-600' },
                    { label: 'è¿‡é‡', min: 24, max: 27, color: 'text-amber-600' },
                    { label: 'è‚¥èƒ–', min: 27, max: 40, color: 'text-rose-600' }
                ];

                if(bmi < 18.5) {
                    status = "åç˜¦";
                    nextText = `è·ç¦»â€œæ­£å¸¸â€è¿˜å·® ${(18.5 - bmi).toFixed(2)}`;
                } else if(bmi >= 18.5 && bmi < 24) {
                    status = "æ­£å¸¸";
                    nextText = `è·ç¦»â€œè¿‡é‡â€è¿˜æœ‰ ${(24 - bmi).toFixed(2)}`;
                } else if(bmi >= 24 && bmi < 27) {
                    status = "è¿‡é‡";
                    nextText = `è·ç¦»â€œè‚¥èƒ–â€è¿˜æœ‰ ${(27 - bmi).toFixed(2)}`;
                } else {
                    status = "è‚¥èƒ–";
                    nextText = 'å»ºè®®å°½å¿«æ§åˆ¶ä½“é‡';
                }
                els.bmiStatus.className = `text-xs mt-1 font-semibold ${segments.find(s => status.includes(s.label))?.color || 'text-emerald-700'}`;
                els.bmiStatus.innerText = status;
                if (els.bmiNext) els.bmiNext.innerText = nextText;

                // è¿›åº¦æ¡ä½ç½®ï¼š0-40 çº¿æ€§ï¼Œ18.5/24/27 ä½ç½®è´´åˆåˆ»åº¦
                const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
                const bmiForBar = clamp(bmi, 0, 40);
                const percent = (bmiForBar / 40) * 100;
                if (els.bmiProgressIndicator) {
                    els.bmiProgressIndicator.style.left = `${percent}%`;
                }
            } else {
                els.displayWeight.innerText = "--";
                els.bmiStatus.innerText = "æœªçŸ¥";
                if (els.bmiNext) els.bmiNext.innerText = "";
                if (els.bmiProgressIndicator) els.bmiProgressIndicator.style.left = '0%';
            }

            // æ¸²æŸ“æœ€è¿‘å¤©æ±‡æ€» (é»˜è®¤7å¤©)
            els.recentList.innerHTML = "";
            const recentDays = buildDailyAggregation(appData.logs).slice(0, 7);
            if (!recentDays.length) {
                els.recentList.innerHTML = '<li class="text-center text-gray-400 py-6"><i class="fas fa-inbox text-3xl mb-2 block opacity-50"></i>æš‚æ— ä½“é‡è®°å½•</li>';
            } else {
                recentDays.forEach((day, index) => {
                    const morningVal = day.morning ? formatWeight(day.morning.value) : '--';
                    const nightVal = day.night ? formatWeight(day.night.value) : '--';
                    const lunch = day.lunch || '--';
                    const dinner = day.dinner || '--';
                    const workout = day.workout || '--';
                    const isToday = day.ymd === getYmd(Date.now());
                    const li = document.createElement('li');
                    li.className = `bg-gradient-to-r ${isToday ? 'from-emerald-50 to-teal-50 border-emerald-200' : 'from-slate-50 to-indigo-50 border-indigo-100'} border rounded-2xl px-4 py-3 shadow-sm`;
                    li.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl ${isToday ? 'bg-gradient-to-br from-emerald-400 to-teal-500 text-white' : 'bg-gradient-to-br from-slate-200 to-indigo-200 text-indigo-600'} flex items-center justify-center shadow-sm">
                                    <i class="fas fa-calendar-day text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800">${day.ymd} ${isToday ? '<span class="text-xs text-emerald-600 bg-emerald-100 px-1.5 py-0.5 rounded ml-1">ä»Šå¤©</span>' : ''}</p>
                                    <div class="flex items-center gap-2 text-xs text-gray-500 mt-0.5">
                                        <span class="flex items-center gap-1"><i class="fas fa-sun text-amber-400"></i>${morningVal}</span>
                                        <span class="flex items-center gap-1"><i class="fas fa-moon text-indigo-400"></i>${nightVal}</span>
                                        <span class="text-gray-300">kg</span>
                                    </div>
                                </div>
                            </div>
                            <button class="text-gray-400 hover:text-emerald-600 w-9 h-9 rounded-xl hover:bg-emerald-50 flex items-center justify-center transition-all" onclick="openDailyEditModal('${day.ymd}')">
                                <i class="fas fa-pen text-sm"></i>
                            </button>
                        </div>
                        <div class="text-[11px] text-gray-500 space-y-1 pl-[52px]">
                            <p class="truncate"><span class="text-gray-400">åˆé¤</span> ${lunch}</p>
                            <p class="truncate"><span class="text-gray-400">æ™šé¤</span> ${dinner}</p>
                            <p class="truncate"><span class="text-gray-400">è¿åŠ¨</span> ${workout}</p>
                        </div>
                    `;
                    els.recentList.appendChild(li);
                });
            }
        }

        // åŠ è½½ä»Šæ—¥åˆ/æ™šé¤å¤‡æ³¨åˆ°è¾“å…¥æ¡†
        function fillTodayMealNotes() {
            const today = getYmd(Date.now());
            if (!today) return;
            const map = getMealNotesMap();
            const note = map[today] || {};
            if (mealNoteEls.lunch) mealNoteEls.lunch.value = note.lunch || '';
            if (mealNoteEls.dinner) mealNoteEls.dinner.value = note.dinner || '';
            if (mealNoteEls.workout) mealNoteEls.workout.value = note.workout || '';
        }

        function setMealStatusBadge(type, filled) {
            const el = mealStatusEls[type];
            if (!el) return;
            if (filled) {
                el.innerText = 'å·²å¡«';
                el.className = 'text-[11px] px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100';
            } else {
                el.innerText = 'æœªå¡«';
                el.className = 'text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-500';
            }
        }

        function updateTodayMealStatus() {
            const today = getYmd(Date.now());
            if (!today) return;
            const map = getMealNotesMap();
            const note = map[today] || {};
            setMealStatusBadge('lunch', !!(note.lunch && note.lunch.trim()));
            setMealStatusBadge('dinner', !!(note.dinner && note.dinner.trim()));
            setMealStatusBadge('workout', !!(note.workout && note.workout.trim()));
        }

        // 3. ä¿å­˜ä½“é‡ (å†™å…¥)
        window.saveWeight = async () => {
            const rawVal = parseFloat(els.inputWeight.value);

            if (!Number.isFinite(rawVal) || rawVal <= 0) {
                showToast("è¯·è¾“å…¥ä½“é‡æ•°å€¼");
                return;
            }

            // åŠ è½½åŠ¨ç”»çŠ¶æ€
            const btn = document.getElementById('btn-save-weight');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...`;
            btn.disabled = true;

            // å•ä½è½¬æ¢ï¼šå¦‚æœæ˜¯æ–¤ï¼Œé™¤ä»¥2è½¬ä¸ºKGå­˜å…¥æ•°æ®åº“
            const weightKg = appData.currentUnit === 'jin' ? rawVal / 2 : rawVal;
            const weightFixed = Number(weightKg.toFixed(2));

            if (!Number.isFinite(weightFixed) || weightFixed < 20 || weightFixed > 300) {
                showToast("ä½“é‡èŒƒå›´å¼‚å¸¸ï¼ˆ20-300kgï¼‰");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            const now = new Date();
            // æ ¼å¼åŒ–ä¸º YYYY-MM-DD HH:mm
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            const todayYmd = getYmd(now);
            const existing = appData.logs
                .filter(l => l.type === 'weight')
                .filter(l => normalizePeriod(l) === appData.weightInputPeriod)
                .filter(l => getYmd(l.date || l.timestamp || l.clientCreatedAtMs) === todayYmd)
                .sort((a, b) => getLogDateMs(b) - getLogDateMs(a))[0];

            const newDoc = {
                date: dateStr,
                type: "weight",
                value: weightFixed,
                period: appData.weightInputPeriod,
                note: "",
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                if (existing?.id) {
                    const periodLabel = WEIGHT_PERIOD_LABEL[appData.weightInputPeriod] || '';
                    const ok = confirm(`ä»Šå¤©å·²è®°å½•è¿‡ã€${periodLabel}ã€‘ä½“é‡ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`);
                    if (!ok) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        return;
                    }
                    await updateDoc(doc(db, COLLECTION_NAME, existing.id), newDoc);
                    showToast("å·²è¦†ç›–ä»Šæ—¥è®°å½•");
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), newDoc);
                    showToast("ä½“é‡è®°å½•æˆåŠŸ");
                }
                
                // æ¸…ç©ºè¾“å…¥
                els.inputWeight.value = "";
                
                // åˆ·æ–°æ•°æ®å¹¶åˆ‡å›é¦–é¡µ
                await fetchLogs();
                switchView('home');
            } catch (e) {
                console.error("Error adding document: ", e);
                showToast("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // 4. ä¿å­˜é¥®é£Ÿ/è®¡ç®—ç»“æœ (å†™å…¥)
        window.saveFoodLog = async () => {
            if (!els.calcInput) {
                showToast("è¯¥ç‰ˆæœ¬æœªå¯ç”¨çƒ­é‡è¾“å…¥");
                return;
            }
            const kcal = parseFloat(els.calcInput.value);
            if (!kcal) return;

            const runMins = Math.round((kcal / 100) * 9);
            const dumbbellMins = Math.round((kcal / 100) * 15);
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            const newDoc = {
                date: dateStr,
                type: "food",
                value: kcal, // å­˜çƒ­é‡
                note: `æ‘„å…¥ ${kcal} Kcal (è·‘æ­¥çº¦ ${runMins} åˆ†é’Ÿ / å“‘é“ƒçº¦ ${dumbbellMins} åˆ†é’Ÿ)`,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, COLLECTION_NAME), newDoc);
                showToast("é¥®é£Ÿè®°å½•å·²ä¿å­˜");
                els.calcInput.value = "";
                els.calcRun.innerText = "0";
                els.calcDumbbell.innerText = "0";
                await fetchLogs(); // åå°åˆ·æ–°
            } catch (e) {
                showToast("ä¿å­˜å¤±è´¥");
            }
        };

        // 5. è®¡ç®—å™¨é€»è¾‘
        els.calcInput?.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if(val) {
                // 200gè‹¹æœ=100kcal=è·‘æ­¥9åˆ†é’Ÿ
                // æ¯”ä¾‹ï¼š100kcal = 9 mins
                const run = (val / 100) * 9;
                const dumbbell = (val / 100) * 15; // ç²—ç•¥ä¼°ç®—
                els.calcRun.innerText = Math.round(run);
                els.calcDumbbell.innerText = Math.round(dumbbell);
            } else {
                els.calcRun.innerText = 0;
                els.calcDumbbell.innerText = 0;
            }
        });

        // 6.1 é£Ÿæå•ä½åˆ‡æ¢
        window.setFoodUnit = (unit) => {
            appData.foodUnit = unit;
            const gBtn = document.getElementById('btn-unit-g');
            const mlBtn = document.getElementById('btn-unit-ml');
            if (unit === 'g') {
                gBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600";
                mlBtn.className = "px-3 py-1 rounded-md text-gray-500";
            } else {
                mlBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600";
                gBtn.className = "px-3 py-1 rounded-md text-gray-500";
            }
        };

        // 6.2 çƒ­é‡å•ä½åˆ‡æ¢
        window.setFoodHeatUnit = (unit) => {
            appData.foodHeatUnit = unit;
            const kcalBtn = document.getElementById('btn-heat-kcal');
            const kjBtn = document.getElementById('btn-heat-kj');
            if (unit === 'kcal') {
                kcalBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600 border border-emerald-100";
                kjBtn.className = "px-3 py-1 rounded-md text-gray-500 border border-gray-200";
            } else {
                kjBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600 border border-emerald-100";
                kcalBtn.className = "px-3 py-1 rounded-md text-gray-500 border border-gray-200";
            }
        };

        // 5.2 è®¡ç®—é£Ÿæçƒ­é‡ï¼ˆåŸºç¡€é€»è¾‘ï¼Œæ”¯æŒä»…è®¡ç®—/è®¡ç®—å¹¶è®°å½•ï¼‰
        function calcFoodBase() {
            const name = (els.foodName.value || 'æœªå‘½åé£Ÿæ').trim();
            const amount = parseFloat(els.foodAmount.value);
            const per100 = parseFloat(els.foodUnitKcal.value);
            if (!amount || !per100) {
                showToast("è¯·å¡«å†™æ•°é‡å’Œå•ä½çƒ­é‡");
                return null;
            }
            const totalPer100 = (amount * per100) / 100;
            const isKjPer100 = appData.foodHeatUnit === 'kj';
            // kJ -> kcal æŒ‰ 4.184 æ¢ç®—ï¼›kcal ç›´æ¥ä½¿ç”¨
            const totalKcalRaw = isKjPer100 ? (totalPer100 / 4.184) : totalPer100;
            const totalKcalInt = Math.round(totalKcalRaw);
            els.foodTotal.innerText = String(totalKcalInt);

            // è¿åŠ¨æŠ˜ç®—ï¼šè·‘æ­¥/è·³ç»³/å“‘é“ƒ
            const run = (totalKcalInt / 100) * 9;
            const rope = (totalKcalInt / 100) * 7;
            const dumbbell = (totalKcalInt / 100) * 15;
            const runInt = Math.round(run);
            const ropeInt = Math.round(rope);
            const dumbbellInt = Math.round(dumbbell);
            els.calcRun.innerText = runInt;
            els.calcRope.innerText = ropeInt;
            els.calcDumbbell.innerText = dumbbellInt;

            return {
                name,
                amount,
                per100,
                isKjPer100,
                totalKcalInt,
                runInt,
                ropeInt,
                dumbbellInt
            };
        }

        // ä»…è®¡ç®—ï¼ˆä¸å…¥åº“ï¼‰
        window.calcFoodOnly = () => {
            const result = calcFoodBase();
            if (!result) return;
        };

        // è®¡ç®—å¹¶è®°å½•é£Ÿæçƒ­é‡
        window.calcFoodKcal = async () => {
            const result = calcFoodBase();
            if (!result) return;

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).toString().padStart(2,'0')}:${String(now.getMinutes()).toString().padStart(2,'0')}`;

            const newDoc = {
                date: dateStr,
                type: "food_calc",
                value: result.totalKcalInt,
                note: `${result.name} Â· ${result.amount}${appData.foodUnit} Â· ${result.per100}${result.isKjPer100 ? 'kJ' : 'kcal'}/100${appData.foodUnit} Â· è·‘${result.runInt}åˆ† / ç»³${result.ropeInt}åˆ† / å“‘${result.dumbbellInt}åˆ†`,
                foodName: result.name,
                amount: result.amount,
                unit: appData.foodUnit,
                per100: result.per100,
                per100Unit: result.isKjPer100 ? 'kJ' : 'kcal',
                run: result.runInt,
                rope: result.ropeInt,
                dumbbell: result.dumbbellInt,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };
            try {
                await addDoc(collection(db, COLLECTION_NAME), newDoc);
                showToast("å·²è®°å½•é£Ÿæçƒ­é‡");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        };

        // 5.3 æ¸²æŸ“é£Ÿæçƒ­é‡å†å²
        function renderCalcHistory() {
            const wrap = els.calcHistory;
            wrap.innerHTML = "";
            const items = appData.logs.filter(l => l.type === 'food_calc').slice(0, 30);
            if (!items.length) {
                wrap.innerHTML = '<div class="text-center text-gray-400 py-4">æš‚æ— å†å²</div>';
                return;
            }
            items.forEach(item => {
                const subtitle = item.note || `${item.foodName || 'é£Ÿæ'} Â· ${item.amount || '-'}${item.unit || ''}`;
                const row = document.createElement('div');
                row.className = "border border-gray-100 rounded-2xl p-4 flex items-center justify-between shadow-sm";
                row.innerHTML = `
                    <div>
                        <p class="text-base font-semibold text-gray-900">${item.foodName || 'é£Ÿæ'} â‰ˆ ${item.value} kcal</p>
                        <p class="text-xs text-gray-500 mt-1">${subtitle}</p>
                        <p class="text-[11px] text-gray-400 mt-1">${formatDate(item.date || item.timestamp)}</p>
                    </div>
                    <button class="text-red-500 text-sm px-3 py-2 rounded-lg hover:bg-red-50" onclick="deleteHistoryItem('${item.id}', this)">åˆ é™¤</button>
                `;
                wrap.appendChild(row);
            });
        }

        // 5.4 åˆ é™¤å•æ¡å†å²
        window.deleteHistoryItem = async (id, btnEl) => {
            try {
                if (btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                showToast("å·²åˆ é™¤");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("åˆ é™¤å¤±è´¥");
            } finally {
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.innerText = 'åˆ é™¤';
                }
            }
        };

        // åˆ é™¤å•æ¡ä½“é‡è®°å½•
        window.deleteWeightItem = async (id, btnEl) => {
            try {
                const ok = confirm('ç¡®å®šåˆ é™¤è¿™æ¡ä½“é‡è®°å½•å—ï¼Ÿ');
                if (!ok) return;
                if (btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                showToast("å·²åˆ é™¤");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("åˆ é™¤å¤±è´¥");
            } finally {
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.innerText = 'åˆ é™¤';
                }
            }
        };

        // 5.5 æ¸…ç©ºå†å²
        window.clearCalcHistory = async () => {
            try {
                const snap = await getDocs(collection(db, COLLECTION_NAME));
                const targets = snap.docs.filter(d => d.data().type === 'food_calc');
                await Promise.all(targets.map(d => deleteDoc(doc(db, COLLECTION_NAME, d.id))));
                showToast("å·²æ¸…ç©ºå†å²");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("æ¸…ç©ºå¤±è´¥");
            }
        };

        // 5.6 æ‰‹åŠ¨åˆ·æ–°å†å²
        window.refreshCalcHistory = () => {
            renderCalcHistory();
        };

        // 6. å›¾è¡¨é€»è¾‘
        function syncTrendLabels() {
            if (appData.trendMode === 'weight') {
                if (els.trendModeDesc) els.trendModeDesc.innerText = 'ä½“é‡æ›²çº¿ Â· ä»…æ—©æ™¨è®°å½•';
                if (els.trendCardLabel1) els.trendCardLabel1.innerText = 'å½“å‰ä½“é‡';
                if (els.trendCardLabel2) els.trendCardLabel2.innerText = 'åŒºé—´å˜åŒ–';
                if (els.statMaxLabel) els.statMaxLabel.innerText = 'æœ€é«˜ä½“é‡';
                if (els.statMinLabel) els.statMinLabel.innerText = 'æœ€ä½ä½“é‡';
            } else {
                if (els.trendModeDesc) els.trendModeDesc.innerText = 'ä»£è°¢æ›²çº¿ Â· æ˜¨æ™šå‡æ¬¡æ™¨ï¼Œå•ä½æ–¤';
                if (els.trendCardLabel1) els.trendCardLabel1.innerText = 'å½“å‰ä»£è°¢';
                if (els.trendCardLabel2) els.trendCardLabel2.innerText = 'åŒºé—´ä»£è°¢å˜åŒ–';
                if (els.statMaxLabel) els.statMaxLabel.innerText = 'æœ€é«˜ä»£è°¢';
                if (els.statMinLabel) els.statMinLabel.innerText = 'æœ€ä½ä»£è°¢';
            }
        }

        window.setTrendMode = (mode) => {
            appData.trendMode = mode === 'metabolic' ? 'metabolic' : 'weight';
            if (els.trendBtnWeight && els.trendBtnMetabolic) {
                if (appData.trendMode === 'weight') {
                    els.trendBtnWeight.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnWeight.classList.remove('text-gray-600', 'hover:bg-gray-50');
                    els.trendBtnMetabolic.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnMetabolic.classList.add('text-gray-600', 'hover:bg-gray-50');
                } else {
                    els.trendBtnMetabolic.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnMetabolic.classList.remove('text-gray-600', 'hover:bg-gray-50');
                    els.trendBtnWeight.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-teal-500', 'text-white', 'shadow-sm');
                    els.trendBtnWeight.classList.add('text-gray-600', 'hover:bg-gray-50');
                }
            }

            syncTrendLabels();

            // é‡æ–°æ¸²æŸ“å½“å‰åŒºé—´
            if (typeof window.filterChart === 'function') window.filterChart(appData.trendRange || 30);
        };

        window.filterChart = (days) => {
            appData.trendRange = days;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => {
                const range = parseInt(b.dataset.range);
                if (range === days) {
                    b.classList.remove('bg-white', 'text-gray-600', 'border', 'border-gray-200');
                    b.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-sm');
                } else {
                    b.classList.add('bg-white', 'text-gray-600', 'border', 'border-gray-200');
                    b.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500', 'text-white', 'shadow-sm');
                }
            });

            renderChart(days);
        };

        function formatJin(valKg) {
            const n = Number(valKg);
            if (!Number.isFinite(n)) return '--';
            return (n * 2).toFixed(2);
        }

        function getYmdFromMs(ms) {
            const d = new Date(ms);
            return getYmd(d);
        }

        function getPrevYmd(ms) {
            const d = new Date(ms);
            d.setDate(d.getDate() - 1);
            return getYmd(d);
        }

        function pickLatestByDate(logs, period) {
            const map = {};
            logs
                .filter(l => normalizePeriod(l) === period)
                .forEach(l => {
                    const ms = getLogDateMs(l);
                    const ymd = getYmdFromMs(ms);
                    if (!map[ymd] || ms > map[ymd].ms) {
                        map[ymd] = { ...l, __ms: ms };
                    }
                });
            return map;
        }

        function renderChart(days) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const cutoffMs = days !== 999 ? (() => {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                return cutoff.getTime();
            })() : null;
            const unitLabel = appData.trendMode === 'metabolic' ? 'æ–¤' : 'kg';
            
            const allWeights = getWeightLogs('all').sort((a, b) => getLogDateMs(a) - getLogDateMs(b));
            let dataPoints = [];
            let labels = [];
            let values = [];

            if (appData.trendMode === 'weight') {
                const weightData = allWeights
                    .filter(l => normalizePeriod(l) === 'morning')
                    .filter(d => !cutoffMs || getLogDateMs(d) >= cutoffMs);

                labels = weightData.map(d => {
                    const date = new Date(getLogDateMs(d));
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });
                values = weightData.map(d => Number(d.value));
                dataPoints = weightData.map(d => ({ ms: getLogDateMs(d), value: Number(d.value), raw: d }));
            } else {
                const morningMap = pickLatestByDate(allWeights, 'morning');
                const nightMap = pickLatestByDate(allWeights, 'night');
                const mornings = Object.values(morningMap).sort((a, b) => a.__ms - b.__ms);

                mornings.forEach(m => {
                    if (cutoffMs && m.__ms < cutoffMs) return;
                    const prevNight = nightMap[getPrevYmd(m.__ms)];
                    if (!prevNight) return;
                    const diffJin = Number(((Number(prevNight.value) - Number(m.value)) * 2).toFixed(2));
                    labels.push(`${(new Date(m.__ms)).getMonth() + 1}/${(new Date(m.__ms)).getDate()}`);
                    values.push(diffJin);
                    dataPoints.push({ ms: m.__ms, value: diffJin, raw: m, prev: prevNight });
                });
            }

            // æ›´æ–°è¶‹åŠ¿åŒºé—´å¡ç‰‡
            if (els.trendCurrentWeight && els.trendCurrentTime && els.trendChange && els.trendChangeBadge) {
                const rangeText = days === 999 ? 'å…¨éƒ¨å†å²' : `æœ€è¿‘${days}å¤©`;
                if (!dataPoints.length) {
                    els.trendCurrentWeight.innerText = '--';
                    els.trendCurrentTime.innerText = '--';
                    els.trendChange.innerText = '--';
                    if (els.trendChangeDesc) els.trendChangeDesc.innerText = `${rangeText} Â· æš‚æ— è®°å½•`;
                    els.trendChangeBadge.innerText = '-';
                    els.trendChangeBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                } else {
                    const first = dataPoints[0];
                    const last = dataPoints[dataPoints.length - 1];
                    els.trendCurrentWeight.innerText = `${last.value.toFixed(2)} ${unitLabel}`;
                    els.trendCurrentTime.innerText = formatDate(last.raw?.date || last.raw?.timestamp || last.ms);

                    const diff = Number(last.value) - Number(first.value);
                    const sign = diff > 0 ? '+' : '';
                    els.trendChange.innerText = `${sign}${diff.toFixed(2)} ${unitLabel}`;
                    if (diff > 0) {
                        els.trendChangeBadge.innerText = appData.trendMode === 'weight' ? 'ä¸Šå‡' : 'å¢åŠ ';
                        els.trendChangeBadge.className = appData.trendMode === 'weight'
                            ? 'bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full'
                            : 'bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full';
                    } else if (diff < 0) {
                        els.trendChangeBadge.innerText = appData.trendMode === 'weight' ? 'ä¸‹é™' : 'å‡å°‘';
                        els.trendChangeBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                    } else {
                        els.trendChangeBadge.innerText = 'æŒå¹³';
                        els.trendChangeBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                    }

                    const firstTime = formatDate(first.raw?.date || first.raw?.timestamp || first.ms);
                    const lastTime = formatDate(last.raw?.date || last.raw?.timestamp || last.ms);
                    if (els.trendChangeDesc) {
                        els.trendChangeDesc.innerText = dataPoints.length === 1
                            ? `${rangeText} Â· ${firstTime}ï¼ˆä»…1æ¡ï¼‰`
                            : `${rangeText} Â· ${firstTime} â†’ ${lastTime}`;
                    }
                }
            }

            // æ›´æ–°ç»Ÿè®¡
            const statUnit = appData.trendMode === 'metabolic' ? 'æ–¤' : 'kg';
            if(values.length > 0) {
                document.getElementById('stat-max').innerText = `${Math.max(...values).toFixed(2)} ${statUnit}`;
                document.getElementById('stat-min').innerText = `${Math.min(...values).toFixed(2)} ${statUnit}`;
            } else {
                document.getElementById('stat-max').innerText = '--';
                document.getElementById('stat-min').innerText = '--';
            }

            // é”€æ¯æ—§å›¾è¡¨
            if (chartInstance) chartInstance.destroy();

            // åˆ›å»ºæ–°å›¾è¡¨
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: appData.trendMode === 'weight' ? 'ä½“é‡ (kg)' : 'ä»£è°¢ (æ–¤)',
                        data: values,
                        borderColor: appData.trendMode === 'weight' ? '#059669' : '#f97316',
                        backgroundColor: appData.trendMode === 'weight' ? 'rgba(16, 185, 129, 0.12)' : 'rgba(249, 115, 22, 0.12)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: appData.trendMode === 'weight' ? '#059669' : '#f97316',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4 // å¹³æ»‘æ›²çº¿
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 7,
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: { borderDash: [5, 5], color: '#f3f4f6' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // ================= åˆå§‹åŒ– =================
        const init = () => {
            fetchLogs();
            // ç»‘å®š Tab åˆ‡æ¢ç‚¹å‡»äº‹ä»¶å·²åœ¨ HTML onclick ä¸­å¤„ç†
            // ç»‘å®š Toast äº‹ä»¶å·²åœ¨ HTML onclick ä¸­å¤„ç†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeWeightHistoryModal();
                }
            });
        };

        init();

    </script>
</body>
</html>
