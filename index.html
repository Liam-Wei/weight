<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iDiet Pro</title>

    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="MyWebSite" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* iOS 系统字体栈 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", sans-serif;
            /* 防止iOS点击高亮 */
            -webkit-tap-highlight-color: transparent;
        }
        /* 隐藏滚动条但保留滚动功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 底部安全区域适配 */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        /* 页面切换动画 */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden flex flex-col">

    <div class="h-12 w-full bg-transparent shrink-0"></div>

    <main id="main-container" class="flex-1 overflow-y-auto no-scrollbar px-6 pb-32 relative">
        
        <section id="view-home" class="view-section fade-in">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">健康概览</h1>
                    <p class="text-sm text-gray-500" id="current-date">加载中...</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                    <i class="fas fa-user"></i>
                </div>
            </header>

            <div class="bg-white rounded-3xl p-6 shadow-sm shadow-emerald-100/50 mb-6 border border-gray-100">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-gray-500 font-medium text-sm uppercase tracking-wider">最新体重</span>
                    <span class="bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full" id="weight-trend-badge">-</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <span id="display-weight" class="text-5xl font-extrabold text-gray-900">--</span>
                    <span class="text-xl text-gray-500">kg</span>
                </div>
                <p class="text-xs text-gray-400 mt-2" id="last-record-time">暂无记录</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-emerald-50 rounded-3xl p-5 shadow-sm border border-emerald-100">
                    <p class="text-emerald-700 text-sm mb-1">BMI 指数</p>
                    <h3 id="display-bmi" class="text-3xl font-bold text-gray-900">--</h3>
                    <p id="bmi-status" class="text-xs mt-1 text-emerald-700 opacity-80">未知</p>
                    <p id="bmi-next" class="text-[11px] text-gray-500 mt-1"></p>
                    <div class="mt-3">
                        <div class="relative h-3 rounded-full bg-gradient-to-r from-sky-200 via-emerald-200 via-amber-200 to-rose-200 overflow-visible">
                            <div id="bmi-progress-indicator" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-white border-2 border-emerald-600 shadow ring-2 ring-emerald-100 transition-all duration-300" style="left: 0%;"></div>
                            <div class="absolute inset-0 pointer-events-none">
                                <div id="bmi-tick-18" class="absolute w-[2px] h-full bg-white/60" style="left: 46.25%;"></div>
                                <div id="bmi-tick-24" class="absolute w-[2px] h-full bg-white/60" style="left: 60%;"></div>
                                <div id="bmi-tick-27" class="absolute w-[2px] h-full bg-white/60" style="left: 67.5%;"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 text-[10px] text-gray-500 mt-2 leading-4 text-center gap-1">
                            <!-- 单行等分，避免小屏重叠 -->
                            <span class="whitespace-nowrap">偏瘦</span>
                            <span class="whitespace-nowrap">正常</span>
                            <span class="whitespace-nowrap">过重</span>
                            <span class="whitespace-nowrap">肥胖</span>
                        </div>
                    </div>
                </div>
                <div class="bg-emerald-50 rounded-3xl p-5 shadow-sm border border-emerald-100 flex flex-col justify-center">
                    <p class="text-emerald-700 text-sm mb-1">体重变化</p>
                    <h3 id="weight-change" class="text-2xl font-bold text-gray-900">--</h3>
                    <p id="weight-change-desc" class="text-xs text-gray-400 mt-1">等待新记录</p>
                    <p id="weight-change-extra" class="text-xs text-gray-400 mt-1">--</p>
                </div>
            </div>

            <div id="home-add-card" class="bg-white rounded-3xl p-6 shadow-sm mb-6 border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg text-gray-900">记录体重</h3>
                    <div class="flex bg-gray-100 rounded-lg p-1 shrink-0">
                        <button onclick="setUnit('kg')" id="btn-unit-kg" class="px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600">KG</button>
                        <button onclick="setUnit('jin')" id="btn-unit-jin" class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all">斤</button>
                    </div>
                </div>

                <div class="flex bg-gray-100 rounded-lg p-1 mb-4">
                    <button onclick="setWeightPeriod('morning')" id="btn-period-morning" class="px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600">早晨空腹</button>
                    <button onclick="setWeightPeriod('night')" id="btn-period-night" class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all">晚间睡前</button>
                </div>

                <div class="flex items-center border-b-2 border-emerald-500 pb-2 mb-5">
                    <input type="number" id="input-weight" step="0.01" placeholder="0.00" class="w-full text-4xl font-bold bg-transparent outline-none text-gray-900">
                </div>

                <button onclick="saveWeight()" id="btn-save-weight" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform flex justify-center items-center hover:bg-emerald-700">
                    <span>保存记录</span>
                </button>
            </div>

            <div>
                <h3 class="font-bold text-lg mb-4 text-gray-900">最近记录</h3>
                <ul id="recent-list" class="space-y-3">
                    <li class="text-center text-gray-400 py-4">正在从云端加载...</li>
                </ul>
            </div>
        </section>

        <section id="view-trend" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold mb-6">趋势分析</h2>

            <div class="flex space-x-2 mb-6 overflow-x-auto no-scrollbar">
                <button data-range="7" onclick="filterChart(7)" class="filter-btn px-4 py-2 bg-emerald-50 text-emerald-700 rounded-full text-sm font-medium whitespace-nowrap">最近7天</button>
                <button data-range="30" onclick="filterChart(30)" class="filter-btn active px-4 py-2 bg-emerald-600 text-white rounded-full text-sm font-medium whitespace-nowrap">最近30天</button>
                <button data-range="60" onclick="filterChart(60)" class="filter-btn px-4 py-2 bg-emerald-50 text-emerald-700 rounded-full text-sm font-medium whitespace-nowrap">最近60天</button>
                <button data-range="999" onclick="filterChart(999)" class="filter-btn px-4 py-2 bg-emerald-50 text-emerald-700 rounded-full text-sm font-medium whitespace-nowrap">全部历史</button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100">
                    <p class="text-gray-500 text-sm mb-1">当前体重</p>
                    <h3 id="trend-current-weight" class="text-2xl font-bold text-gray-900">--</h3>
                    <p id="trend-current-time" class="text-xs text-gray-400 mt-1">--</p>
                </div>
                <div class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100 flex flex-col justify-center">
                    <div class="flex items-center justify-between">
                        <p class="text-gray-500 text-sm">区间变化</p>
                        <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full" id="trend-change-badge">-</span>
                    </div>
                    <h3 id="trend-change" class="text-2xl font-bold text-gray-900 mt-1">--</h3>
                    <p id="trend-change-desc" class="text-xs text-gray-400 mt-1">--</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-3xl shadow-sm h-80 relative mb-6">
                <canvas id="weightChart"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-orange-50 p-4 rounded-2xl">
                    <p class="text-orange-600 text-xs font-bold uppercase">最高体重</p>
                    <p id="stat-max" class="text-xl font-bold text-gray-900 mt-1">--</p>
                </div>
                <div class="bg-green-50 p-4 rounded-2xl">
                    <p class="text-green-600 text-xs font-bold uppercase">最低体重</p>
                    <p id="stat-min" class="text-xl font-bold text-gray-900 mt-1">--</p>
                </div>
            </div>

            <button onclick="openWeightHistoryModal()" class="w-full mt-4 bg-emerald-600 text-white py-3 rounded-2xl font-semibold shadow-sm active:scale-95 transition-transform hover:bg-emerald-700">
                查看全部历史
            </button>
        </section>

        <section id="view-calc" class="view-section hidden fade-in">
            <h2 class="text-2xl font-bold mb-6">热量换算</h2>
            
            <!-- 统一热量计算卡片（渐变） -->
            <div class="bg-white rounded-3xl p-6 shadow-sm mb-6 space-y-4 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900">食材热量 & 运动折算</h3>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <label class="text-sm text-gray-600">食品名称
                        <input id="food-name" type="text" placeholder="如：燕麦奶" class="mt-1 w-full rounded-2xl border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-500/30" />
                    </label>
                    <label class="text-sm text-gray-600">数量 (默认 g / ml)
                        <input id="food-amount" type="number" inputmode="decimal" placeholder="例如 250" class="mt-1 w-full rounded-2xl border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-500/30" />
                    </label>
                    <label class="text-sm text-gray-600">单位热量 (kJ / 100 单位)
                        <input id="food-unit-kcal" type="number" inputmode="decimal" placeholder="例如 54" class="mt-1 w-full rounded-2xl border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-500/30" />
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-gray-50 rounded-2xl px-4 py-3 flex items-center justify-between border border-gray-100">
                        <div>
                            <p class="text-xs text-gray-500">预估总热量</p>
                            <p class="text-3xl font-bold text-gray-900" id="food-total-kcal">0</p>
                        </div>
                        <i class="fas fa-utensils text-2xl text-gray-400"></i>
                    </div>
                    <div class="bg-gray-50 rounded-2xl px-4 py-3 grid grid-cols-3 gap-2 text-center border border-gray-100">
                        <div>
                            <p class="text-[11px] text-gray-500">跑步</p>
                            <p class="text-xl font-bold text-gray-900"><span id="calc-run">0</span><span class="text-xs ml-1 text-gray-500">分钟</span></p>
                        </div>
                        <div>
                            <p class="text-[11px] text-gray-500">跳绳</p>
                            <p class="text-xl font-bold text-gray-900"><span id="calc-rope">0</span><span class="text-xs ml-1 text-gray-500">分钟</span></p>
                        </div>
                        <div>
                            <p class="text-[11px] text-gray-500">哑铃</p>
                            <p class="text-xl font-bold text-gray-900"><span id="calc-dumbbell">0</span><span class="text-xs ml-1 text-gray-500">分钟</span></p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="calcFoodOnly()" class="w-full h-12 rounded-2xl bg-white text-emerald-600 font-semibold shadow-sm border border-emerald-100 active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-emerald-50">
                        <i class="fas fa-equals"></i> 计算
                    </button>
                    <button onclick="calcFoodKcal()" class="w-full h-12 rounded-2xl bg-emerald-600 text-white font-semibold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-emerald-700">
                        <i class="fas fa-calculator"></i> 记录
                    </button>
                </div>
            </div>

            <!-- 历史查询列表 -->
            <div class="bg-white rounded-3xl p-6 shadow-sm space-y-4 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">历史查询</p>
                        <h3 class="text-lg font-bold text-gray-900">食材热量记录</h3>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshCalcHistory()" class="text-gray-600 text-sm px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">刷新</button>
                        <button onclick="clearCalcHistory()" class="text-red-600 text-sm px-3 py-2 rounded-lg bg-red-50 hover:bg-red-100">清空</button>
                    </div>
                </div>
                <div id="calc-history" class="space-y-3 text-sm text-gray-700">
                    <div class="text-center text-gray-400 py-4">暂无历史</div>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-200 pb-safe z-50">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchView('home')" class="nav-btn text-emerald-600 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[10px] font-medium">首页</span>
            </button>
            <button onclick="switchView('trend')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="trend">
                <i class="fas fa-chart-line text-xl"></i>
                <span class="text-[10px] font-medium">趋势</span>
            </button>
            <button onclick="switchView('calc')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full h-full justify-center active:scale-90 transition-transform" data-target="calc">
                <i class="fas fa-calculator text-xl"></i>
                <span class="text-[10px] font-medium">计算</span>
            </button>
        </div>
    </nav>

    <div id="weight-history-modal" class="fixed inset-0 hidden z-[60]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeWeightHistoryModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-lg sm:rounded-3xl rounded-t-3xl shadow-xl border border-gray-100 max-h-[80vh] flex flex-col">
                <div class="px-6 py-4 border-b border-gray-100 space-y-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">全部历史</p>
                            <h3 class="text-lg font-bold text-gray-900">每日体重</h3>
                        </div>
                        <button class="w-9 h-9 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center" onclick="closeWeightHistoryModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="weight-history-tabs" class="flex gap-2">
                        <button onclick="setWeightHistoryFilter('morning')" class="px-3 py-2 rounded-xl text-sm font-semibold bg-emerald-600 text-white shadow-sm">早晨空腹</button>
                        <button onclick="setWeightHistoryFilter('night')" class="px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700">晚间睡前</button>
                        <button onclick="setWeightHistoryFilter('all')" class="px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700">全部</button>
                    </div>
                    <div class="space-y-2">
                        <div class="grid grid-cols-4 gap-2">
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700 active:scale-95 transition-transform" onclick="copyWeightHistoryToClipboard('all')">复制全部</button>
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700 active:scale-95 transition-transform" onclick="copyWeightHistoryToClipboard('7d')">近7天</button>
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700 active:scale-95 transition-transform" onclick="copyWeightHistoryToClipboard('1m')">近1月</button>
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700 active:scale-95 transition-transform" onclick="copyWeightHistoryToClipboard('2m')">近2月</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="weight-history-copy-range" class="flex-1 px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700">
                                <option value="3m">近3个月</option>
                                <option value="4m">近4个月</option>
                                <option value="5m">近5个月</option>
                                <option value="6m">近半年</option>
                                <option value="1y">近一年</option>
                                <option value="all">全部历史</option>
                            </select>
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-900 text-white active:scale-95 transition-transform" onclick="copyWeightHistoryToClipboard(document.getElementById('weight-history-copy-range')?.value || 'all')">复制</button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700 active:scale-95 transition-transform" onclick="downloadWeightHistoryCsv(document.getElementById('weight-history-copy-range')?.value || 'all')">下载CSV</button>
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700 active:scale-95 transition-transform" onclick="downloadAllLogsJson()">下载JSON</button>
                            <button class="px-3 py-2 rounded-xl text-xs font-semibold bg-gray-100 text-gray-700 active:scale-95 transition-transform" onclick="openImportJson()">导入JSON</button>
                        </div>
                        <input id="import-json-input" type="file" accept="application/json" class="hidden" onchange="importLogsFromJsonFile(event)" />
                    </div>
                </div>
                <div id="weight-history-list" class="px-6 py-4 overflow-y-auto text-sm text-gray-700"></div>
                <div class="px-6 py-4 border-t border-gray-100">
                    <button class="w-full bg-gray-900 text-white py-3 rounded-2xl font-semibold active:scale-95 transition-transform" onclick="closeWeightHistoryModal()">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-weight-modal" class="fixed inset-0 hidden z-[65]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeEditWeightModal()"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl shadow-xl border border-gray-100 max-h-[80vh] flex flex-col">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">编辑体重记录</p>
                        <h3 class="text-lg font-bold text-gray-900">修改时间、体重与时段</h3>
                    </div>
                    <button class="w-9 h-9 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center" onclick="closeEditWeightModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="px-6 py-5 space-y-4 overflow-y-auto">
                    <label class="text-sm text-gray-700 block">
                        时间
                        <input id="edit-weight-datetime" type="datetime-local" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-500/30" />
                    </label>

                    <label class="text-sm text-gray-700 block">
                        体重 (kg)
                        <input id="edit-weight-value" type="number" step="0.01" class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-500/30" placeholder="0.00" />
                    </label>

                    <div>
                        <p class="text-sm text-gray-700 mb-2">记录时段</p>
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="btn-edit-period-morning" class="flex-1 px-3 py-2 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600" onclick="setEditWeightPeriod('morning')">早晨空腹</button>
                            <button id="btn-edit-period-night" class="flex-1 px-3 py-2 rounded-md text-sm font-medium text-gray-500 transition-all" onclick="setEditWeightPeriod('night')">晚间睡前</button>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-100 flex gap-3">
                    <button class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-2xl font-semibold active:scale-95 transition-transform" onclick="closeEditWeightModal()">取消</button>
                    <button id="btn-edit-weight-save" class="flex-1 bg-emerald-600 text-white py-3 rounded-2xl font-semibold active:scale-95 transition-transform hover:bg-emerald-700" onclick="submitEditWeight()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-12 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-[100] flex items-center gap-2">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toast-msg">保存成功</span>
    </div>

    <script type="module">
        // 1. 导入 Firebase 模块 (使用 CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp, doc, deleteDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Firebase 配置 (用户提供)
        const firebaseConfig = {
            apiKey: "AIzaSyCtj6rwIsC0niDMfkidV0AcvtA8gcuT3NE",
            authDomain: "weight-29113.firebaseapp.com",
            projectId: "weight-29113",
            storageBucket: "weight-29113.firebasestorage.app",
            messagingSenderId: "452663997314",
            appId: "1:452663997314:web:c6e230824ec83634e1559b",
            measurementId: "G-DXMS6X7H22"
        };

        // 3. 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = "diet_logs";

        // 4. 全局状态
        let appData = {
            logs: [],
            currentUnit: 'kg', // 输入时的单位
            weightInputPeriod: 'morning', // 早晨/睡前
            userHeight: 172, // 默认身高，会存储在闭包中
            foodUnit: 'g', // g 或 ml
            foodHeatUnit: 'kj', // kcal 或 kj，默认按 kJ 常见标注
            weightHistoryFilter: 'morning',
            editWeightPeriod: 'morning',
            editingWeightId: null
        };
        let chartInstance = null;

        // 5. DOM 元素引用
        const els = {
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            displayWeight: document.getElementById('display-weight'),
            lastRecordTime: document.getElementById('last-record-time'),
            displayBMI: document.getElementById('display-bmi'),
            bmiStatus: document.getElementById('bmi-status'),
            bmiNext: document.getElementById('bmi-next'),
            bmiProgressIndicator: document.getElementById('bmi-progress-indicator'),
            recentList: document.getElementById('recent-list'),
            inputWeight: document.getElementById('input-weight'),
            calcInput: document.getElementById('calc-input'),
            calcRun: document.getElementById('calc-run'),
            calcRope: document.getElementById('calc-rope'),
            calcDumbbell: document.getElementById('calc-dumbbell'),
            trendCurrentWeight: document.getElementById('trend-current-weight'),
            trendCurrentTime: document.getElementById('trend-current-time'),
            trendChangeBadge: document.getElementById('trend-change-badge'),
            trendChange: document.getElementById('trend-change'),
            trendChangeDesc: document.getElementById('trend-change-desc'),
            weightChange: document.getElementById('weight-change'),
            weightChangeDesc: document.getElementById('weight-change-desc'),
            weightChangeExtra: document.getElementById('weight-change-extra'),
            weightTrendBadge: document.getElementById('weight-trend-badge'),
            btnPeriodMorning: document.getElementById('btn-period-morning'),
            btnPeriodNight: document.getElementById('btn-period-night'),
            foodName: document.getElementById('food-name'),
            foodAmount: document.getElementById('food-amount'),
            foodUnitKcal: document.getElementById('food-unit-kcal'),
            foodTotal: document.getElementById('food-total-kcal'),
            calcHistory: document.getElementById('calc-history'),
            weightHistoryModal: document.getElementById('weight-history-modal'),
            weightHistoryList: document.getElementById('weight-history-list'),
            weightHistoryTabs: document.getElementById('weight-history-tabs'),
            weightHistoryCopyRange: document.getElementById('weight-history-copy-range'),
            editWeightModal: document.getElementById('edit-weight-modal'),
            editWeightDatetime: document.getElementById('edit-weight-datetime'),
            editWeightValue: document.getElementById('edit-weight-value'),
            btnEditPeriodMorning: document.getElementById('btn-edit-period-morning'),
            btnEditPeriodNight: document.getElementById('btn-edit-period-night'),
            btnEditWeightSave: document.getElementById('btn-edit-weight-save')
        };

        // ================= 工具函数 =================

        // 显示 Toast 提示
        window.showToast = (msg) => {
            els.toastMsg.innerText = msg;
            els.toast.classList.remove('opacity-0');
            els.toast.classList.add('opacity-100');
            setTimeout(() => {
                els.toast.classList.remove('opacity-100');
                els.toast.classList.add('opacity-0');
            }, 2000);
        };

        window.openWeightHistoryModal = () => {
            if (!els.weightHistoryModal || !els.weightHistoryList) return;
            // 默认展示全部体重
            appData.weightHistoryFilter = 'all';
            setWeightHistoryFilter('all');
            els.weightHistoryModal.classList.remove('hidden');
        };

        window.closeWeightHistoryModal = () => {
            if (!els.weightHistoryModal) return;
            els.weightHistoryModal.classList.add('hidden');
        };

        const formatDatetimeLocal = (dateObj) => {
            if (!dateObj || !Number.isFinite(dateObj.getTime())) return '';
            const y = dateObj.getFullYear();
            const m = pad2(dateObj.getMonth() + 1);
            const d = pad2(dateObj.getDate());
            const hh = pad2(dateObj.getHours());
            const mm = pad2(dateObj.getMinutes());
            return `${y}-${m}-${d}T${hh}:${mm}`;
        };

        window.setEditWeightPeriod = (period) => {
            appData.editWeightPeriod = period === 'night' ? 'night' : 'morning';
            if (els.btnEditPeriodMorning && els.btnEditPeriodNight) {
                if (appData.editWeightPeriod === 'morning') {
                    els.btnEditPeriodMorning.className = "flex-1 px-3 py-2 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                    els.btnEditPeriodNight.className = "flex-1 px-3 py-2 rounded-md text-sm font-medium text-gray-500 transition-all";
                } else {
                    els.btnEditPeriodNight.className = "flex-1 px-3 py-2 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                    els.btnEditPeriodMorning.className = "flex-1 px-3 py-2 rounded-md text-sm font-medium text-gray-500 transition-all";
                }
            }
        };

        window.openEditWeightModal = (id) => {
            try {
                const target = appData.logs.find(l => l.id === id);
                if (!target) {
                    showToast('未找到该记录');
                    return;
                }
                appData.editingWeightId = id;
                const dateObj = toJsDate(target.date || target.timestamp || target.clientCreatedAtMs);
                if (els.editWeightDatetime) {
                    els.editWeightDatetime.value = formatDatetimeLocal(dateObj);
                }
                if (els.editWeightValue) {
                    els.editWeightValue.value = Number(target.value).toFixed(2);
                }
                window.setEditWeightPeriod(normalizePeriod(target));
                els.editWeightModal?.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                showToast('打开编辑失败');
            }
        };

        window.closeEditWeightModal = () => {
            els.editWeightModal?.classList.add('hidden');
            appData.editingWeightId = null;
        };

        window.submitEditWeight = async () => {
            const btn = els.btnEditWeightSave;
            if (!appData.editingWeightId) {
                showToast('未选择要修改的记录');
                return;
            }
            const rawVal = parseFloat(els.editWeightValue?.value);
            if (!Number.isFinite(rawVal) || rawVal <= 0) {
                showToast('请输入体重数值');
                return;
            }
            if (rawVal < 20 || rawVal > 300) {
                showToast('体重范围异常（20-300kg）');
                return;
            }
            const rawDatetime = els.editWeightDatetime?.value;
            const dateObj = rawDatetime ? new Date(rawDatetime) : null;
            if (!dateObj || !Number.isFinite(dateObj.getTime())) {
                showToast('请选择有效的时间');
                return;
            }
            const dateStr = `${dateObj.getFullYear()}-${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())} ${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                }
                const newDoc = {
                    date: dateStr,
                    type: "weight",
                    value: Number(rawVal.toFixed(2)),
                    period: appData.editWeightPeriod,
                    note: "",
                    clientCreatedAtMs: dateObj.getTime(),
                    timestamp: serverTimestamp()
                };
                await updateDoc(doc(db, COLLECTION_NAME, appData.editingWeightId), newDoc);
                showToast('已更新记录');
                window.closeEditWeightModal();
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('保存失败，请重试');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '保存修改';
                }
            }
        };

        function getYmd(dateValue) {
            const d = toJsDate(dateValue);
            if (!d || !Number.isFinite(d.getTime())) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function renderWeightHistoryModal() {
            const wrap = els.weightHistoryList;
            if (!wrap) return;
            wrap.innerHTML = '';

            const weights = getWeightLogs(appData.weightHistoryFilter)
                .sort((a, b) => getLogDateMs(b) - getLogDateMs(a));

            if (!weights.length) {
                wrap.innerHTML = '<div class="text-center text-gray-400 py-8">暂无体重记录</div>';
                return;
            }

            weights.forEach(item => {
                const ymd = getYmd(item.date || item.timestamp);
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-3 border-b border-gray-100';
                row.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-gray-900">${ymd}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(item.date || item.timestamp)} · ${WEIGHT_PERIOD_LABEL[normalizePeriod(item)] || ''}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="text-base font-bold text-gray-900">${formatWeight(item.value)} kg</p>
                        <button class="text-emerald-600 text-xs px-3 py-2 rounded-lg hover:bg-emerald-50" onclick="openEditWeightModal('${item.id}')">编辑</button>
                    </div>
                `;
                wrap.appendChild(row);
            });
        }

        const WEIGHT_HISTORY_RANGE_LABEL = {
            all: '全部历史',
            '7d': '近7天',
            '1m': '近1个月',
            '2m': '近2个月',
            '3m': '近3个月',
            '4m': '近4个月',
            '5m': '近5个月',
            '6m': '近半年',
            '1y': '近一年'
        };

        function getRangeCutoffMs(rangeKey) {
            if (!rangeKey || rangeKey === 'all') return null;
            const now = new Date();
            const d = new Date(now);
            if (rangeKey === '7d') d.setDate(d.getDate() - 7);
            else if (rangeKey === '1m') d.setMonth(d.getMonth() - 1);
            else if (rangeKey === '2m') d.setMonth(d.getMonth() - 2);
            else if (rangeKey === '3m') d.setMonth(d.getMonth() - 3);
            else if (rangeKey === '4m') d.setMonth(d.getMonth() - 4);
            else if (rangeKey === '5m') d.setMonth(d.getMonth() - 5);
            else if (rangeKey === '6m') d.setMonth(d.getMonth() - 6);
            else if (rangeKey === '1y') d.setFullYear(d.getFullYear() - 1);
            const ms = d.getTime();
            return Number.isFinite(ms) ? ms : null;
        }

        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        function buildWeightHistoryTsv(logs, meta) {
            const { filterLabel, rangeLabel } = meta || {};
            const lines = [];
            lines.push(`范围: ${rangeLabel || ''} | 类型: ${filterLabel || ''} | 单位: kg`);
            lines.push('date\tperiod\tweight_kg');
            logs.forEach(item => {
                const ymd = getYmd(item.date || item.timestamp);
                const periodLabel = WEIGHT_PERIOD_LABEL[normalizePeriod(item)] || '';
                const weight = formatWeight(item.value);
                lines.push(`${ymd}\t${periodLabel}\t${weight}`);
            });
            return lines.join('\n');
        }

        async function copyTextToClipboard(text) {
            if (navigator?.clipboard?.writeText) {
                await navigator.clipboard.writeText(text);
                return;
            }
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (!ok) throw new Error('copy_failed');
        }

        window.copyWeightHistoryToClipboard = async (rangeKey = 'all') => {
            try {
                const filter = appData.weightHistoryFilter || 'all';
                const filterLabel = filter === 'morning' ? '早晨空腹' : (filter === 'night' ? '晚间睡前' : '全部');
                const rangeLabel = WEIGHT_HISTORY_RANGE_LABEL[rangeKey] || '';

                const cutoffMs = getRangeCutoffMs(rangeKey);
                const weights = getWeightLogs(filter)
                    .filter(l => {
                        if (!cutoffMs) return true;
                        return getLogDateMs(l) >= cutoffMs;
                    })
                    .sort((a, b) => getLogDateMs(a) - getLogDateMs(b));

                if (!weights.length) {
                    showToast('该范围暂无体重记录');
                    return;
                }

                const text = buildWeightHistoryTsv(weights, { filterLabel, rangeLabel });

                await copyTextToClipboard(text);
                showToast(`已复制 ${weights.length} 条记录`);
            } catch (e) {
                console.error(e);
                showToast('复制失败，请重试');
            }
        };

        // 格式化日期
        const toJsDate = (value) => {
            if (!value) return null;
            if (typeof value === 'object' && typeof value.toDate === 'function') {
                return value.toDate();
            }
            if (typeof value === 'string') {
                const s = value.trim();
                if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(s)) {
                    return new Date(s.replace(' ', 'T') + ':00');
                }
                if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                    return new Date(s + 'T00:00:00');
                }
                return new Date(s);
            }
            return new Date(value);
        };

        const getLogDateMs = (log) => {
            const clientMs = Number(log?.clientCreatedAtMs);
            if (Number.isFinite(clientMs)) return clientMs;
            const d = toJsDate(log?.date) || toJsDate(log?.timestamp);
            const ms = d?.getTime();
            return Number.isFinite(ms) ? ms : 0;
        };

        function downloadTextAsFile(filename, text, mime = 'text/plain;charset=utf-8') {
            const blob = new Blob([text], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeCsvCell(value) {
            const s = String(value ?? '');
            if (/[,\n\r"]/g.test(s)) return `"${s.replace(/"/g, '""')}"`;
            return s;
        }

        function buildWeightHistoryCsv(logs, meta) {
            const { filterLabel, rangeLabel } = meta || {};
            const lines = [];
            lines.push(`范围,${escapeCsvCell(rangeLabel || '')}`);
            lines.push(`类型,${escapeCsvCell(filterLabel || '')}`);
            lines.push(`单位,kg`);
            lines.push('date,period,weight_kg');
            logs.forEach(item => {
                const ymd = getYmd(item.date || item.timestamp || item.clientCreatedAtMs);
                const periodLabel = WEIGHT_PERIOD_LABEL[normalizePeriod(item)] || '';
                const weight = formatWeight(item.value);
                lines.push([ymd, periodLabel, weight].map(escapeCsvCell).join(','));
            });
            return '\uFEFF' + lines.join('\n');
        }

        async function fetchAllLogsForExport() {
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            const all = [];
            snap.forEach(d => all.push({ id: d.id, ...d.data() }));
            all.sort((a, b) => getLogDateMs(b) - getLogDateMs(a));
            return all;
        }

        window.downloadWeightHistoryCsv = async (rangeKey = 'all') => {
            try {
                const filter = appData.weightHistoryFilter || 'all';
                const filterLabel = filter === 'morning' ? '早晨空腹' : (filter === 'night' ? '晚间睡前' : '全部');
                const rangeLabel = WEIGHT_HISTORY_RANGE_LABEL[rangeKey] || '';
                showToast('正在生成CSV...');

                const allLogs = await fetchAllLogsForExport();
                const weights = allLogs
                    .filter(l => l.type === 'weight')
                    .filter(l => {
                        if (filter === 'morning') return normalizePeriod(l) === 'morning';
                        if (filter === 'night') return normalizePeriod(l) === 'night';
                        return true;
                    });

                const cutoffMs = getRangeCutoffMs(rangeKey);
                const finalList = weights
                    .filter(l => !cutoffMs || getLogDateMs(l) >= cutoffMs)
                    .sort((a, b) => getLogDateMs(a) - getLogDateMs(b));

                if (!finalList.length) {
                    showToast('该范围暂无体重记录');
                    return;
                }

                const csv = buildWeightHistoryCsv(finalList, { filterLabel, rangeLabel });
                const today = getYmd(Date.now()) || 'export';
                const filename = `weight_${filter}_${rangeKey}_${today}.csv`;
                downloadTextAsFile(filename, csv, 'text/csv;charset=utf-8');
                showToast(`已下载 ${finalList.length} 条`);
            } catch (e) {
                console.error(e);
                showToast('导出失败');
            }
        };

        window.downloadAllLogsJson = async () => {
            try {
                showToast('正在导出JSON...');
                const allLogs = await fetchAllLogsForExport();
                const payload = {
                    exportedAt: new Date().toISOString(),
                    collection: COLLECTION_NAME,
                    logs: allLogs.map(l => {
                        const { id, ...rest } = l;
                        return rest;
                    })
                };
                const today = getYmd(Date.now()) || 'export';
                downloadTextAsFile(`diet_logs_${today}.json`, JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
                showToast(`已导出 ${allLogs.length} 条`);
            } catch (e) {
                console.error(e);
                showToast('导出失败');
            }
        };

        window.openImportJson = () => {
            const input = document.getElementById('import-json-input');
            input?.click();
        };

        window.importLogsFromJsonFile = async (event) => {
            try {
                const file = event?.target?.files?.[0];
                if (!file) return;
                const text = await file.text();
                const data = JSON.parse(text);
                const logs = Array.isArray(data) ? data : (Array.isArray(data?.logs) ? data.logs : []);
                if (!logs.length) {
                    showToast('文件内容为空');
                    return;
                }
                const ok = confirm(`将导入 ${logs.length} 条记录（会新增，可能重复）。继续？`);
                if (!ok) return;

                for (const itemRaw of logs) {
                    if (!itemRaw || typeof itemRaw !== 'object') continue;
                    const item = { ...itemRaw };
                    delete item.id;
                    delete item.timestamp;

                    const ms = Number(item.clientCreatedAtMs);
                    const dateObj = toJsDate(item.date) || (Number.isFinite(ms) ? new Date(ms) : null);
                    const now = new Date();
                    const finalDate = dateObj && Number.isFinite(dateObj.getTime()) ? dateObj : now;
                    const dateStr = `${finalDate.getFullYear()}-${String(finalDate.getMonth()+1).padStart(2,'0')}-${String(finalDate.getDate()).padStart(2,'0')} ${String(finalDate.getHours()).padStart(2,'0')}:${String(finalDate.getMinutes()).padStart(2,'0')}`;
                    item.date = dateStr;
                    item.clientCreatedAtMs = Number.isFinite(ms) ? ms : finalDate.getTime();
                    item.timestamp = serverTimestamp();

                    await addDoc(collection(db, COLLECTION_NAME), item);
                }

                showToast('导入完成');
                event.target.value = '';
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast('导入失败');
            }
        };

        const formatWeight = (val) => {
            const n = Number(val);
            return Number.isFinite(n) ? n.toFixed(2) : '--';
        };

        const WEIGHT_PERIOD_LABEL = {
            morning: '早晨空腹',
            night: '晚间睡前'
        };

        const normalizePeriod = (log) => (log?.period === 'night' ? 'night' : 'morning');

        const getWeightLogs = (filter = 'all') => {
            const weights = appData.logs.filter(l => l.type === 'weight');
            if (filter === 'morning') return weights.filter(l => normalizePeriod(l) === 'morning');
            if (filter === 'night') return weights.filter(l => normalizePeriod(l) === 'night');
            return weights;
        };

        const formatDate = (value) => {
            const date = toJsDate(value);
            if (!date || !Number.isFinite(date.getTime())) return '--';
            return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
        };

        // 切换视图
        window.switchView = (viewName) => {
            // 隐藏所有 View
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // 显示目标 View
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // 更新底部导航状态
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewName) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-emerald-600');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-emerald-600');
                }
            });

            // 如果切换到趋势页，重新渲染图表
            if(viewName === 'trend') {
                if (typeof window.filterChart === 'function') window.filterChart(30); // 默认显示30天
            }
        };

        // 历史筛选标签
        window.setWeightHistoryFilter = (filter) => {
            appData.weightHistoryFilter = filter;
            if (els.weightHistoryTabs) {
                els.weightHistoryTabs.querySelectorAll('button').forEach(btn => {
                    const active = btn.getAttribute('onclick')?.includes(`'${filter}'`);
                    if (active) {
                        btn.className = "px-3 py-2 rounded-xl text-sm font-semibold bg-emerald-600 text-white shadow-sm";
                    } else {
                        btn.className = "px-3 py-2 rounded-xl text-sm font-semibold bg-gray-100 text-gray-700";
                    }
                });
            }
            renderWeightHistoryModal();
        };

        // 体重记录时段切换（早晨/睡前）
        window.setWeightPeriod = (period) => {
            appData.weightInputPeriod = period === 'night' ? 'night' : 'morning';
            if (els.btnPeriodMorning && els.btnPeriodNight) {
                if (appData.weightInputPeriod === 'morning') {
                    els.btnPeriodMorning.className = "px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                    els.btnPeriodNight.className = "px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all";
                } else {
                    els.btnPeriodNight.className = "px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                    els.btnPeriodMorning.className = "px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all";
                }
            }
        };

        // 设置输入单位 (Kg/Jin)
        window.setUnit = (unit) => {
            appData.currentUnit = unit;
            const btnKg = document.getElementById('btn-unit-kg');
            const btnJin = document.getElementById('btn-unit-jin');
            
            if(unit === 'kg') {
                btnKg.className = "px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                btnJin.className = "px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all";
            } else {
                btnJin.className = "px-3 py-1 rounded-md text-sm font-medium transition-all bg-white shadow text-emerald-600";
                btnKg.className = "px-3 py-1 rounded-md text-sm font-medium text-gray-500 transition-all";
            }
        };

        // ================= 核心业务逻辑 =================

        // 1. 获取数据 (读取)
        async function fetchLogs() {
            try {
                let querySnapshot;
                try {
                    const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'), limit(800));
                    querySnapshot = await getDocs(q);
                } catch (e) {
                    console.warn('fetchLogs orderBy(timestamp) failed, fallback to orderBy(date)', e);
                    const q = query(collection(db, COLLECTION_NAME), orderBy('date', 'desc'), limit(800));
                    querySnapshot = await getDocs(q);
                }
                
                appData.logs = [];
                querySnapshot.forEach((doc) => {
                    appData.logs.push({ id: doc.id, ...doc.data() });
                });

                appData.logs.sort((a, b) => getLogDateMs(b) - getLogDateMs(a));

                renderHome();
                renderCalcHistory();
            } catch (error) {
                console.error("Error fetching logs: ", error);
                showToast("数据加载失败");
            }
        }

        // 2. 渲染首页
        function renderHome() {
            // 设置当前日期
            const now = new Date();
            document.getElementById('current-date').innerText = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;

            // 过滤出体重记录（首页指标仅看早晨空腹）
            const morningWeightLogs = getWeightLogs('morning');

            if (morningWeightLogs.length > 0) {
                const latest = morningWeightLogs[0];
                els.displayWeight.innerText = formatWeight(latest.value);
                const latestDate = toJsDate(latest.date) || toJsDate(latest.timestamp);
                if (latestDate && Number.isFinite(latestDate.getTime())) {
                    const periodLabel = WEIGHT_PERIOD_LABEL[normalizePeriod(latest)] || '';
                    els.lastRecordTime.innerText = `记录于 ${String(latestDate.getHours()).padStart(2, '0')}:${String(latestDate.getMinutes()).padStart(2, '0')} · ${periodLabel}`;
                } else {
                    els.lastRecordTime.innerText = `记录于 --:--`;
                }
                
                // 体重变化（与上一条对比）
                if (morningWeightLogs.length > 1) {
                    const prev = morningWeightLogs[1];
                    const diff = latest.value - prev.value;
                    const sign = diff > 0 ? '+' : '';
                    els.weightChange.innerText = `${sign}${diff.toFixed(2)} kg`;
                    els.weightChangeDesc.innerText = `较上一条 ${formatDate(prev.date || prev.timestamp)}`;
                    if (diff > 0) {
                        els.weightTrendBadge.innerText = '上升';
                        els.weightTrendBadge.className = 'bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full';
                    } else if (diff < 0) {
                        els.weightTrendBadge.innerText = '下降';
                        els.weightTrendBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                    } else {
                        els.weightTrendBadge.innerText = '持平';
                        els.weightTrendBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                    }
                } else {
                    els.weightChange.innerText = '--';
                    els.weightChangeDesc.innerText = '等待新记录';
                    els.weightTrendBadge.innerText = '-';
                    els.weightTrendBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                }

                if (els.weightChangeExtra) {
                    const cutoff = new Date();
                    cutoff.setDate(cutoff.getDate() - 7);
                    const cutoffMs = cutoff.getTime();
                    const last7 = morningWeightLogs
                        .filter(l => getLogDateMs(l) >= cutoffMs)
                        .sort((a, b) => getLogDateMs(a) - getLogDateMs(b));
                    if (last7.length >= 2) {
                        const first7 = last7[0];
                        const last7Item = last7[last7.length - 1];
                        const diff7 = Number(last7Item.value) - Number(first7.value);
                        const sign7 = diff7 > 0 ? '+' : '';
                        const avg7 = last7.reduce((sum, x) => sum + Number(x.value || 0), 0) / last7.length;
                        els.weightChangeExtra.innerText = `近7天 ${sign7}${diff7.toFixed(2)} kg · 均值 ${avg7.toFixed(2)} kg（${last7.length}条）`;
                    } else if (last7.length === 1) {
                        els.weightChangeExtra.innerText = '近7天仅1条记录';
                    } else {
                        els.weightChangeExtra.innerText = '近7天暂无记录';
                    }
                }
                
                // 计算 BMI
                const heightM = appData.userHeight / 100;
                const bmi = latest.value / (heightM * heightM);
                els.displayBMI.innerText = bmi.toFixed(2);
                
                // BMI 状态 & 进度条
                let status = "正常";
                let nextText = "保持当前状态";
                const segments = [
                    { label: '偏瘦', min: 0, max: 18.5, color: 'text-sky-600' },
                    { label: '正常', min: 18.5, max: 24, color: 'text-emerald-600' },
                    { label: '过重', min: 24, max: 27, color: 'text-amber-600' },
                    { label: '肥胖', min: 27, max: 40, color: 'text-rose-600' }
                ];

                if(bmi < 18.5) {
                    status = "偏瘦";
                    nextText = `距离“正常”还差 ${(18.5 - bmi).toFixed(2)}`;
                } else if(bmi >= 18.5 && bmi < 24) {
                    status = "正常";
                    nextText = `距离“过重”还有 ${(24 - bmi).toFixed(2)}`;
                } else if(bmi >= 24 && bmi < 27) {
                    status = "过重";
                    nextText = `距离“肥胖”还有 ${(27 - bmi).toFixed(2)}`;
                } else {
                    status = "肥胖";
                    nextText = '建议尽快控制体重';
                }
                els.bmiStatus.className = `text-xs mt-1 font-semibold ${segments.find(s => status.includes(s.label))?.color || 'text-emerald-700'}`;
                els.bmiStatus.innerText = status;
                if (els.bmiNext) els.bmiNext.innerText = nextText;

                // 进度条位置：0-40 线性，18.5/24/27 位置贴合刻度
                const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
                const bmiForBar = clamp(bmi, 0, 40);
                const percent = (bmiForBar / 40) * 100;
                if (els.bmiProgressIndicator) {
                    els.bmiProgressIndicator.style.left = `${percent}%`;
                }
            } else {
                els.displayWeight.innerText = "--";
                els.bmiStatus.innerText = "未知";
                if (els.bmiNext) els.bmiNext.innerText = "";
                if (els.bmiProgressIndicator) els.bmiProgressIndicator.style.left = '0%';
            }

            // 渲染列表 (取前5条)
            els.recentList.innerHTML = "";
            const recentWeights = getWeightLogs().slice(0, 5);
            if (!recentWeights.length) {
                els.recentList.innerHTML = '<li class="text-center text-gray-400 py-4">暂无体重记录</li>';
            } else {
                recentWeights.forEach(log => {
                    const li = document.createElement('li');
                    li.className = "bg-white border border-gray-100 rounded-2xl px-4 py-3 shadow-sm";
                    li.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center">
                                    <i class="fas fa-weight-scale text-emerald-500"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800">${formatWeight(log.value)} kg</p>
                                    <p class="text-xs text-gray-400">${formatDate(log.date || log.timestamp)} · ${WEIGHT_PERIOD_LABEL[normalizePeriod(log)] || ''}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="text-emerald-600 text-sm px-3 py-2 rounded-lg hover:bg-emerald-50" onclick="openEditWeightModal('${log.id}')">编辑</button>
                                <button class="text-red-500 text-sm px-3 py-2 rounded-lg hover:bg-red-50" onclick="deleteWeightItem('${log.id}', this)">删除</button>
                            </div>
                        </div>
                    `;
                    els.recentList.appendChild(li);
                });
            }
        }

        // 3. 保存体重 (写入)
        window.saveWeight = async () => {
            const rawVal = parseFloat(els.inputWeight.value);

            if (!Number.isFinite(rawVal) || rawVal <= 0) {
                showToast("请输入体重数值");
                return;
            }

            // 加载动画状态
            const btn = document.getElementById('btn-save-weight');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 保存中...`;
            btn.disabled = true;

            // 单位转换：如果是斤，除以2转为KG存入数据库
            const weightKg = appData.currentUnit === 'jin' ? rawVal / 2 : rawVal;
            const weightFixed = Number(weightKg.toFixed(2));

            if (!Number.isFinite(weightFixed) || weightFixed < 20 || weightFixed > 300) {
                showToast("体重范围异常（20-300kg）");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            const now = new Date();
            // 格式化为 YYYY-MM-DD HH:mm
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            const todayYmd = getYmd(now);
            const existing = appData.logs
                .filter(l => l.type === 'weight')
                .filter(l => normalizePeriod(l) === appData.weightInputPeriod)
                .filter(l => getYmd(l.date || l.timestamp || l.clientCreatedAtMs) === todayYmd)
                .sort((a, b) => getLogDateMs(b) - getLogDateMs(a))[0];

            const newDoc = {
                date: dateStr,
                type: "weight",
                value: weightFixed,
                period: appData.weightInputPeriod,
                note: "",
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                if (existing?.id) {
                    const periodLabel = WEIGHT_PERIOD_LABEL[appData.weightInputPeriod] || '';
                    const ok = confirm(`今天已记录过【${periodLabel}】体重，是否覆盖？`);
                    if (!ok) {
                        return;
                    }
                    await updateDoc(doc(db, COLLECTION_NAME, existing.id), newDoc);
                    showToast("已覆盖今日记录");
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), newDoc);
                    showToast("体重记录成功");
                }
                
                // 清空输入
                els.inputWeight.value = "";
                
                // 刷新数据并切回首页
                await fetchLogs();
                switchView('home');
            } catch (e) {
                console.error("Error adding document: ", e);
                showToast("保存失败，请检查网络");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // 4. 保存饮食/计算结果 (写入)
        window.saveFoodLog = async () => {
            if (!els.calcInput) {
                showToast("该版本未启用热量输入");
                return;
            }
            const kcal = parseFloat(els.calcInput.value);
            if (!kcal) return;

            const runMins = Math.round((kcal / 100) * 9);
            const dumbbellMins = Math.round((kcal / 100) * 15);
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            const newDoc = {
                date: dateStr,
                type: "food",
                value: kcal, // 存热量
                note: `摄入 ${kcal} Kcal (跑步约 ${runMins} 分钟 / 哑铃约 ${dumbbellMins} 分钟)`,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, COLLECTION_NAME), newDoc);
                showToast("饮食记录已保存");
                els.calcInput.value = "";
                els.calcRun.innerText = "0";
                els.calcDumbbell.innerText = "0";
                await fetchLogs(); // 后台刷新
            } catch (e) {
                showToast("保存失败");
            }
        };

        // 5. 计算器逻辑
        els.calcInput?.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if(val) {
                // 200g苹果=100kcal=跑步9分钟
                // 比例：100kcal = 9 mins
                const run = (val / 100) * 9;
                const dumbbell = (val / 100) * 15; // 粗略估算
                els.calcRun.innerText = Math.round(run);
                els.calcDumbbell.innerText = Math.round(dumbbell);
            } else {
                els.calcRun.innerText = 0;
                els.calcDumbbell.innerText = 0;
            }
        });

        // 6.1 食材单位切换
        window.setFoodUnit = (unit) => {
            appData.foodUnit = unit;
            const gBtn = document.getElementById('btn-unit-g');
            const mlBtn = document.getElementById('btn-unit-ml');
            if (unit === 'g') {
                gBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600";
                mlBtn.className = "px-3 py-1 rounded-md text-gray-500";
            } else {
                mlBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600";
                gBtn.className = "px-3 py-1 rounded-md text-gray-500";
            }
        };

        // 6.2 热量单位切换
        window.setFoodHeatUnit = (unit) => {
            appData.foodHeatUnit = unit;
            const kcalBtn = document.getElementById('btn-heat-kcal');
            const kjBtn = document.getElementById('btn-heat-kj');
            if (unit === 'kcal') {
                kcalBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600 border border-emerald-100";
                kjBtn.className = "px-3 py-1 rounded-md text-gray-500 border border-gray-200";
            } else {
                kjBtn.className = "px-3 py-1 rounded-md bg-white shadow text-emerald-600 border border-emerald-100";
                kcalBtn.className = "px-3 py-1 rounded-md text-gray-500 border border-gray-200";
            }
        };

        // 5.2 计算食材热量（基础逻辑，支持仅计算/计算并记录）
        function calcFoodBase() {
            const name = (els.foodName.value || '未命名食材').trim();
            const amount = parseFloat(els.foodAmount.value);
            const per100 = parseFloat(els.foodUnitKcal.value);
            if (!amount || !per100) {
                showToast("请填写数量和单位热量");
                return null;
            }
            const totalPer100 = (amount * per100) / 100;
            const isKjPer100 = appData.foodHeatUnit === 'kj';
            // kJ -> kcal 按 4.184 换算；kcal 直接使用
            const totalKcalRaw = isKjPer100 ? (totalPer100 / 4.184) : totalPer100;
            const totalKcalInt = Math.round(totalKcalRaw);
            els.foodTotal.innerText = String(totalKcalInt);

            // 运动折算：跑步/跳绳/哑铃
            const run = (totalKcalInt / 100) * 9;
            const rope = (totalKcalInt / 100) * 7;
            const dumbbell = (totalKcalInt / 100) * 15;
            const runInt = Math.round(run);
            const ropeInt = Math.round(rope);
            const dumbbellInt = Math.round(dumbbell);
            els.calcRun.innerText = runInt;
            els.calcRope.innerText = ropeInt;
            els.calcDumbbell.innerText = dumbbellInt;

            return {
                name,
                amount,
                per100,
                isKjPer100,
                totalKcalInt,
                runInt,
                ropeInt,
                dumbbellInt
            };
        }

        // 仅计算（不入库）
        window.calcFoodOnly = () => {
            const result = calcFoodBase();
            if (!result) return;
        };

        // 计算并记录食材热量
        window.calcFoodKcal = async () => {
            const result = calcFoodBase();
            if (!result) return;

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).toString().padStart(2,'0')}:${String(now.getMinutes()).toString().padStart(2,'0')}`;

            const newDoc = {
                date: dateStr,
                type: "food_calc",
                value: result.totalKcalInt,
                note: `${result.name} · ${result.amount}${appData.foodUnit} · ${result.per100}${result.isKjPer100 ? 'kJ' : 'kcal'}/100${appData.foodUnit} · 跑${result.runInt}分 / 绳${result.ropeInt}分 / 哑${result.dumbbellInt}分`,
                foodName: result.name,
                amount: result.amount,
                unit: appData.foodUnit,
                per100: result.per100,
                per100Unit: result.isKjPer100 ? 'kJ' : 'kcal',
                run: result.runInt,
                rope: result.ropeInt,
                dumbbell: result.dumbbellInt,
                clientCreatedAtMs: now.getTime(),
                timestamp: serverTimestamp()
            };
            try {
                await addDoc(collection(db, COLLECTION_NAME), newDoc);
                showToast("已记录食材热量");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("保存失败，请重试");
            }
        };

        // 5.3 渲染食材热量历史
        function renderCalcHistory() {
            const wrap = els.calcHistory;
            wrap.innerHTML = "";
            const items = appData.logs.filter(l => l.type === 'food_calc').slice(0, 30);
            if (!items.length) {
                wrap.innerHTML = '<div class="text-center text-gray-400 py-4">暂无历史</div>';
                return;
            }
            items.forEach(item => {
                const subtitle = item.note || `${item.foodName || '食材'} · ${item.amount || '-'}${item.unit || ''}`;
                const row = document.createElement('div');
                row.className = "border border-gray-100 rounded-2xl p-4 flex items-center justify-between shadow-sm";
                row.innerHTML = `
                    <div>
                        <p class="text-base font-semibold text-gray-900">${item.foodName || '食材'} ≈ ${item.value} kcal</p>
                        <p class="text-xs text-gray-500 mt-1">${subtitle}</p>
                        <p class="text-[11px] text-gray-400 mt-1">${formatDate(item.date || item.timestamp)}</p>
                    </div>
                    <button class="text-red-500 text-sm px-3 py-2 rounded-lg hover:bg-red-50" onclick="deleteHistoryItem('${item.id}', this)">删除</button>
                `;
                wrap.appendChild(row);
            });
        }

        // 5.4 删除单条历史
        window.deleteHistoryItem = async (id, btnEl) => {
            try {
                if (btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                showToast("已删除");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("删除失败");
            } finally {
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.innerText = '删除';
                }
            }
        };

        // 删除单条体重记录
        window.deleteWeightItem = async (id, btnEl) => {
            try {
                const ok = confirm('确定删除这条体重记录吗？');
                if (!ok) return;
                if (btnEl) {
                    btnEl.disabled = true;
                    btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                showToast("已删除");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("删除失败");
            } finally {
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.innerText = '删除';
                }
            }
        };

        // 5.5 清空历史
        window.clearCalcHistory = async () => {
            try {
                const snap = await getDocs(collection(db, COLLECTION_NAME));
                const targets = snap.docs.filter(d => d.data().type === 'food_calc');
                await Promise.all(targets.map(d => deleteDoc(doc(db, COLLECTION_NAME, d.id))));
                showToast("已清空历史");
                await fetchLogs();
            } catch (e) {
                console.error(e);
                showToast("清空失败");
            }
        };

        // 5.6 手动刷新历史
        window.refreshCalcHistory = () => {
            renderCalcHistory();
        };

        // 6. 图表逻辑
        window.filterChart = (days) => {
            // 更新按钮样式
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => {
                if(b.innerText.includes(days === 999 ? '全部' : days + '天')) {
                    b.classList.remove('bg-emerald-50', 'text-emerald-700');
                    b.classList.add('bg-emerald-600', 'text-white');
                } else {
                    b.classList.add('bg-emerald-50', 'text-emerald-700');
                    b.classList.remove('bg-emerald-600', 'text-white');
                }
            });

            renderChart(days);
        };

        function renderChart(days) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            
            // 过滤数据：只看体重，按时间正序排列
            let weightData = getWeightLogs('morning')
                .sort((a, b) => getLogDateMs(a) - getLogDateMs(b));

            // 时间筛选
            if (days !== 999) {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                const cutoffMs = cutoff.getTime();
                weightData = weightData.filter(d => getLogDateMs(d) >= cutoffMs);
            }

            // 提取数据
            const labels = weightData.map(d => {
                const date = new Date(getLogDateMs(d));
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            const values = weightData.map(d => d.value);

            // 更新趋势区间卡片
            if (els.trendCurrentWeight && els.trendCurrentTime && els.trendChange && els.trendChangeDesc && els.trendChangeBadge) {
                const rangeText = days === 999 ? '全部历史' : `最近${days}天`;
                if (!weightData.length) {
                    els.trendCurrentWeight.innerText = '--';
                    els.trendCurrentTime.innerText = '--';
                    els.trendChange.innerText = '--';
                    els.trendChangeDesc.innerText = `${rangeText} · 暂无记录`;
                    els.trendChangeBadge.innerText = '-';
                    els.trendChangeBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                } else {
                    const first = weightData[0];
                    const last = weightData[weightData.length - 1];
                    els.trendCurrentWeight.innerText = `${formatWeight(last.value)} kg`;
                    els.trendCurrentTime.innerText = formatDate(last.date || last.timestamp);

                    const diff = Number(last.value) - Number(first.value);
                    const sign = diff > 0 ? '+' : '';
                    els.trendChange.innerText = `${sign}${diff.toFixed(2)} kg`;
                    if (diff > 0) {
                        els.trendChangeBadge.innerText = '上升';
                        els.trendChangeBadge.className = 'bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full';
                    } else if (diff < 0) {
                        els.trendChangeBadge.innerText = '下降';
                        els.trendChangeBadge.className = 'bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full';
                    } else {
                        els.trendChangeBadge.innerText = '持平';
                        els.trendChangeBadge.className = 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
                    }

                    const firstTime = formatDate(first.date || first.timestamp);
                    const lastTime = formatDate(last.date || last.timestamp);
                    els.trendChangeDesc.innerText = weightData.length === 1
                        ? `${rangeText} · ${firstTime}（仅1条）`
                        : `${rangeText} · ${firstTime} → ${lastTime}`;
                }
            }

            // 更新统计
            if(values.length > 0) {
                document.getElementById('stat-max').innerText = Math.max(...values).toFixed(2);
                document.getElementById('stat-min').innerText = Math.min(...values).toFixed(2);
            } else {
                document.getElementById('stat-max').innerText = '--';
                document.getElementById('stat-min').innerText = '--';
            }

            // 销毁旧图表
            if (chartInstance) chartInstance.destroy();

            // 创建新图表
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '体重 (kg)',
                        data: values,
                        borderColor: '#059669', // emerald-600
                        backgroundColor: 'rgba(16, 185, 129, 0.12)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#059669',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4 // 平滑曲线
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 7,
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: { borderDash: [5, 5], color: '#f3f4f6' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // ================= 初始化 =================
        const init = () => {
            fetchLogs();
            // 绑定 Tab 切换点击事件已在 HTML onclick 中处理
            // 绑定 Toast 事件已在 HTML onclick 中处理
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeWeightHistoryModal();
                }
            });
        };

        init();

    </script>
</body>
</html>
